function trace(a){console.log(a)};var PageNodes={};
PageNodes.init=function(){this.mainLayout=new PageNodes.MainLayout("#mainLayout");this.topMenu=new PageNodes.TopMenu("#topMenu");this.propertiesPanel=new PageNodes.PropertiesPanel;this.historyPanel=new PageNodes.HistoryPanel;this.editorContainer=new PageNodes.EditorContainer($("#editorContainer"));this.toolPanel=new PageNodes.ToolPanel;this.settingWin=new PageNodes.SettingWin("#settingWin");this.editPageSizeWin=new PageNodes.EditPageSizeWin("#editPageSizeWin");this.inputWin=new PageNodes.InputWin("#inputWin");this.onlineFileWin=
new PageNodes.OnlineFileWin("#onlineFileWin");this.ToolManager.init()};$(function(){PageNodes.init();PageNodes.editorContainer.open('{"pageSize":{"width":960,"height":540},"pivot":{"x":0,"y":0},"pages":[{"title":"\u767b\u5f55","buttons":[{"x":380.00000000000006,"y":330,"width":199.99999999999997,"height":80,"label":"\u8fdb\u5165"}],"position":{"x":-234,"y":-200}},{"title":"\u4e3b\u754c\u9762","buttons":[{"x":19.99999999999997,"y":20.000000000000014,"width":99.99999999999999,"height":49.99999999999999,"label":"\u8fd4\u56de"},{"x":168,"y":389.00000000000006,"width":177,"height":58.99999999999999,"label":"A"},{"x":413,"y":389.00000000000006,"width":177,"height":58.99999999999999,"label":"B"},{"x":655,"y":389.00000000000006,"width":177,"height":58.99999999999999,"label":"C"}],"position":{"x":0,"y":0}},{"title":"\u754c\u9762A","buttons":[{"x":19.99999999999997,"y":20.000000000000014,"width":99.99999999999999,"height":49.99999999999999,"label":"\u8fd4\u56de"}],"position":{"x":337,"y":-202}},{"title":"\u754c\u9762B","buttons":[{"x":19.99999999999997,"y":20.000000000000014,"width":99.99999999999999,"height":49.99999999999999,"label":"\u8fd4\u56de"}],"position":{"x":337,"y":-52}},{"title":"\u754c\u9762C","buttons":[{"x":19.99999999999997,"y":20.000000000000014,"width":99.99999999999999,"height":49.99999999999999,"label":"\u8fd4\u56de"}],"position":{"x":337,"y":98}}],"links":[{"normalColor":"#0000ff","lineWidth":"5.00","from":{"pageIdx":0,"btnIdx":0},"to":1},{"normalColor":"#28ed74","lineWidth":2,"from":{"pageIdx":1,"btnIdx":0},"to":0},{"normalColor":"#0000ff","lineWidth":"5.00","from":{"pageIdx":1,"btnIdx":1},"to":2},{"normalColor":"#28ed74","lineWidth":2,"from":{"pageIdx":2,"btnIdx":0},"to":1},{"normalColor":"#0000ff","lineWidth":"5.00","from":{"pageIdx":1,"btnIdx":2},"to":3},{"normalColor":"#28ed74","lineWidth":2,"from":{"pageIdx":3,"btnIdx":0},"to":1},{"normalColor":"#0000ff","lineWidth":"5.00","from":{"pageIdx":1,"btnIdx":3},"to":4},{"normalColor":"#28ed74","lineWidth":2,"from":{"pageIdx":4,"btnIdx":0},"to":1}]}')});PageNodes.Test=function(){return{testRender:function(){}}}();PageNodes.Settings={pageScale:1/6,pageSize:{width:960,height:540}};PageNodes.KeyboardManager={};
PageNodes.KeyboardManager.init=function(){function a(b){return b.target instanceof HTMLTextAreaElement||b.target instanceof HTMLInputElement}$(window).keydown(function(b){if(!a(b))switch(b.keyCode){case 78:b.ctrlKey&&b.preventDefault();break;case 79:b.ctrlKey&&b.preventDefault();break;case 83:b.ctrlKey&&b.preventDefault();break;case 85:b.ctrlKey&&b.preventDefault();break;case 49:(b.ctrlKey||b.shiftKey)&&b.preventDefault();break;case 50:(b.ctrlKey||b.shiftKey)&&b.preventDefault();break;case 89:b.ctrlKey&&
b.preventDefault();break;case 90:b.ctrlKey&&b.preventDefault();break;case 65:b.ctrlKey&&b.preventDefault();break;case 68:b.ctrlKey&&b.preventDefault();break;case 73:b.ctrlKey&&b.shiftKey&&b.preventDefault()}});$(window).keyup(function(b){if(!a(b))switch(b.keyCode){case 79:b.ctrlKey&&PageNodes.KeyboardManager.execute("Ctrl+O");break;case 83:b.ctrlKey&&PageNodes.KeyboardManager.execute("Ctrl+S");break;case 90:b.ctrlKey&&PageNodes.KeyboardManager.execute("Ctrl+Z");break;case 89:b.ctrlKey&&PageNodes.KeyboardManager.execute("Ctrl+Y");
break;case 78:b.ctrlKey&&PageNodes.KeyboardManager.execute("Ctrl+N");break;case 46:PageNodes.KeyboardManager.execute("Delete");break;case 67:b.ctrlKey&&PageNodes.KeyboardManager.execute("Ctrl+C");break;case 86:b.ctrlKey&&PageNodes.KeyboardManager.execute("Ctrl+V");break;case 88:b.ctrlKey&&PageNodes.KeyboardManager.execute("Ctrl+X");break;case 49:b.ctrlKey&&b.shiftKey?PageNodes.KeyboardManager.execute("Ctrl+Shift+1"):b.ctrlKey?PageNodes.KeyboardManager.execute("Ctrl+1"):b.shiftKey&&PageNodes.KeyboardManager.execute("Shift+1");
break;case 50:b.ctrlKey&&b.shiftKey?PageNodes.KeyboardManager.execute("Ctrl+Shift+2"):b.ctrlKey?PageNodes.KeyboardManager.execute("Ctrl+2"):b.shiftKey&&PageNodes.KeyboardManager.execute("Shift+2");break;case 51:b.shiftKey&&PageNodes.KeyboardManager.execute("Shift+3");break;case 52:b.shiftKey&&PageNodes.KeyboardManager.execute("Shift+4");break;case 53:b.shiftKey&&PageNodes.KeyboardManager.execute("Shift+5");break;case 85:b.ctrlKey&&PageNodes.KeyboardManager.execute("Ctrl+U");break;case 65:b.ctrlKey&&
PageNodes.KeyboardManager.execute("Ctrl+A");break;case 68:b.ctrlKey&&PageNodes.KeyboardManager.execute("Ctrl+D");break;case 73:b.ctrlKey&&b.shiftKey&&PageNodes.KeyboardManager.execute("Ctrl+Shift+I")}});$(window).mousewheel(function(b){if(b.ctrlKey){b.preventDefault();var a=PageNodes.editorContainer,d=b.clientX-a.container.offset().left,a=b.clientY-a.container.offset().top,d=new PIXI.Point(d,a);PageNodes.editorContainer.zoom({delta:b.deltaY,point:d})}})};
PageNodes.KeyboardManager.execute=function(a){switch(a){case "Ctrl+O":PageNodes.File.openFile();break;case "onlineFile":PageNodes.onlineFileWin.show();break;case "Ctrl+S":PageNodes.File.saveFile();break;case "export":PageNodes.File.exportImage();break;case "Ctrl+Z":PageNodes.HistoryManager.undo();break;case "Ctrl+Y":PageNodes.HistoryManager.redo();break;case "Delete":PageNodes.GeneralManager.addDeleteAction();break;case "Ctrl+M":PageNodes.editPageSizeWin.show();break;case "Ctrl+N":PageNodes.GeneralManager.newPage();
break;case "Ctrl+C":PageNodes.Clipboard.copy();break;case "Ctrl+V":PageNodes.Clipboard.paste();break;case "Ctrl+X":PageNodes.Clipboard.cut();break;case "Shift+1":PageNodes.GeneralManager.switchToolIdx(0);break;case "Shift+2":PageNodes.GeneralManager.switchToolIdx(1);break;case "Shift+3":PageNodes.GeneralManager.switchToolIdx(2);break;case "Shift+4":PageNodes.GeneralManager.switchToolIdx(3);break;case "Shift+5":PageNodes.GeneralManager.switchToolIdx(4);break;case "Ctrl+U":PageNodes.settingWin.show(0);
break;case "showQuickKey":PageNodes.settingWin.show(1);break;case "Ctrl+A":PageNodes.GeneralManager.addSelectAllAction();break;case "selectAllPages":PageNodes.GeneralManager.addSelectAllPagesAction();break;case "selectAllLinks":PageNodes.GeneralManager.addSelectAllLinksAction();break;case "Ctrl+Shift+I":PageNodes.GeneralManager.addInvertSelectAction();break;case "Ctrl+D":PageNodes.GeneralManager.addCancelSelectAction();break;case "Ctrl+1":PageNodes.topMenu.panelMenuController.selectValue("properties");
break;case "Ctrl+2":PageNodes.topMenu.panelMenuController.selectValue("history");break;case "Ctrl+Shift+1":PageNodes.mainLayout.toggleLeft();break;case "Ctrl+Shift+2":PageNodes.mainLayout.toggleRight();break;case "about":PageNodes.settingWin.show(2)}};$(function(){PageNodes.KeyboardManager.init()});PageNodes.HistoryManager={};PageNodes.HistoryManager.UPDATE="historyManagerUpdate";PageNodes.HistoryManager.maxLen=50;PageNodes.HistoryManager.items=[];PageNodes.HistoryManager.idx=-1;PageNodes.HistoryManager.add=function(a,b,c){for(;this.items.length-1>this.idx;)this.items.pop();a=new PageNodes.HistoryItem(a,b,c);this.items.push(a);this.items.length>this.maxLen&&this.items.shift();a.redo();this.idx=this.items.length-1;$(document).trigger(PageNodes.HistoryManager.UPDATE)};
PageNodes.HistoryManager.undo=function(){this.idx>-1&&(this.items[this.idx].undo(),this.idx--,$(document).trigger(PageNodes.HistoryManager.UPDATE))};PageNodes.HistoryManager.redo=function(){this.idx<this.items.length-1&&(this.idx++,this.items[this.idx].redo(),$(document).trigger(PageNodes.HistoryManager.UPDATE))};PageNodes.HistoryManager.removeAll=function(){for(;this.items.length>0;)this.items.pop();this.idx=-1;$(document).trigger(PageNodes.HistoryManager.UPDATE)};
PageNodes.HistoryManager.go=function(a){for(a=this.items.indexOf(a);this.idx!=a;)a<this.idx?(this.items[this.idx].undo(),this.idx--):(this.idx++,this.items[this.idx].redo());$(document).trigger(PageNodes.HistoryManager.UPDATE)};PageNodes.HistoryItem=function(a,b,c){this.type=a;this.undo=b;this.redo=c};PageNodes.HistoryManager.addEditAction=function(a,b,c,d){this.add(a,function(){d(b)},function(){d(c)})};PageNodes.GeneralManager=function(){var a={switchToolIdx:function(b){var a=PageNodes.ToolManager.getSelectedIdx();PageNodes.HistoryManager.addEditAction("switchTool",a,b,function(b){PageNodes.toolPanel.selectIdx(b);PageNodes.ToolManager.selectToolIdx(b)})},addSelectAction:function(b,a){PageNodes.ArrayUtil.equals(b.pages,a.pages)&&PageNodes.ArrayUtil.equals(b.links,a.links)?(PageNodes.editorContainer.selectPages(a.pages),PageNodes.editorContainer.selectLinks(a.links),PageNodes.propertiesPanel.update()):
PageNodes.HistoryManager.addEditAction(a.pages.length>0||a.links.length>0?"select":"unselect",b,a,function(a){PageNodes.editorContainer.selectPages(a.pages);PageNodes.editorContainer.selectLinks(a.links);PageNodes.propertiesPanel.update()})},addSelectButtonAction:function(a,c){PageNodes.ArrayUtil.equals(a,c)?(PageNodes.editorContainer.selectButtons(c),PageNodes.propertiesPanel.update()):PageNodes.HistoryManager.addEditAction(c.length>0?"select":"unselect",a,c,function(a){PageNodes.editorContainer.selectButtons(a);
PageNodes.propertiesPanel.update()})}};a.addSelectAllAction=function(){function b(){var b=PageNodes.editorContainer.getPages(),c=PageNodes.editorContainer.getLinks(),f=PageNodes.editorContainer.getSelectedPages(),g=PageNodes.editorContainer.getSelectedLinks(),f={pages:f.concat(),links:g.concat()},b={pages:b.concat(),links:c.concat()};a.addSelectAction(f,b)}function c(){var b=PageNodes.editorContainer.getSelectedButtons().concat(),c=PageNodes.editorContainer.getAllButtons();a.addSelectButtonAction(b,
c)}switch(PageNodes.ToolManager.getTools()[0].selectMode){case PageNodes.SelectMode.Global:b();break;case PageNodes.SelectMode.Page:c()}};a.addSelectAllPagesAction=function(){if(PageNodes.ToolManager.getTools()[0].selectMode==PageNodes.SelectMode.Global){var a=PageNodes.editorContainer.getPages();PageNodes.editorContainer.getLinks();var c=PageNodes.editorContainer.getSelectedPages(),d=PageNodes.editorContainer.getSelectedLinks(),c={pages:c.concat(),links:d.concat()},a={pages:a.concat(),links:d.concat()};
this.addSelectAction(c,a)}};a.addSelectAllLinksAction=function(){if(PageNodes.ToolManager.getTools()[0].selectMode==PageNodes.SelectMode.Global){PageNodes.editorContainer.getPages();var a=PageNodes.editorContainer.getLinks(),c=PageNodes.editorContainer.getSelectedPages(),d=PageNodes.editorContainer.getSelectedLinks(),d={pages:c.concat(),links:d.concat()},a={pages:c.concat(),links:a.concat()};this.addSelectAction(d,a)}};a.addInvertSelectAction=function(){function b(){var b=PageNodes.editorContainer.getPages(),
c=PageNodes.editorContainer.getLinks(),f=PageNodes.editorContainer.getSelectedPages(),g=PageNodes.editorContainer.getSelectedLinks(),b=PageNodes.ArrayUtil.invert(b,f),c=PageNodes.ArrayUtil.invert(c,g),f={pages:f.concat(),links:g.concat()};a.addSelectAction(f,{pages:b,links:c})}function c(){var b=PageNodes.editorContainer.getSelectedButtons().concat(),c=PageNodes.editorContainer.getAllButtons(),c=PageNodes.ArrayUtil.invert(c,b);a.addSelectButtonAction(b,c)}switch(PageNodes.ToolManager.getTools()[0].selectMode){case PageNodes.SelectMode.Global:b();
break;case PageNodes.SelectMode.Page:c()}};a.addCancelSelectAction=function(){function b(){PageNodes.editorContainer.getPages();PageNodes.editorContainer.getLinks();var b=PageNodes.editorContainer.getSelectedPages(),c=PageNodes.editorContainer.getSelectedLinks(),b={pages:b.concat(),links:c.concat()};a.addSelectAction(b,{pages:[],links:[]})}function c(){var b=PageNodes.editorContainer.getSelectedButtons().concat();a.addSelectButtonAction(b,[])}switch(PageNodes.ToolManager.getTools()[0].selectMode){case PageNodes.SelectMode.Global:b();
break;case PageNodes.SelectMode.Page:c()}};a.addMoveAction=function(a,c,d){PageNodes.HistoryManager.addEditAction("move",c,d,function(c){$.each(a,function(a){var b=c[a].y;this.content.x=c[a].x;this.content.y=b;PageNodes.editorContainer.update(this)})})};a.addMoveButtonAction=function(a,c,d){PageNodes.HistoryManager.addEditAction("move",c,d,function(c){$.each(a,function(a){var b=c[a].y;this.content.x=c[a].x;this.content.y=b;PageNodes.editorContainer.update(this.page)})})};a.switchLinks=function(a,
c){PageNodes.HistoryManager.add("switchLinks",function(){PageNodes.editorContainer.removeLink(c);PageNodes.editorContainer.addLink(a)},function(){PageNodes.editorContainer.removeLink(a);PageNodes.editorContainer.addLink(c)})};a.addLink=function(a){PageNodes.HistoryManager.add("addLink",function(){PageNodes.editorContainer.removeLink(a)},function(){PageNodes.editorContainer.addLink(a)})};a.addPage=function(a){PageNodes.HistoryManager.add("addPage",function(){PageNodes.editorContainer.remove(a)},function(){PageNodes.editorContainer.add(a)})};
a.addButtonToPage=function(a,c){PageNodes.HistoryManager.add("addButton",function(){c.remove(a)},function(){c.add(a)})};a.addDeleteAction=function(){var a=PageNodes.editorContainer,c=a.getSelectedPages().concat(),d=a.getSelectedLinks().concat(),e=a.getSelectedButtons().concat(),f=c.concat(),g=d.concat(),h=[];$.each(e,function(){h.push({page:this.page,btn:this,undo:function(){a.addButton(this.btn,this.page)},redo:function(){a.removeButton(this.btn)}})});$.each(c,function(){var c=a.findLinkWithPage(this);
g=g.concat(c)});$.each(e,function(){var c=a.findLinkFrom({page:this.page,btn:this});c!=void 0&&(g=g.concat([c]))});g=PageNodes.ArrayUtil.filterRepeat(g);PageNodes.HistoryManager.add("del",function(){$.each(f,function(){a.add(this)});$.each(g,function(){a.addLink(this)});$.each(h,function(){this.undo()});a.selectPages(c.concat());a.selectLinks(d.concat());a.selectButtons(e.concat());PageNodes.propertiesPanel.update()},function(){$.each(f,function(){a.remove(this)});$.each(g,function(){a.removeLink(this)});
$.each(h,function(){this.redo()});a.selectPages([]);a.selectLinks([]);a.selectButtons([]);PageNodes.propertiesPanel.update()})};a.newPage=function(){var a=PageNodes.editorContainer.layerContainer,c=new PageNodes.Page({title:"\u672a\u547d\u540d"});c.content.x=-a.x;c.content.y=-a.y;this.addPage(c)};a.changePageSizeTo=function(a){var c=JSON.parse(JSON.stringify(PageNodes.Settings.pageSize));PageNodes.HistoryManager.addEditAction("edit",c,a,function(a){var b=PageNodes.editorContainer.getPages().concat();
$.each(b,function(){this.setSize(a.width,a.height)});PageNodes.Settings.pageSize=a})};return a}();PageNodes.Clipboard={};PageNodes.Clipboard.targets=[];PageNodes.Clipboard.isCut=!1;
PageNodes.Clipboard.copy=function(){var a=PageNodes.editorContainer.getSelectedPages(),b=PageNodes.editorContainer.getSelectedLinks(),c=PageNodes.editorContainer.getSelectedButtons(),d=a.concat(b).concat(c);if(!PageNodes.ArrayUtil.equals(d,this.targets)&&d.length>0){var e=this.targets.concat(),f=this.isCut;PageNodes.HistoryManager.add("copy",function(){PageNodes.Clipboard.targets=e;PageNodes.Clipboard.isCut=f},function(){PageNodes.Clipboard.targets=d;PageNodes.Clipboard.isCut=!1})}};
PageNodes.Clipboard.cut=function(){var a=PageNodes.editorContainer,b=a.getSelectedPages().concat(),c=a.getSelectedLinks().concat(),d=a.getSelectedButtons().concat();if(b.length>0||c.length>0||d.length>0){var e=this.targets.concat(),f=this.isCut,g=b.concat(),h=c.concat(),i=d.concat(),j=[];$.each(i,function(){j.push({page:this.page,btn:this,undo:function(){a.addButton(this.btn,this.page)},redo:function(){a.removeButton(this.btn)}})});$.each(b,function(){var b=a.findLinkWithPage(this);h=h.concat(b)});
$.each(d,function(){var b=a.findLinkFrom({page:this.page,btn:this});b!=void 0&&(h=h.concat([b]))});h=PageNodes.ArrayUtil.filterRepeat(h);PageNodes.HistoryManager.add("cut",function(){$.each(g,function(){a.add(this)});$.each(h,function(){a.addLink(this)});$.each(j,function(){this.undo()});a.selectPages(b.concat());a.selectLinks(c.concat());a.selectButtons(d.concat());PageNodes.propertiesPanel.update();PageNodes.Clipboard.targets=e;PageNodes.Clipboard.isCut=f},function(){$.each(g,function(){a.remove(this)});
$.each(h,function(){a.removeLink(this)});$.each(j,function(){this.redo()});a.selectPages([]);a.selectLinks([]);a.selectButtons([]);PageNodes.propertiesPanel.update();PageNodes.Clipboard.targets=b.concat(c).concat(j);PageNodes.Clipboard.isCut=!0})}};
PageNodes.Clipboard.paste=function(){if(this.getPasteAble()){var a=PageNodes.editorContainer,b=a.getPages(),c=a.getSelectedPages().concat(),d=a.getSelectedLinks().concat(),e=a.getSelectedButtons().concat();if(this.targets.length>0&&this.isCut){var f=PageNodes.Clipboard.targets.concat(),g,h,i;PageNodes.HistoryManager.add("paste",function(){$.each(g,function(){a.remove(this)});$.each(h,function(){a.removeLink(this)});$.each(i,function(){this.redo()});a.selectPages(c.concat());a.selectLinks(d.concat());
a.selectButtons(e.concat());PageNodes.propertiesPanel.update();PageNodes.Clipboard.targets=f;PageNodes.Clipboard.isCut=!0},function(){g=[];h=[];i=[];$.each(f,function(){var c=this instanceof PageNodes.NodeLink;this instanceof PageNodes.Page?(a.add(this),g.push(this)):c?b.indexOf(this.from.page)>-1&&b.indexOf(this.to)>-1&&(a.addLink(this),h.push(this)):this.undo!=void 0&&(this.undo(),i.push(this))});a.selectPages(g.concat());a.selectLinks(h.concat());a.selectButtons(function(){var a=[];$.each(i,function(){a.push(this.btn)});
return a}());PageNodes.propertiesPanel.update();PageNodes.Clipboard.targets=[];PageNodes.Clipboard.isCut=!1})}else if(this.targets.length>0&&!this.isCut){var j=[];PageNodes.HistoryManager.add("paste",function(){$.each(j,function(){this instanceof PageNodes.Page?a.remove(this):this instanceof PageNodes.Button&&a.removeButton(this)});a.selectPages(c.concat());a.selectLinks(d.concat());a.selectButtons(e.concat());PageNodes.propertiesPanel.update()},function(){j.length==0&&$.each(PageNodes.Clipboard.targets,
function(){if(!(this instanceof PageNodes.NodeLink)){var a=this.clone();if(this instanceof PageNodes.Button)a.page=this.page;j.push(a)}});$.each(j,function(){this instanceof PageNodes.Page?a.add(this):this instanceof PageNodes.Button&&a.addButton(this,this.page)});a.selectPages(function(){var a=[];$.each(j,function(){this instanceof PageNodes.Page&&a.push(this)});return a}());a.selectLinks([]);a.selectButtons(function(){var a=[];$.each(j,function(){this instanceof PageNodes.Button&&a.push(this)});
return a}());PageNodes.propertiesPanel.update()})}}};
PageNodes.Clipboard.getPasteAble=function(){function a(a){var b=!0;$.each(a,function(){this instanceof PageNodes.Page||this instanceof PageNodes.NodeLink||(b=!1)});return b}function b(a){var b=!0;$.each(a,function(){!(this instanceof PageNodes.Button)&&this.undo==void 0&&(b=!1)});return b}switch(PageNodes.ToolManager.getTools()[0].selectMode){case PageNodes.SelectMode.Global:return this.targets.length>0&&a(this.targets);case PageNodes.SelectMode.Page:return this.targets.length>0&&b(this.targets)}};PageNodes.File={openFile:function(){var a=this;this.browser(function(b){b.name.split(".").indexOf("pagenodes")!==1?PageNodes.Alert.show("\u6587\u4ef6\u683c\u5f0f\u4e0d\u5bf9!"):a.readText(b,function(a){PageNodes.editorContainer.open(a)})})},saveFile:function(){function a(a){var d=PageNodes.editorContainer,e=d.getPages(),f=d.getLinks(),g={pageSize:JSON.parse(JSON.stringify(PageNodes.Settings.pageSize)),pivot:{x:d.layerContainer.x,y:d.layerContainer.y},pages:[],links:[]};$.each(e,function(){g.pages.push(this.getDesc())});
$.each(f,function(){var a={};a.normalColor=this.descriptor.getNormalColor();a.lineWidth=this.lineWidth;a.from={pageIdx:e.indexOf(this.from.page),btnIdx:this.from.page.buttons.indexOf(this.from.btn)};a.to=e.indexOf(this.to);g.links.push(a)});d=JSON.stringify(g);b.saveText(d,a+".pagenodes")}var b=this;PageNodes.inputWin.show({icon:"save icon",title:"\u4fdd\u5b58\u6587\u4ef6",placeholder:"\u8f93\u5165\u6587\u4ef6\u540d\u79f0",rightlabel:".pagenodes",value:"pagenodes-"+(new Date).getTime(),submitLabel:"\u4fdd\u5b58",
onSubmit:function(b){a(b)}})},exportImage:function(){var a=this;PageNodes.inputWin.show({icon:"file image outline icon",title:"\u5bfc\u51fa\u56fe\u7247",placeholder:"\u8f93\u5165\u56fe\u7247\u540d\u79f0",rightlabel:".png",value:"export-"+(new Date).getTime(),submitLabel:"\u5bfc\u51fa",onSubmit:function(b){var c=PageNodes.editorContainer.layerContainer,d=PageNodes.editorContainer.contentLayer.getBounds(),e=PageNodes.editorContainer.labelLayer.getBounds(),d=PageNodes.RectUtil.merge(d,e),d=new PIXI.autoDetectRenderer(d.width+
100,d.height+100);d.backgroundColor=16777215;c=c.generateTexture(d,1,PIXI.SCALE_MODES.DEFAULT);c=new PIXI.Sprite(c);c.x=50;c.y=50;d.render(c);c=$(d.view);c.get(0).getContext("2d");c=c.get(0).toDataURL("png");c=c.replace("image/png","image/octet-stream");a.saveData(c,b+".png")}})},saveData:function(a,b){var c=$("<a>");c.attr("href",a);c.attr("download",b);c.get(0).click()},saveText:function(a,b){this.saveData("data:application/octet-stream;base64,"+Base64.encode(a),b)},browser:function(a){var b=$("<input type='file'>");
b.trigger("click");b.change(function(){var c=b.get(0).files[0];a(c)})},readText:function(a,b){$("#loadingMask").dimmer({closable:!1});$("#loadingMask").find(".ui.text.loader").text("\u6587\u4ef6\u8bfb\u53d6\u4e2d...");$("#loadingMask").dimmer("show");var c=new FileReader;c.onload=function(){$("#loadingMask").dimmer("hide");b(c.result)};c.readAsText(a)}};PageNodes.MainLayout=function(a){function b(){c.outerWidth(j);e.outerWidth(k);var a=$(window).width()-j-k-f.outerWidth()-g.outerWidth();d.outerWidth(a);var b=$(window).height()-$("#topMenu").outerHeight();c.outerHeight(b);e.outerHeight(b);d.outerHeight(b);d.css("left",j+f.outerWidth());e.css("left",j+a+f.outerWidth()+g.outerWidth());f.outerHeight(b);g.outerHeight(b);f.css("left",j);g.css("left",j+a+f.outerWidth());$(document).trigger(PageNodes.MainLayout.Event.RESIZE);a=b-q-10;l.outerHeight(a-p.outerHeight());
m.outerHeight(a)}this.view=$(a);var c=this.view.find("#leftBox"),d=this.view.find("#centerBox"),e=this.view.find("#rightBox"),a=this.view.find(".vDivide"),f=a.eq(0),g=a.eq(1),h=f.find(".handle"),i=g.find(".handle"),j=51,k=320;h.click(function(){j=j==51?0:51;b()});i.click(function(){k=k==320?0:320;b()});c.css("position","absolute");d.css("position","absolute");e.css("position","absolute");this.view.find(".menu.tabular .item").tab();var l=this.view.find("#propertiesPanel .segment");l.css("overflow",
"auto");var p=this.view.find("#propertiesPanel #header"),m=this.view.find("#historyPanel .segment");m.css("padding",5);m.css("overflow","auto");var q=this.view.find(".menu.tabular").outerHeight();$(window).resize(b);b();this.toggleLeft=function(){h.trigger("click")};this.toggleRight=function(){i.trigger("click")}};PageNodes.MainLayout.Event={RESIZE:"mainLayoutResizeEvent"};PageNodes.TopMenu=function(a){function b(){$.each(e,function(){this.update()})}function c(a){function b(){if(d!="")PageNodes.KeyboardManager.execute(d);else switch(c){case "\u5728\u7ebf\u6587\u4ef6":PageNodes.KeyboardManager.execute("onlineFile");break;case "\u5bfc\u51fa\u56fe\u7247":PageNodes.KeyboardManager.execute("export");break;case "\u952e\u76d8\u5feb\u6377\u952e":PageNodes.KeyboardManager.execute("showQuickKey");break;case "\u6240\u6709\u9875\u9762":PageNodes.KeyboardManager.execute("selectAllPages");
break;case "\u6240\u6709\u94fe\u63a5":PageNodes.KeyboardManager.execute("selectAllLinks");break;case "\u5173\u4e8ePageNodes":PageNodes.KeyboardManager.execute("about")}}var c=a.find("span.text").eq(0).text();a.find(".item").length==0&&a.click(b);var d=a.find("span.description").text();this.update=function(){var a=!0;switch(c){case "\u64a4\u6d88":a=PageNodes.historyPanel.getUndoAble();break;case "\u91cd\u505a":a=PageNodes.historyPanel.getRedoAble();break;case "\u5220\u9664":a=PageNodes.editorContainer.getSelectedPages().length>
0||PageNodes.editorContainer.getSelectedLinks().length>0||PageNodes.editorContainer.getSelectedButtons().length>0;break;case "\u590d\u5236":a=PageNodes.editorContainer.getSelectedPages().length>0||PageNodes.editorContainer.getSelectedLinks().length>0||PageNodes.editorContainer.getSelectedButtons().length>0;break;case "\u526a\u5207":a=PageNodes.editorContainer.getSelectedPages().length>0||PageNodes.editorContainer.getSelectedLinks().length>0||PageNodes.editorContainer.getSelectedButtons().length>0;
break;case "\u7c98\u8d34":a=PageNodes.Clipboard.getPasteAble();break;case "\u9009\u62e9\u5de5\u5177":a=PageNodes.ToolManager.getSelectedIdx()!=0;break;case "\u62d6\u52a8\u5de5\u5177":a=PageNodes.ToolManager.getSelectedIdx()!=1;break;case "\u9875\u9762\u5de5\u5177":a=PageNodes.ToolManager.getSelectedIdx()!=2;break;case "\u6309\u94ae\u5de5\u5177":a=PageNodes.ToolManager.getSelectedIdx()!=3;break;case "\u653e\u5927\u955c":a=PageNodes.ToolManager.getSelectedIdx()!=4;break;case "\u5168\u90e8":var b=PageNodes.ToolManager.getTools()[0].selectMode;
switch(b){case PageNodes.SelectMode.Global:var d=PageNodes.editorContainer.getPages(),a=PageNodes.editorContainer.getSelectedPages(),e=PageNodes.editorContainer.getLinks(),f=PageNodes.editorContainer.getSelectedLinks(),a=d.length>0&&(a.length<d.length||f.length<e.length);break;case PageNodes.SelectMode.Page:a=PageNodes.editorContainer.getAllButtons(),b=PageNodes.editorContainer.getSelectedButtons(),a=a.length>0&&b.length<a.length}break;case "\u6240\u6709\u9875\u9762":b=PageNodes.ToolManager.getTools()[0].selectMode;
d=PageNodes.editorContainer.getPages();a=PageNodes.editorContainer.getSelectedPages();a=b==PageNodes.SelectMode.Global&&d.length>0&&a.length<d.length;break;case "\u6240\u6709\u94fe\u63a5":b=PageNodes.ToolManager.getTools()[0].selectMode;e=PageNodes.editorContainer.getLinks();f=PageNodes.editorContainer.getSelectedLinks();a=b==PageNodes.SelectMode.Global&&e.length>0&&f.length<e.length;break;case "\u53cd\u9009":b=PageNodes.ToolManager.getTools()[0].selectMode;switch(b){case PageNodes.SelectMode.Global:d=
PageNodes.editorContainer.getPages();a=d.length>0;break;case PageNodes.SelectMode.Page:a=PageNodes.editorContainer.getAllButtons(),a=a.length>0}break;case "\u53d6\u6d88\u9009\u62e9":a=PageNodes.editorContainer.getSelectedPages();f=PageNodes.editorContainer.getSelectedLinks();b=PageNodes.editorContainer.getSelectedButtons();a=a.length>0||f.length>0||b.length>0;break;case "\u5c5e\u6027\u9762\u677f":a=PageNodes.topMenu.panelMenuController.getSelectedValue()!="properties";break;case "\u5386\u53f2\u8bb0\u5f55":a=
PageNodes.topMenu.panelMenuController.getSelectedValue()!="history"}this.setEnabled(a)};this.setEnabled=function(b){b?a.removeClass("disabled"):a.addClass("disabled")}}this.view=$(a);a=this.view.find(".ui.dropdown:not(.right.menu .ui.dropdown)");a.dropdown({on:"hover",onShow:function(){b()}});var d=a.find(".item"),e=[];d.each(function(){e.push(new c($(this)))});this.zoomMenuController=new function(a){var b=[0.06,0.12,0.25,0.5,0.66,1,2,3,4,8,16,32,64];$.each(b,function(c){$('<a class="item" data-value="'+
c+'">'+b[c]*100+"%</a>").appendTo(a.find(".menu").eq(0))});a.dropdown({onChange:function(a){PageNodes.editorContainer.zoomToLevel(Number(a))}});this.selectValue=function(c){a.dropdown("set text",b[c]*100+"%")};this.selectValue(5)}(this.view.find(".right.menu .ui.dropdown").eq(0));this.panelMenuController=new function(a){var b,c={properties:$("#propertiesPanel"),history:$("#historyPanel")};$.each(c,function(){$(this).css("display","none")});this.selectValue=function(b){a.dropdown("set selected",b)};
this.getSelectedValue=function(){return b};this.getMenu=function(){return a};a.dropdown({onChange:function(a){b!=void 0&&c[b].css("display","none");b=a;c[b].css("display","block")}});this.selectValue("properties")}(this.view.find(".right.menu .ui.dropdown").eq(1));this.getItems=function(){return d}};PageNodes.PropertiesPanel=function(){this.view=$("#propertiesPanel");this.header=this.view.find("#header");this.form=this.view.find(".ui.form");this.layoutPanel=this.view.find("#layoutPanel");this.setTargets=function(a){this.clear();a.length==1?(this.multipleSelectDescriptor=void 0,a[0].descriptor.init(this)):(this.multipleSelectDescriptor=new PageNodes.MultipleSelectDescriptor(a),this.multipleSelectDescriptor.init(this))};this.update=function(){var a=PageNodes.ToolManager.getSelectedIdx();if(a==
0){var b=PageNodes.editorContainer,c=b.getSelectedPages(),d=b.getSelectedLinks(),b=b.getSelectedButtons();c.length==0&&d.length==0&&b.length==0?(c=PageNodes.ToolManager.getTools()[a],this.setTargets([c])):(a=[],a=a.concat(c),a=a.concat(d),a=a.concat(b),this.setTargets(a))}else c=PageNodes.ToolManager.getTools()[a],this.setTargets([c])};this.clear=function(){this.view.find(".ui.dropdown").dropdown("hide");this.header.text("");this.form.empty();this.layoutPanel.empty()}};PageNodes.HistoryPanel=function(){function a(){var a=PageNodes.HistoryManager.items.length,b=PageNodes.HistoryManager.idx;a==0?(d.addClass("disabled"),e.addClass("disabled"),f.addClass("disabled")):(f.removeClass("disabled"),b==a-1?(e.addClass("disabled"),d.removeClass("disabled")):(b==-1?d.addClass("disabled"):d.removeClass("disabled"),e.removeClass("disabled")));g.empty();a=PageNodes.HistoryManager.items.length;if(a==0)g.text("\u6ca1\u6709\u4efb\u4f55\u5386\u53f2\u8bb0\u5f55");else for(var b=[],
c=PageNodes.HistoryManager.idx,k=0;k<a;k++){var l=new PageNodes.HistoryItemView(PageNodes.HistoryManager.items[k]);l.view.prependTo(g);b.push(l);k==c&&b[k].view.addClass("active")}}var b=$("#historyPanel"),c=b.find(".ui.tab.segment .menu .item"),d=c.eq(0),e=c.eq(1),f=c.eq(2),g=b.find(".ui.tab.segment .list");a();d.click(function(){PageNodes.HistoryManager.undo()});e.click(function(){PageNodes.HistoryManager.redo()});f.click(function(){PageNodes.HistoryManager.removeAll()});$(document).bind(PageNodes.HistoryManager.UPDATE,
a);this.getUndoAble=function(){return!d.hasClass("disabled")};this.getRedoAble=function(){return!e.hasClass("disabled")}};
PageNodes.HistoryItemView=function(a){var b={switchTool:{icon:"check circle icon",label:"\u5207\u6362\u4e86\u5de5\u5177"},addPage:{icon:"add circle icon",label:"\u6dfb\u52a0\u4e86\u9875\u9762"},addButton:{icon:"add circle icon",label:"\u6dfb\u52a0\u4e86\u6309\u94ae"},del:{icon:"trash icon",label:"\u5220\u9664\u4e86\u5143\u7d20"},select:{icon:"check circle icon",label:"\u9009\u62e9\u4e86\u5143\u7d20"},unselect:{icon:"circle thin icon",label:"\u53d6\u6d88\u4e86\u9009\u62e9"},move:{icon:"move icon",
label:"\u79fb\u52a8\u4e86\u5143\u7d20"},switchLinks:{icon:"edit icon",label:"\u66f4\u6539\u4e86\u94fe\u63a5"},addLink:{icon:"add circle icon",label:"\u6dfb\u52a0\u4e86\u94fe\u63a5"},edit:{icon:"edit icon",label:"\u7f16\u8f91\u4e86\u5143\u7d20"},copy:{icon:"copy icon",label:"\u590d\u5236\u4e86\u5143\u7d20"},paste:{icon:"paste icon",label:"\u7c98\u8d34\u4e86\u5143\u7d20"},cut:{icon:"cut icon",label:"\u526a\u5207\u4e86\u9875\u9762"}};this.view=$('<div class="item"></div>');this.icon=$('<i class="'+b[a.type].icon+
'"></i>');this.content=$('<div class="content"><div class="header">'+b[a.type].label+"</div></div>");this.icon.appendTo(this.view);this.content.appendTo(this.view);this.view.click(function(){PageNodes.HistoryManager.go(a)})};PageNodes.ToolPanel=function(){var a,b=$("#toolPanel").find("button");b.each(function(){$(this).click(function(){var a=b.index($(this));PageNodes.GeneralManager.switchToolIdx(a)})});this.selectIdx=function(c){c=b.eq(c);a!=void 0&&a.removeClass("basic violet active");a=c;a.addClass("basic violet active")};this.selectIdx(0)};PageNodes.SettingWin=function(a){function b(a,b){this.setDisplay=function(c){a.css("display",c?"block":"none");b.css("display",c?"block":"none")}}var c=this;this.view=$(a);var d=this.view.find(".ui.menu .item"),a=this.view.find(".content").eq(0).children(),e=this.view.find(".actions").eq(0).children(),f=[new function(a,c){b.call(this,a,c);var d=this,e=a.find("input").eq(0),f=c.find("button").eq(0);this.getMaxHistory=function(){return PageNodes.HistoryManager.maxLen};this.setMaxHistory=function(a){PageNodes.HistoryManager.maxLen=
a};this.initValues=function(){e.val(this.getMaxHistory())};this.initValues();f.click(function(){d.setMaxHistory(e.val())})}(a.eq(0),e.eq(0)),new function(a,c){b.call(this,a,c);var d='<table class="ui celled table">';d+=" <thead><tr>";d+="  <th>\u5feb\u6377\u952e</th>";d+="  <th>\u8bf4\u660e</th>";d+=" </tr></thead>";d+=" <tbody>";PageNodes.topMenu.getItems().each(function(){if($(this).find(".item").length==0){var a=$(this).find("span.text").text(),b=$(this).find("span.description").text();b!=""&&
(d+="<tr><td>"+b+"</td><td>"+a+"</td></tr>")}});d+=" </tbody>";d+="</table>";$(d).appendTo(a)}(a.eq(1),e.eq(1)),new function(a,c){b.call(this,a,c);var d=this,e=$("<audio>",{src:"assets/sounds/m01.m4a",loop:!0}),f=a.find(".icon.music");f.addClass("red");f.click(function(){f.toggleClass("red");f.hasClass("red")?d.playMusic():d.stopMusic()});var g=this.setDisplay;this.setDisplay=function(a){g.call(this,a);a?this.playMusic():this.stopMusic()};this.playMusic=function(){f.hasClass("red")&&e.get(0).play()};
this.stopMusic=function(){e.get(0).pause();e.get(0).currentTime=0};var m='<div style="color:#666666;text-align: center;">'+Base64.decode("Qmxhbms=")+"</div>";m+='<div style="color:#666666;text-align: center;">'+Base64.decode("aGVyb2JsYW5rQGdtYWlsLmNvbQ==")+"</div>";$(m).appendTo(a)}(a.eq(2),e.eq(2))],g=-1;d.each(function(a){$(this).click(function(){c.selectTabIdx(a)})});this.view.modal({onHide:function(){f[2].stopMusic()}});this.show=function(a){f[0].initValues();this.selectTabIdx(a);this.view.modal("show")};
this.selectTabIdx=function(a){g>-1&&(d.eq(g).removeClass("active blue"),f[g].setDisplay(!1));d.eq(a).addClass("active blue");g=a;f[a].setDisplay(!0);this.view.modal("refresh")}};PageNodes.ButtonGroupSwitcher=function(a,b){var c=this,d=a.find("button"),e=-1,f=[];d.each(function(a,b){$(b).click(function(){if(e!=a&&(c.selectIdx(a),c.onChange!=void 0))c.onChange(c.getValue())});f.push($(b).attr("data-value"))});this.selectIdx=function(a){e>-1&&d.eq(e).removeClass("active");e=a;d.eq(a).addClass("active")};this.setValue=function(a){this.selectIdx(f.indexOf(a))};this.getValue=function(){return f[e]};b!=void 0&&this.setValue(b)};PageNodes.ColorPicker=function(a,b){var c=this;this.view=b;this.view.val(a);var d;this.view.colorPicker({animationSpeed:0,opacity:!1,renderCallback:function(a,b){if(b==!0)d=a.val();else if(b==!1){if(c.onSubmit!=void 0)c.onSubmit(d)}else if(b==void 0&&(d=a.val(),c.onChange!=void 0))c.onChange(d)}});this.setColor=function(a){this.view.val(a);this.view.css("background-color",a)}};PageNodes.Slider=function(a,b,c,d){var e=this,f=a.find(".ui.slider").get(0);noUiSlider.create(f,{start:[d],range:{min:[b],max:[c]}});var g=a.find("input").get(0);f.noUiSlider.on("update",function(a,b){var c=a[b];g.value=c;if(e.onUpdate!=void 0)e.onUpdate(c)});g.addEventListener("change",function(){f.noUiSlider.set(this.value);if(e.onChange!=void 0)e.onChange(this.value)});f.noUiSlider.on("change",function(){var a=e.getValue();if(e.onChange!=void 0)e.onChange(a)});this.getValue=function(){return f.noUiSlider.get()};
this.setValue=function(a){f.noUiSlider.set(a)}};PageNodes.EditPageSizeWin=function(a){var b=$(a),c=b.find(".content p span").eq(0),d=b.find("input").eq(0),e=b.find("input").eq(1),f=b.find(".actions button").eq(0);f.click(function(){var a=PageNodes.Settings.pageSize;if(a.width!=d.val()||a.height!=e.val())a={width:Number(d.val()),height:Number(e.val())},PageNodes.GeneralManager.changePageSizeTo(a);f.addClass("disabled");b.modal("hide")});b.find(".content .ui.segment button").click(function(){var a=$(this).data("width"),b=$(this).data("height");d.val(a);
e.val(b)});this.show=function(){var a=PageNodes.Settings.pageSize;c.text(a.width+" * "+a.height);d.val(a.width);e.val(a.height);f.removeClass("disabled");b.modal("show")}};PageNodes.InputWin=function(a){var b=$(a),c=b.find(".header i").eq(0),d=b.find(".header label").eq(0),e=b.find("input").eq(0),f=b.find(".right.labeled .label").eq(0),g=b.find(".actions button").eq(0),h;g.click(function(){g.addClass("disabled");b.modal("hide");h!=void 0&&h(e.val())});this.setOption=function(a){c.attr("class",a.icon);d.text(a.title);e.attr("placeholder",a.placeholder);f.text(a.rightlabel);g.text(a.submitLabel);e.val(a.value);h=a.onSubmit};this.show=function(a){this.setOption(a);g.removeClass("disabled");
b.modal("show")}};PageNodes.Alert=function(){var a={},b=$("<div class='ui small modal'>");$("<div class='header'><i class='warning circle icon'></i><label>\u63d0\u793a</label></div>").appendTo(b);var c=$("<div class='content'>");c.appendTo(b);var d=$("<div class='actions'>");d.appendTo(b);var e=$('<button class="ui primary button">'),f=$('<button class="ui button">');e.click(function(){e.addClass("disabled");b.modal("hide");if(a.onSubmit!=void 0)a.onSubmit()});f.click(function(){f.addClass("disabled");b.modal("hide")});
a.show=function(g,h,i,j){e.removeClass("disabled");f.removeClass("disabled");e.detach();f.detach();e.text("Submit");f.text("Cancel");h!=void 0&&(e.text(h),e.appendTo(d));i!=void 0&&(f.text(i),f.appendTo(d));a.onSubmit=j;c.text(g);b.modal("show")};return a}();PageNodes.OnlineFileWin=function(a){function b(a){var b;b='<div class="ui image" style="border: solid 1px #E3E3E3;float: left;margin-left: 10px;margin-top: 10px;width:240px;height:180px;padding:1px;">';b+='<div class="ui dimmer">';b+='<div class="content">';b+='<div class="center">';b+='<h2 class="ui inverted header">'+a+"</h2>";b+='<div class="ui button">\u6253\u5f00\u6587\u4ef6</div>';b+="</div>";b+="</div>";b+="</div>";b+='<div style="width:100%;height:100%;background-image:url('+("examples/"+
a+"/"+a+".png")+');background-size:contain;background-repeat:no-repeat;background-origin:content;background-position:50% 50%;"></div>';b+="</div>";this.view=$(b);this.view.dimmer({on:"hover"});var d=this.view.find(".ui.dimmer .ui.button").eq(0);d.click(function(){c.openFile(a);d.addClass("disabled")});this.reset=function(){d.removeClass("disabled")}}var c=this,d=$(a),e=d.find(".content").eq(0),f=!1,g=[];this.show=function(){f?(this.reset(),d.modal("show")):($("#loadingMask").dimmer({closable:!1}),
$("#loadingMask").find(".ui.text.loader").text("\u5217\u8868\u8bfb\u53d6\u4e2d..."),$("#loadingMask").dimmer("show"),$.getJSON("examples/list.json",function(a){$("#loadingMask").dimmer("hide");for(var c=0;c<a.length;c++){var j=new b(a[c]);j.view.prependTo(e);g.push(j)}f=!0;d.modal("show")}))};this.reset=function(){for(var a=0;a<g.length;a++)g[a].reset()};this.openFile=function(a){d.modal("hide");a="examples/"+a+"/"+a+".pagenodes";$("#loadingMask").dimmer({closable:!1});$("#loadingMask").find(".ui.text.loader").text("\u6570\u636e\u8bfb\u53d6\u4e2d...");
$("#loadingMask").dimmer("show");$.get(a,function(a){$("#loadingMask").dimmer("hide");PageNodes.editorContainer.open(a)})}};PageNodes.Dropdown=function(a,b){var c=this;this.view=PageNodes.FormViewManager.createDropdownView(a,b);this.dropdown=this.view.find(".ui.dropdown");this.fireChangeEvent=!0;this.dropdown.dropdown({onChange:function(a,b,f){if(c.onChange!=void 0&&c.fireChangeEvent)c.onChange(a,b,f)}});this.setValue=function(a){this.fireChangeEvent=!1;this.dropdown.dropdown("set selected",a.toString());this.fireChangeEvent=!0}};PageNodes.DescItemMap={};PageNodes.DescItemMap.create=function(a,b,c){return new this[a.type](a,b,c)};PageNodes.DescItemMap.checkBox=function(a,b,c){var d=PageNodes.FormViewManager.createCheckBoxView(a.label);d.appendTo(c);var b=b.getAndSetFuncForName(a.name),e=b[0],f=b[1],g=d.find(".ui.checkbox").eq(0);g.checkbox(e()?"set checked":"set unchecked");a.checkBox=g;g.checkbox({onChange:function(){var b=e(),c=g.checkbox("is checked");PageNodes.HistoryManager.addEditAction("edit",b,c,function(b){f(b);a.checkBox.checkbox(b?"set checked":"set unchecked")})}});this.view=d;this.checkBox=g};PageNodes.DescItemMap.color=function(a,b,c){var d=PageNodes.FormViewManager.createColorPickerView(a.label);d.appendTo(c);var b=b.getAndSetFuncForName(a.name),e=b[1],f=(0,b[0])(),b=new PageNodes.ColorPicker(f,d.find(".colorPicker"));a.colorPicker=b;b.onChange=function(a){e(a)};b.onSubmit=function(b){f!=b&&PageNodes.HistoryManager.addEditAction("edit",f,b,function(b){a.colorPicker.setColor(b);e(b);f=b})};this.view=d;this.colorPicker=b};PageNodes.DescItemMap.dropdown=function(a,b,c){var d=new PageNodes.Dropdown(a.label,a.data);d.view.appendTo(c);var b=b.getAndSetFuncForName(a.name),e=b[0],f=b[1];d.setValue(e());a.dropdown=d;d.onChange=function(b){var c=e();PageNodes.HistoryManager.addEditAction("edit",c,b,function(b){f(b);a.dropdown.setValue(b)})}};PageNodes.DescItemMap.header=function(a,b,c){PageNodes.FormViewManager.createHeader(a.label).appendTo(c)};PageNodes.DescItemMap.hline=function(a,b,c){PageNodes.FormViewManager.createHline().appendTo(c)};PageNodes.DescItemMap.html=function(a,b,c){$(a.html).appendTo(c)};PageNodes.DescItemMap.input=function(a,b,c){var d=a.rightLabel==void 0?PageNodes.FormViewManager.createTextInputView(a.label):PageNodes.FormViewManager.createTextInputWithRightLabelView(a.label,a.rightLabel);d.appendTo(c);var b=b.getAndSetFuncForName(a.name),e=b[0],f=b[1],g=d.find("input").eq(0);g.val(e());a.input=g;g.change(function(){var b=e(),c=g.val();PageNodes.HistoryManager.addEditAction("edit",b,c,function(b){f(b);a.input.val(b)})});this.view=d;this.input=g};PageNodes.DescItemMap.position=function(a,b,c){var d=PageNodes.FormViewManager.createPositionView();d.appendTo(c);var b=b.getAndSetFuncForName(a.name),e=b[0],f=b[1],d=d.find("input"),g=d.eq(0),h=d.eq(1),d=e();g.val(d.x);h.val(d.y);a.xInput=g;a.yInput=h;g.change(function(){var b=e(),c=e();c.x=Number(g.val());PageNodes.HistoryManager.addEditAction("edit",b,c,function(b){f(b);a.xInput.val(b.x)})});h.change(function(){var b=e(),c=e();c.y=Number(h.val());PageNodes.HistoryManager.addEditAction("edit",b,
c,function(b){f(b);a.yInput.val(b.y)})});this.update=function(){var a=e();g.val(a.x);h.val(a.y)}};PageNodes.DescItemMap.size=function(a,b,c){var d=PageNodes.FormViewManager.createSizeView();d.appendTo(c);var b=b.getAndSetFuncForName(a.name),e=b[0],f=b[1],b=d.find("input"),g=b.eq(0),h=b.eq(1),c=e();g.val(c.width);h.val(c.height);a.wInput=g;a.hInput=h;$.each([g,h],function(){this.change(function(){var b=e(),c=Number(g.val()),d=Number(h.val());PageNodes.HistoryManager.addEditAction("edit",b,{width:c,height:d},function(b){f(b);a.wInput.val(b.width);a.hInput.val(b.height)})})});this.update=function(){var a=
e();g.val(a.width);h.val(a.height)};this.view=d;this.inputs=b};PageNodes.DescItemMap.slider=function(a,b,c){var d=PageNodes.FormViewManager.createSliderView(a.label);d.appendTo(c);var c=b.getAndSetFuncForName(a.name),b=c[0],e=c[1],d=new PageNodes.Slider(d,a.min,a.max,b());a.slider=d;var f=b();d.onUpdate=function(a){e(a)};d.onChange=function(b){PageNodes.HistoryManager.addEditAction("edit",f,b,function(b){a.slider.setValue(b);e(b);f=b})}};PageNodes.DescItemMap.tabs=function(a,b,c){var d=PageNodes.FormViewManager.createButtonGroupView(a.label,a.items);d.appendTo(c);var b=b.getAndSetFuncForName(a.name),e=b[0],f=b[1],d=new PageNodes.ButtonGroupSwitcher(d,e());a.switcher=d;d.onChange=function(b){var c=e();PageNodes.HistoryManager.addEditAction("edit",c,b,function(b){f(b);a.switcher.setValue(b)})}};PageNodes.DescItemMap.textArea=function(a,b,c){var d=PageNodes.FormViewManager.createTextAreaView(a.label);d.appendTo(c);var b=b.getAndSetFuncForName(a.name),e=b[0],f=b[1],g=d.find("textarea").eq(0);g.val(e());a.textArea=g;g.change(function(){var b=e(),c=g.val();PageNodes.HistoryManager.addEditAction("edit",b,c,function(b){f(b);a.textArea.val(b)})});this.view=d;this.textArea=g};PageNodes.DescriptorDataModel=function(a){var b=this;this.delegate=a;this.items=[];this.itemControllers=[];this.add=function(a){this.items.push(a)};this.remove=function(a){a=this.items.indexOf(a);a>-1&&(this.items.splice(a,1),this.itemControllers.splice(a,1))};this.createTo=function(a){function d(e){if(e!=b.items.length){var f=b.items[e];b.isDataModel(f)?(f.createTo(a),b.itemControllers.push(f.itemControllers)):(f=PageNodes.DescItemMap.create(f,b,a),b.itemControllers.push(f));e++;d(e)}}if(this.items.length!=
0)this.itemControllers=[],d(0)};this.getAndSetFuncForName=function(a){a=PageNodes.DescriptorDataModel.getFuncName(a);return[this.delegate[a.getStr],this.delegate[a.setStr]]};this.update=function(){function a(b){for(var e=0;e<b.length;e++){var f=b[e];f instanceof Array?a(f):f.update!=void 0&&f.update()}}a(this.itemControllers)};this.isDataModel=function(a){return a.type==void 0&&a.createTo!=void 0};this.getSettings=function(){function a(e){if(e!=b.items.length){var f=b.items[e];if(b.isDataModel(f))d[f.name]=
f.getSettings();else if(f.name!=void 0){var g=b.getAndSetFuncForName(f.name)[0];d[f.name]=g()}e++;a(e)}}var d={};a(0);return d=this.encodeSettings(d)};this.setSettings=function(a){a=this.decodeSettings(a);for(key in a){var b=this.getAndSetFuncForName(key)[1];b!=void 0?a[key]!=void 0&&b(a[key]):(b=this.getSubDataModelByName(key),b!=void 0&&b.setSettings(a[key]))}};this.encodeSettings=function(a){var b={};for(key in a){var e=a[key];if(typeof e=="object")if(this.getAndSetFuncForName(key)[1]!=void 0)b[key]=
PageNodes.DescriptorDataModel.Encoder.encode(e);else{var f=this.getSubDataModelByName(key);f!=void 0&&(b[key]=f.encodeSettings(e))}else b[key]=e}return b};this.decodeSettings=function(a){var b={};for(key in a){var e=a[key];if(typeof e=="object")if(this.getAndSetFuncForName(key)[1]!=void 0)b[key]=PageNodes.DescriptorDataModel.Encoder.decode(e);else{var f=this.getSubDataModelByName(key);f!=void 0&&(b[key]=f.decodeSettings(e))}else b[key]=e}return b};this.getSubDataModelByName=function(a){for(var b=
this.items.length,e=0;e<b;e++){var f=this.items[e];if(this.isDataModel(f)&&f.name==a)return f}}};PageNodes.DescriptorDataModel.Encoder={encode:function(a){return a},decode:function(a){return a}};PageNodes.DescriptorDataModel.getFuncName=function(a){var b=a.length,a=a.charAt(0).toUpperCase()+a.substr(1,b-1);return{getStr:"get"+a,setStr:"set"+a}};PageNodes.DescriptorDataModelHandle={donothing:function(a){return a},emptyToUndefined:function(a){return a!=""?a:void 0},numberValue:function(a){return Number(a)}};
PageNodes.DescriptorDataModel.createGetterAndSetter=function(a,b,c,d,e,f,g){var h=this.getFuncName(c);a[h.getStr]=function(){f!=void 0&&(b[c]=Cesium.defaultValue(b[c],f));return(d==void 0?PageNodes.DescriptorDataModelHandle.donothing:d)(b[c])};a[h.setStr]=function(a){b[c]=(e==void 0?PageNodes.DescriptorDataModelHandle.donothing:e)(a);g!=void 0&&g()}};PageNodes.FormViewManager={};PageNodes.FormViewManager.createPositionView=function(){return $('<div class="inline fields">\t<div class="eight wide field">\t\t<label>X</label>\t\t<input type="text" placeholder="">   </div>   <div class="eight wide field">\t\t<label>Y</label>\t\t<input type="text" placeholder="">\t</div></div>')};PageNodes.FormViewManager.createSizeView=function(){return $('<div class="inline fields">\t<div class="eight wide field">\t\t<label>\u5bbd</label>\t\t<input type="text" placeholder="">   </div>   <div class="eight wide field">\t\t<label>\u9ad8</label>\t\t<input type="text" placeholder="">\t</div></div>')};
PageNodes.FormViewManager.createHline=function(){return $('<div class="ui divider"></div>')};PageNodes.FormViewManager.createCheckBoxView=function(a){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui checkbox">\t\t\t<input type="checkbox">\t\t\t<label></label>\t\t</div>\t</div></div>')};
PageNodes.FormViewManager.createDropdownView=function(a,b){for(var c=$('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui selection dropdown">\t\t\t<i class="dropdown icon"></i>\t\t\t<div class="default text"></div>\t\t\t<div class="menu">\t\t\t</div>\t\t</div>\t</div></div>'),d=c.find(".menu"),e=b.length,f=0;f<e;f++)$('<div class="item" data-value="'+b[f].value+'">'+b[f].label+"</div>").appendTo(d);return c};
PageNodes.FormViewManager.createHeader=function(a){var b=$("<div>",{style:"padding:3px;background-color:#e9e9e9;margin-bottom:10px;font-size:11px;"});b.text(a);return b};PageNodes.FormViewManager.createHeaderLabel=function(a){return $('<div class="ui small header">'+a+"</div>")};PageNodes.FormViewManager.createLayoutView=function(){return $('<div class="ui basic buttons">\t<button class="ui icon button" data-content="\u7f6e\u9876"><i class="arrow circle up icon"></i></button>\t<button class="ui icon button" data-content="\u7f6e\u5e95"><i class="arrow circle down icon"></i></button>\t<button class="ui icon button" data-content="\u4e0a\u79fb\u4e00\u5c42"><i class="arrow up icon"></i></button>\t<button class="ui icon button" data-content="\u4e0b\u79fb\u4e00\u5c42"><i class="arrow down icon"></i></button></div>')};
PageNodes.FormViewManager.createColorPickerView=function(a){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="colorPicker">\t\t\t<div class="box"></div>\t\t</div>\t</div></div>')};PageNodes.FormViewManager.createTextInputView=function(a){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<input type="text" placeholder="">\t</div></div>')};
PageNodes.FormViewManager.createTextInputWithRightLabelView=function(a,b){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui right labeled input">\t\t\t<input type="text" placeholder="">\t\t\t<div class="ui basic label">'+b+"</div>\t\t</div>\t</div></div>")};PageNodes.FormViewManager.createTextAreaView=function(a){return $('<div class="field">\t<label>'+a+'</label>\t<textarea style="margin-top: 0px; margin-bottom: 0px; height: 148px;"></textarea></div>')};
PageNodes.FormViewManager.createSliderView=function(a){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eight wide field">\t\t<div class="ui slider" style="width:95%"></div>\t</div>\t<div class="four wide field">\t\t<input type="text" placeholder="">\t</div></div>')};
PageNodes.FormViewManager.createIconButtonGroupView=function(a,b){for(var c=$('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui icon basic buttons"></div>\t</div></div>'),d=c.find(".buttons"),e=0;e<b.length;e++)$('<button class="ui button" data-value="'+b[e].value+'"><i class="'+b[e].icon+' icon"></i></button>').appendTo(d);return c};
PageNodes.FormViewManager.createButtonGroupView=function(a,b){for(var c=$('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui icon basic buttons"></div>\t</div></div>'),d=c.find(".buttons"),e=0;e<b.length;e++)$('<button class="ui button" data-value="'+b[e].value+'">'+b[e].label+"</button>").appendTo(d);return c};
PageNodes.FormViewManager.createIconView=function(a,b){var c=$('<div class="inline fields">\t<label style="position:absolute;margin-top:0px;">'+a+'</label>\t<div class="five wide field"></div>\t<div class="eleven wide"></div></div>'),d=c.find(".eleven.wide").eq(0),e=$('<div class="iconPicker">');e.innerWidth(b.width);e.innerHeight(b.height);e.appendTo(d);d=$("<canvas>");d.get(0).width=b.width;d.get(0).height=b.height;d.appendTo(e);return c};PageNodes.BasicDescriptor=function(a){this.dataModels=[a];this.init=function(a){a.header.text(this.title);var c=a.form;this.container=c;$.each(this.dataModels,function(){this.createTo(c)})};this.update=function(){this.container!=void 0&&$.each(this.dataModels,function(){this.update()})}};PageNodes.GroupDescriptor=function(a){var b=this;this.init=function(c){function d(b){var c=PageNodes.FormViewManager.createTextInputView(b.label);c.appendTo(j);var b=i(b.name),d=a.delegate[b.getStr],e=a.delegate[b.setStr],f=d().length,g=c.find("input").eq(0);g.val(PageNodes.ArrayUtil.getSameValue(d()));g.change(function(){var a=d(),b=PageNodes.ArrayUtil.repeatValue(g.val(),f);PageNodes.HistoryManager.addEditAction("edit",a,b,function(a){e(a);g.val(PageNodes.ArrayUtil.getSameValue(a))})})}function e(c){var d=
PageNodes.FormViewManager.createPositionView();d.appendTo(j);var c=i(c.name),e=a.delegate[c.getStr],f=a.delegate[c.setStr],g=e().x.length,d=d.find("input"),h=d.eq(0),o=d.eq(1);h.val(PageNodes.ArrayUtil.getSameValue(e().x));o.val(PageNodes.ArrayUtil.getSameValue(e().y));h.change(function(){var a=e(),b=e();b.x=PageNodes.ArrayUtil.repeatValue(Number(h.val()),g);PageNodes.HistoryManager.addEditAction("edit",a,b,function(a){f(a);h.val(PageNodes.ArrayUtil.getSameValue(a.x))})});o.change(function(){var a=
e(),b=e();b.y=PageNodes.ArrayUtil.repeatValue(Number(o.val()),g);PageNodes.HistoryManager.addEditAction("edit",a,b,function(a){f(a);o.val(PageNodes.ArrayUtil.getSameValue(a.y))})});b.updateItems.push({input:h,getFunc:function(){return PageNodes.ArrayUtil.getSameValue(e().x)}});b.updateItems.push({input:o,getFunc:function(){return PageNodes.ArrayUtil.getSameValue(e().y)}})}function f(c){var d=PageNodes.FormViewManager.createSizeView();d.appendTo(j);var c=i(c.name),e=a.delegate[c.getStr],f=a.delegate[c.setStr],
g=e().width.length,d=d.find("input"),h=d.eq(0),o=d.eq(1);h.val(PageNodes.ArrayUtil.getSameValue(e().width));o.val(PageNodes.ArrayUtil.getSameValue(e().height));h.change(function(){var a=e(),b=e();b.width=PageNodes.ArrayUtil.repeatValue(Number(h.val()),g);PageNodes.HistoryManager.addEditAction("edit",a,b,function(a){f(a);h.val(PageNodes.ArrayUtil.getSameValue(a.width))})});o.change(function(){var a=e(),b=e();b.height=PageNodes.ArrayUtil.repeatValue(Number(o.val()),g);PageNodes.HistoryManager.addEditAction("edit",
a,b,function(a){f(a);o.val(PageNodes.ArrayUtil.getSameValue(a.height))})});b.updateItems.push({input:h,getFunc:function(){return PageNodes.ArrayUtil.getSameValue(e().width)}});b.updateItems.push({input:o,getFunc:function(){return PageNodes.ArrayUtil.getSameValue(e().height)}})}function g(b){var c=PageNodes.FormViewManager.createColorPickerView(b.label);c.appendTo(j);var b=i(b.name),d=a.delegate[b.getStr],e=a.delegate[b.setStr],f=d().length,b=PageNodes.ArrayUtil.getSameValue(d()),g=new PageNodes.ColorPicker(b,
c.find(".colorPicker"));g.onSubmit=function(a){var b=d(),a=PageNodes.ArrayUtil.repeatValue(a,f);b!=a&&PageNodes.HistoryManager.addEditAction("edit",b,a,function(a){g.setColor(PageNodes.ArrayUtil.getSameValue(a));e(a)})}}function h(b){var c=PageNodes.FormViewManager.createSliderView(b.label);c.appendTo(j);var d=i(b.name),e=a.delegate[d.getStr],f=a.delegate[d.setStr],g=e().length,d=PageNodes.ArrayUtil.getSameValue(e()),h=new PageNodes.Slider(c,b.min,b.max,d);h.onChange=function(a){var b=e(),a=PageNodes.ArrayUtil.repeatValue(a,
g);PageNodes.HistoryManager.addEditAction("edit",b,a,function(a){h.setValue(PageNodes.ArrayUtil.getSameValue(a));f(a)})}}function i(a){var b=a.length,a=a.charAt(0).toUpperCase()+a.substr(1,b-1);return{getStr:"get"+a,setStr:"set"+a}}c.header.text(this.title);var j=c.form;this.container=j;this.updateItems=[];$.each(a.items,function(){switch(this.type){case "input":d(this);break;case "position":e(this);break;case "size":f(this);break;case "hline":PageNodes.FormViewManager.createHline().appendTo(j);break;
case "color":g(this);break;case "slider":h(this);break;case "html":$(this.html).appendTo(j)}})};this.update=function(){this.container!=void 0&&$.each(this.updateItems,function(){this.input.val(this.getFunc())})}};PageNodes.SelectToolDescriptor=function(a){this.title="\u9009\u62e9\u5de5\u5177";var b=new PageNodes.DescriptorDataModel(this);b.add({label:"\u9009\u62e9\u6a21\u5f0f",type:"tabs",items:[{label:"\u5168\u5c40",value:"globalMode"},{label:"\u9875\u9762",value:"pageMode"}],name:"selectMode"});PageNodes.BasicDescriptor.call(this,b);this.getSelectMode=function(){return a.selectMode};this.setSelectMode=function(b){a.selectMode=b}};PageNodes.DragToolDescriptor=function(){this.title="\u62d6\u52a8\u5de5\u5177";this.init=function(a){a.header.text(this.title);$("<div>\u5f53\u9009\u62e9\u5176\u5b83\u5de5\u5177\u65f6\uff0c\u6309\u4f4f<b>[Space]</b>\u952e\u53ef\u5207\u6362\u5230\u6b64\u5de5\u5177,\u677e\u5f00<b>[Space]</b>\u952e\u8fd4\u56de\u539f\u6765\u5de5\u5177.</div>").appendTo(a.form)}};PageNodes.PageToolDescriptor=function(){this.title="\u9875\u9762\u5de5\u5177";var a=new PageNodes.DescriptorDataModel(this);a.add({type:"html",html:"<div>\u70b9\u51fb\u521b\u5efa\u9875\u9762.</div>"});a.add({type:"hline"});var b=PageNodes.Settings.pageSize;a.add({type:"html",html:"<div>\u5f53\u524d\u9875\u9762\u5927\u5c0f : <b>"+b.width+"*"+b.height+"</b><div>"});PageNodes.BasicDescriptor.call(this,a)};PageNodes.ButtonToolDescriptor=function(){this.title="\u6309\u94ae\u5de5\u5177";this.init=function(a){a.header.text(this.title);$("<div>\u5728\u9875\u9762\u4e0a\u62d6\u52a8\u51fa\u77e9\u5f62\u6846\u521b\u5efa\u6309\u94ae.</div>").appendTo(a.form)}};PageNodes.ZoomToolDescriptor=function(){this.title="\u7f29\u653e\u5de5\u5177";this.init=function(a){a.header.text(this.title);$("<div>\u4efb\u610f\u5de5\u5177\u65f6,\u6309\u4f4f<b>[Ctrl]</b>\u952e\u7528\u6eda\u8f6e\u53ef\u7f29\u653e.\u9009\u4e2d\u6b64\u5de5\u5177\u65f6,\u6309\u4f4f<b>[Ctrl]</b>\u952e\u8fdb\u5165<b>\u7f29\u5c0f\u6a21\u5f0f</b>,\u677e\u5f00<b>[Ctrl]</b>\u952e\u8fd4\u56de<b>\u653e\u5927\u6a21\u5f0f</b>.</div>").appendTo(a.form)}};PageNodes.PageDescriptor=function(a){this.title="\u9875\u9762";var b=new PageNodes.DescriptorDataModel(this);b.add({type:"position",name:"position"});b.add({type:"hline"});b.add({label:"\u6807\u9898",name:"title",type:"input"});PageNodes.BasicDescriptor.call(this,b);this.getTitle=function(){return a.getTitle()};this.setTitle=function(b){a.setTitle(b)};this.getPosition=function(){return{x:a.content.x,y:a.content.y}};this.setPosition=function(b){a.content.x=b.x;a.content.y=b.y;PageNodes.editorContainer.update(a)}};PageNodes.ButtonDescriptor=function(a){this.title="\u6309\u94ae";var b=new PageNodes.DescriptorDataModel(this);b.add({type:"position",name:"position"});b.add({type:"size",name:"size"});b.add({type:"hline"});b.add({label:"\u6587\u672c",name:"label",type:"input"});PageNodes.BasicDescriptor.call(this,b);this.getLabel=function(){return a.getLabel()};this.setLabel=function(b){a.setLabel(b)};this.getPosition=function(){return{x:a.content.x,y:a.content.y}};this.setPosition=function(b){a.content.x=b.x;a.content.y=
b.y;PageNodes.editorContainer.update(a.page)};this.getSize=function(){return{width:a.content.width,height:a.content.height}};this.setSize=function(b){a.content.width=b.width;a.content.height=b.height;PageNodes.editorContainer.update(a.page)}};PageNodes.LinkDescriptor=function(a){this.title="\u94fe\u63a5";var b=new PageNodes.DescriptorDataModel(this);b.add({type:"color",name:"normalColor",label:"\u8fde\u7ebf\u989c\u8272"});b.add({type:"slider",name:"lineWidth",min:1,max:10,label:"\u8fde\u7ebf\u5bbd\u5ea6"});PageNodes.BasicDescriptor.call(this,b);this.getNormalColor=function(){for(var b=a.normalColor.toString(16);b.length<6;)b="0"+b;return"#"+b};this.setNormalColor=function(b){b=b.substr(1,b.length);a.normalColor=eval("0x"+b);a.update()};
this.getLineWidth=function(){return a.lineWidth};this.setLineWidth=function(b){a.lineWidth=b;a.lineStyle.width=a.lineWidth;a.update()}};PageNodes.MultipleSelectDescriptor=function(a){function b(b){var c=[];$.each(a,function(){c.push(b(this))});return c}function c(b){$.each(a,function(){b(this)})}var d=!0,e=!0,f=!0;$.each(a,function(){this instanceof PageNodes.Page?f=e=!1:this instanceof PageNodes.NodeLink?f=d=!1:this instanceof PageNodes.Button&&(e=d=!1)});var g=new PageNodes.DescriptorDataModel(this);d?(this.title="\u9009\u62e9\u591a\u4e2a\u9875\u9762",g.add({type:"position",name:"position"}),g.add({type:"hline"}),g.add({label:"\u6807\u9898",
name:"title",type:"input"})):e?(this.title="\u9009\u62e9\u591a\u4e2a\u94fe\u63a5",g.add({type:"color",name:"normalColor",label:"\u8fde\u7ebf\u989c\u8272"}),g.add({type:"slider",name:"lineWidth",min:1,max:10,label:"\u8fde\u7ebf\u5bbd\u5ea6"})):f?(this.title="\u9009\u62e9\u591a\u4e2a\u6309\u94ae",g.add({type:"position",name:"buttonPosition"}),g.add({type:"size",name:"size"}),g.add({type:"hline"}),g.add({label:"\u6587\u672c",name:"label",type:"input"})):(this.title="\u9009\u62e9\u591a\u4e2a\u5143\u7d20",
g.add({type:"html",html:"<div>\u9009\u4e2d\u4e86<b>"+a.length+"</b>\u4e2a\u4e0d\u540c\u7684\u5143\u7d20</div>"}));PageNodes.BasicDescriptor.call(this,g);this.getTitle=function(){var a=b(function(a){return a.getTitle()});return PageNodes.ArrayUtil.getSameValue(a)};this.setTitle=function(a){c(function(b){b.setTitle(a)})};this.getPosition=function(){var a=b(function(a){return a.content.x}),c=b(function(a){return a.content.y});return{x:PageNodes.ArrayUtil.getSameValue(a),y:PageNodes.ArrayUtil.getSameValue(c)}};
this.setPosition=function(a){c(function(b){if(a.x!="-")b.content.x=a.x;if(a.y!="-")b.content.y=a.y;PageNodes.editorContainer.update(b)})};this.getNormalColor=function(){var a=b(function(a){for(a=a.normalColor.toString(16);a.length<6;)a="0"+a;return"#"+a}),a=PageNodes.ArrayUtil.getSameValue(a);return a=="-"?"#000000":a};this.setNormalColor=function(a){c(function(b){var c=a.substr(1,a.length);b.normalColor=eval("0x"+c);b.update()})};this.getLineWidth=function(){var a=b(function(a){return a.lineWidth});
return PageNodes.ArrayUtil.getSameValue(a)};this.setLineWidth=function(a){c(function(b){b.lineWidth=a;b.lineStyle.width=b.lineWidth;b.update()})};this.getLabel=function(){var a=b(function(a){return a.getLabel()});return PageNodes.ArrayUtil.getSameValue(a)};this.setLabel=function(a){c(function(b){b.setLabel(a)})};this.getButtonPosition=function(){var a=b(function(a){return a.content.x}),c=b(function(a){return a.content.y});return{x:PageNodes.ArrayUtil.getSameValue(a),y:PageNodes.ArrayUtil.getSameValue(c)}};
this.setButtonPosition=function(a){c(function(b){if(a.x!="-")b.content.x=a.x;if(a.y!="-")b.content.y=a.y;PageNodes.editorContainer.update(b)})};this.getSize=function(){var a=b(function(a){return a.content.width}),c=b(function(a){return a.content.height});return{width:PageNodes.ArrayUtil.getSameValue(a),height:PageNodes.ArrayUtil.getSameValue(c)}};this.setSize=function(a){c(function(b){if(a.width!="-")b.content.width=a.width;if(a.height!="-")b.content.height=a.height;PageNodes.editorContainer.update(b.page)})}};PageNodes.GlobalSelectMode=function(a){this.init=function(){var b=PageNodes.editorContainer,c=b.container,d=b.selectLayer,e=b.layerContainer;c.mousedown(function(f){function g(a){k=!0;a={x:a.clientX-l.x,y:a.clientY-l.y};i.clear();i.lineStyle(1,255,1);var b=l.x-c.offset().left,d=l.y-c.offset().top,b=b-c.outerWidth()*0.5-e.x,d=d-c.outerHeight()*0.5-e.y;i.drawRect(b,d,a.x,a.y)}function h(){var a={pages:b.getSelectedPages().concat(),links:b.getSelectedLinks().concat()};if(k){var f=i.getBounds(),l=[],
n=b.getLinks();$.each(n,function(){var a=f.x-c.outerWidth()*0.5-e.x,b=f.y-c.outerHeight()*0.5-e.y,a=new PIXI.Rectangle(a,b,f.width,f.height),d=this.to.border.x,g=this.to.border.y,b=new PIXI.Point(this.from.btn.border.x,this.from.btn.border.y),d=new PIXI.Point(d,g);PageNodes.BezierCurveHitTestUtil.hitTest(a,b,d)&&l.push(this)});var o=[],n=b.getPages();$.each(n,function(){var a=this.content.getBounds();PageNodes.RectUtil.testRectCross(f,a)&&o.push(this)});a.pages=o;a.links=l}PageNodes.GeneralManager.addSelectAction(j,
a);$(window).off("mousemove",g);$(window).off("mouseup",h);d.removeChild(i)}if(!a.selected||a.selectMode!=PageNodes.SelectMode.Global)f.preventDefault();else{var i=new PIXI.Graphics;d.addChild(i);var j={pages:b.getSelectedPages().concat(),links:b.getSelectedLinks().concat()};b.selectPages([]);b.selectLinks([]);$(window).on("mousemove",g);$(window).on("mouseup",h);var k=!1,l={x:f.clientX,y:f.clientY}}})};this.initObj=function(b){function c(b){var c=b.content;c.interactive=!0;c.on("mousedown",function(c){function d(a){s=
!0;var b={x:a.clientX-r.clientX,y:a.clientY-r.clientY},c=p.scale.x;$.each(l,function(a){var d=t[a].y+b.y/c;this.content.x=t[a].x+b.x/c;this.content.y=d;k.update(this)})}function f(){$(window).off("mousemove",d);$(window).off("mouseup",f);if(s){var a=l.concat(),b=j();PageNodes.GeneralManager.addMoveAction(a,t,b)}}function j(){var a=[];$.each(l,function(){a.push({x:this.content.x,y:this.content.y})});return a}if(!a.selected||a.selectMode!=PageNodes.SelectMode.Global)c.data.originalEvent.preventDefault();
else{c.data.originalEvent.stopPropagation();var k=PageNodes.editorContainer,l=k.getSelectedPages(),p=k.contentLayer,m={pages:l.concat(),links:k.getSelectedLinks().concat()},q={links:k.getSelectedLinks().concat()},n,o=l.indexOf(b);if(o==-1)c.data.originalEvent.ctrlKey?(n=[b],n=n.concat(l)):n=[b];else if(c.data.originalEvent.ctrlKey){n=l.concat();n.splice(o,1);q.pages=n;PageNodes.GeneralManager.addSelectAction(m,q);return}else n=l.concat();q.pages=n;PageNodes.GeneralManager.addSelectAction(m,q);l=k.getSelectedPages();
$(window).on("mousemove",d);$(window).on("mouseup",f);var r={clientX:c.data.originalEvent.clientX,clientY:c.data.originalEvent.clientY},t=j(),s=!1}})}function d(b){var c=b.content;c.interactive=!0;c.on("mousedown",function(c){function d(a){var c=a.clientX-l.offset().left,f=a.clientY-l.offset().top,a=c-l.outerWidth()*0.5-k.x,g=f-l.outerHeight()*0.5-k.y,a=new PIXI.Point(a,g);m.update(q,a);a=j.getPages();n=void 0;$.each(a,function(){this.border.getBounds().contains(c,f)&&this!==b.page&&(n=this);this.setHighlight(!1)});
n!=void 0&&n.setHighlight(!0)}function f(){$(document).off("mousemove",d);$(document).off("mouseup",f);b.setState("normal");p.removeChild(m.content);if(n!=void 0){n.setHighlight(!1);var a=new PageNodes.NodeLink({page:b.page,btn:b},n),c=j.findLinkFrom(a.from);c!=void 0?c.to!==n&&PageNodes.GeneralManager.switchLinks(c,a):PageNodes.GeneralManager.addLink(a)}}if(!a.selected||a.selectMode!=PageNodes.SelectMode.Global)c.data.originalEvent.preventDefault();else{c.stopPropagation();c.data.originalEvent.stopImmediatePropagation();
$(document).on("mousemove",d);$(document).on("mouseup",f);b.setState("down");var j=PageNodes.editorContainer,k=j.layerContainer,l=j.container,p=j.lineLayer,m=new PageNodes.NodeLinking;p.addChild(m.content);var q=new PIXI.Point(b.border.x,b.border.y),n}})}b instanceof PageNodes.Page?c(b):b instanceof PageNodes.Button&&d(b)}};PageNodes.PageSelectMode=function(a){this.init=function(){var b=PageNodes.editorContainer,c=b.container,d=b.selectLayer,e=b.layerContainer;c.mousedown(function(f){function g(a){k=!0;a={x:a.clientX-l.x,y:a.clientY-l.y};i.clear();i.lineStyle(1,255,1);var b=l.x-c.offset().left,d=l.y-c.offset().top,b=b-c.outerWidth()*0.5-e.x,d=d-c.outerHeight()*0.5-e.y;i.drawRect(b,d,a.x,a.y)}function h(){var a=[];if(k){var c=i.getBounds(),e=[],a=b.getPages();$.each(a,function(){$.each(this.buttons,function(){var a=this.content.getBounds();
PageNodes.RectUtil.testRectCross(c,a)&&e.push(this)})});a=e}PageNodes.GeneralManager.addSelectButtonAction(j,a);$(window).off("mousemove",g);$(window).off("mouseup",h);d.removeChild(i)}if(!a.selected||a.selectMode!=PageNodes.SelectMode.Page)f.preventDefault();else{var i=new PIXI.Graphics;d.addChild(i);var j=b.getSelectedButtons().concat();b.selectButtons([]);$(window).on("mousemove",g);$(window).on("mouseup",h);var k=!1,l={x:f.clientX,y:f.clientY}}})};this.initObj=function(b){function c(b){var c=
b.content;c.interactive=!0;c.on("mousedown",function(c){function e(a){r=!0;var b={x:a.clientX-n.clientX,y:a.clientY-n.clientY},c=l.scale.x;$.each(k,function(a){var d=o[a].y+b.y/c;this.content.x=o[a].x+b.x/c;this.content.y=d;j.update(this.page)})}function h(){$(window).off("mousemove",e);$(window).off("mouseup",h);if(r){var a=k.concat(),b=i();PageNodes.GeneralManager.addMoveButtonAction(a,o,b)}}function i(){var a=[];$.each(k,function(){a.push({x:this.content.x,y:this.content.y})});return a}if(!a.selected||
a.selectMode!=PageNodes.SelectMode.Page)c.data.originalEvent.preventDefault();else{c.data.originalEvent.stopPropagation();var j=PageNodes.editorContainer,k=j.getSelectedButtons(),l=j.contentLayer,p=j.getSelectedButtons().concat(),m=[],q=k.indexOf(b);if(q==-1)c.data.originalEvent.ctrlKey?(m=[b],m=m.concat(k)):m=[b];else if(c.data.originalEvent.ctrlKey){m=k.concat();m.splice(q,1);PageNodes.GeneralManager.addSelectButtonAction(p,m);return}else m=k.concat();PageNodes.GeneralManager.addSelectButtonAction(p,
m);k=j.getSelectedButtons();$(window).on("mousemove",e);$(window).on("mouseup",h);var n={clientX:c.data.originalEvent.clientX,clientY:c.data.originalEvent.clientY},o=i(),r=!1}})}b instanceof PageNodes.Button&&c(b)}};PageNodes.BaseTool=function(){this.selected=!1;this.cursor="auto";this.init=function(){};this.initObj=function(){};this.setSelected=function(a){this.selected=a;this.setCursor(this.cursor)};this.setCursor=function(a){PageNodes.editorContainer.container.css("cursor",a)}};PageNodes.SelectMode={Global:"globalMode",Page:"pageMode"};PageNodes.SelectTool=function(){PageNodes.BaseTool.call(this);this.modes=[new PageNodes.GlobalSelectMode(this),new PageNodes.PageSelectMode(this)];this.descriptor=new PageNodes.SelectToolDescriptor(this);this.selectMode=PageNodes.SelectMode.Global;this.init=function(){$.each(this.modes,function(){this.init()})};this.initObj=function(a){$.each(this.modes,function(){this.initObj(a)})}};PageNodes.DragTool=function(){PageNodes.BaseTool.call(this);var a=this;this.cursor="move";this.descriptor=new PageNodes.DragToolDescriptor(this);this.init=function(){var b=!1,c=-1;$(window).keydown(function(a){a.keyCode==32&&(a=PageNodes.ToolManager.getSelectedIdx(),b||a==1||(c=a,b=!0,PageNodes.GeneralManager.switchToolIdx(1)))});$(window).keyup(function(a){a.keyCode==32&&(a=PageNodes.ToolManager.getSelectedIdx(),b&&a==1&&(b=!1,PageNodes.GeneralManager.switchToolIdx(c),c=-1))});var d=PageNodes.editorContainer,
e=d.layerContainer;d.container.mousedown(function(b){function c(a){var a={x:a.clientX-i.x,y:a.clientY-i.y},b=i.ly+a.y;e.x=i.lx+a.x;e.y=b}function d(){$(window).off("mousemove",c);$(window).off("mouseup",d)}if(a.selected){$(window).on("mousemove",c);$(window).on("mouseup",d);var i={x:b.clientX,y:b.clientY,lx:e.x,ly:e.y}}else b.preventDefault()})}};PageNodes.ZoomTool=function(){function a(){return"url(assets/image/cursors/"+c+".png) 18 18,auto"}PageNodes.BaseTool.call(this);var b=this,c="zoomIn";this.cursor=a();this.descriptor=new PageNodes.ZoomToolDescriptor(this);this.init=function(){var d=PageNodes.editorContainer,e=d.container;$(window).keydown(function(d){b.selected&&d.keyCode==17&&c!="zoomOut"&&(c="zoomOut",b.setCursor(a()))});$(window).keyup(function(d){b.selected&&d.keyCode==17&&c!="zoomIn"&&(c="zoomIn",b.setCursor(a()))});e.mousedown(function(a){if(b.selected){var g=
a.clientX-e.offset().left,a=a.clientY-e.offset().top,g=new PIXI.Point(g,a);c=="zoomOut"?d.zoom({delta:-1,point:g}):d.zoom({delta:1,point:g})}else a.preventDefault()})}};PageNodes.PageTool=function(){PageNodes.BaseTool.call(this);var a=this;this.cursor="url(assets/image/cursors/newPage.png) 18 18,auto";this.descriptor=new PageNodes.PageToolDescriptor(this);this.init=function(){var b=PageNodes.editorContainer,c=b.container;c.mousedown(function(d){if(a.selected){var e=d.clientX-c.offset().left,d=d.clientY-c.offset().top,e=new PIXI.Point(e,d),e=b.globalToLocal(e),d=new PageNodes.Page({title:"\u672a\u547d\u540d"});d.content.x=e.x;d.content.y=e.y;PageNodes.GeneralManager.addPage(d)}else d.preventDefault()})}};PageNodes.ButtonTool=function(){PageNodes.BaseTool.call(this);var a=this;this.cursor="url(assets/image/cursors/CrossHair.gif) 7 7,auto";this.descriptor=new PageNodes.ButtonToolDescriptor(this);this.initObj=function(b){function c(b){var c=b.content;c.interactive=!0;c.on("mousedown",function(c){function e(a){q=!0;a={x:a.clientX-n.x,y:a.clientY-n.y};m.clear();m.beginFill(255,0.3);var b=n.x-k.offset().left,c=n.y-k.offset().top,b=b-k.outerWidth()*0.5-l.x,c=c-k.outerHeight()*0.5-l.y;m.drawRect(b,c,a.x,
a.y);m.endFill()}function h(){$(window).off("mousemove",e);$(window).off("mouseup",h);if(q){var a=m.getBounds();if(!(a.width==0||a.height==0)){var c=a.x-k.outerWidth()*0.5-l.x,f=a.y-k.outerHeight()*0.5-l.y;c-=b.border.x;f-=b.border.y;var i=p.scale.x,u=b.size.width*i;i*=b.size.height;c+=u*0.5;f+=i*0.5;i=a.width;a=a.height;u/=b.originSize.width;c/=u;f/=u;i/=u;a/=u;c=new PageNodes.Button({label:"button",x:c,y:f,width:i,height:a});PageNodes.GeneralManager.addButtonToPage(c,b);m.clear();j.removeChild(m)}}}
if(a.selected){$(window).on("mousemove",e);$(window).on("mouseup",h);var i=PageNodes.editorContainer,j=i.selectLayer,k=i.container,l=i.layerContainer,p=i.contentLayer,m=new PIXI.Graphics;j.addChild(m);var q=!1,n={x:c.data.originalEvent.clientX,y:c.data.originalEvent.clientY}}else c.data.originalEvent.preventDefault()})}b instanceof PageNodes.Page&&c(b)}};PageNodes.ToolManager=function(){var a={},b=-1,c=[new PageNodes.SelectTool,new PageNodes.DragTool,new PageNodes.PageTool,new PageNodes.ButtonTool,new PageNodes.ZoomTool];a.init=function(){$.each(c,function(){this.init()});this.selectToolIdx(0)};a.getSelectedIdx=function(){return b};a.getTools=function(){return c};a.selectToolIdx=function(a){var e;b>-1&&(e=c[b],e.setSelected(!1));e=c[a];e.setSelected(!0);b=a;PageNodes.propertiesPanel.update()};a.initObj=function(a){$.each(c,function(){this.initObj(a)})};
a.clearObj=function(a){function b(a){a.content.interactive=!1;a.content.off("mousedown")}function c(a){a.content.interactive=!1;a.content.off("mouseover");a.content.off("mouseout");a.content.off("mousedown")}a instanceof PageNodes.Page&&b(a);a instanceof PageNodes.Button&&c(a)};return a}();PageNodes.EditorContainer=function(a){function b(){d.render();requestAnimationFrame(b)}function c(){var b=a.outerWidth(),c=a.outerHeight();s.resize(b,c);l.x=b*0.5;l.y=c*0.5}var d=this,e=[0.06,0.12,0.25,0.5,0.66,1,2,3,4,8,16,32,64],f=5,g=[],h=[],i=[],j=[],k=[],l,p,m,q,n,o,r,t=new PIXI.Container,s=new PIXI.autoDetectRenderer;s.backgroundColor=16777215;$(s.view).appendTo(a);this.getSelectedPages=function(){return h};this.getPages=function(){return g};this.zoomToLevel=function(a,b){a!=f&&(this.zoom({to:e[a],
point:b}),PageNodes.topMenu.zoomMenuController.selectValue(a),f=a)};this.zoom=function(b){var c;if(b.delta!=void 0){var d=b.delta;c=b.point;b=f+d;b=b<0?0:b;b=b>e.length-1?e.length-1:b;this.zoomToLevel(b,c)}else if(b.to!=void 0){c=b.point;c==void 0&&(c=new PIXI.Point(a.outerWidth()*0.5,a.outerHeight()*0.5));b=b.to;d=q.scale.x;c=this.globalToLocal(c);var g=p.x,h=p.y;g-=(b-d)*c.x;h-=(b-d)*c.y;p.x=g;p.y=h;q.scale.x=b;q.scale.y=b;this.updateAll()}};this.globalToLocal=function(b){var c=q.scale.x,d=(b.x-
a.outerWidth()*0.5-p.x)/c,b=(b.y-a.outerHeight()*0.5-p.y)/c;return new PIXI.Point(d,b)};this.add=function(a){q.addChild(a.content);n.addChild(a.border);o.addChild(a.titleLabel);$.each(a.buttons,function(){a.atach(this)});a.update();g.push(a);PageNodes.ToolManager.initObj(a)};this.remove=function(a){$.each(a.buttons,function(){a.detach(this)});q.removeChild(a.content);n.removeChild(a.border);o.removeChild(a.titleLabel);var b=g.indexOf(a);g.splice(b,1);b=h.indexOf(a);b>-1&&h.splice(b,1);PageNodes.ToolManager.clearObj(a)};
this.addLink=function(a){m.addChild(a.content);a.update();i.push(a)};this.removeLink=function(a){m.removeChild(a.content);var b=i.indexOf(a);i.splice(b,1);b=j.indexOf(a);b>-1&&j.splice(b,1)};this.findLinkFrom=function(a){var b;$.each(i,function(){this.from.page===a.page&&this.from.btn===a.btn&&(b=this)});return b};this.getLinks=function(){return i};this.getSelectedLinks=function(){return j};this.getAllButtons=function(){var a=[];$.each(g,function(){$.each(this.buttons,function(){a.push(this)})});
return a};this.update=function(a){a.update();a=this.findLinkWithPage(a);$.each(a,function(){this.update()});a=PageNodes.propertiesPanel.multipleSelectDescriptor;a!=void 0&&a.update()};this.findLinkWithPage=function(a){var b=[];$.each(i,function(){(this.from.page===a||this.to===a)&&b.push(this)});return b};this.updateAll=function(){$.each(g,function(){d.update(this)})};this.render=function(){s.render(t);PageNodes.Test.testRender()};this.selectPages=function(a){$.each(h,function(){this.setSelected(!1)});
$.each(a,function(){this.setSelected(!0)});h=a};this.selectLinks=function(a){$.each(j,function(){this.setSelected(!1)});$.each(a,function(){this.setSelected(!0)});j=a};this.selectButtons=function(a){$.each(k,function(){this.setState("normal")});$.each(a,function(){this.setState("selected")});k=a};this.getSelectedButtons=function(){return k};this.addButton=function(a,b){b.add(a)};this.removeButton=function(a){a.page.remove(a);a=k.indexOf(a);a>-1&&k.splice(a,1)};this.open=function(a){PageNodes.HistoryManager.removeAll();
this.zoomToLevel(5);for(k=[];g.length>0;)this.remove(g[0]);for(;i.length>0;)this.removeLink(i[0]);PageNodes.propertiesPanel.update();a=JSON.parse(a);PageNodes.Settings.pageSize=a.pageSize;PageNodes.editorContainer.layerContainer.x=a.pivot.x;PageNodes.editorContainer.layerContainer.y=a.pivot.y;$.each(a.pages,function(){var a=new PageNodes.Page({title:this.title});a.content.x=this.position.x;a.content.y=this.position.y;PageNodes.editorContainer.add(a);$.each(this.buttons,function(){var b=new PageNodes.Button(this);
a.add(b)})});$.each(a.links,function(){var a=g[this.from.pageIdx],a=new PageNodes.NodeLink({page:a,btn:a.buttons[this.from.btnIdx]},g[this.to]);PageNodes.editorContainer.addLink(a);a.descriptor.setNormalColor(this.normalColor);a.setSelected(!1);a.descriptor.setLineWidth(this.lineWidth)})};l=new PIXI.Container;t.addChild(l);p=new PIXI.Container;l.addChild(p);m=new PIXI.Container;p.addChild(m);q=new PIXI.Container;p.addChild(q);n=new PIXI.Container;p.addChild(n);o=new PIXI.Container;p.addChild(o);r=
new PIXI.Container;p.addChild(r);d.contentLayer=q;d.lineLayer=m;d.layerContainer=p;d.selectLayer=r;d.borderLayer=n;d.labelLayer=o;d.container=a;d.renderer=s;d.stage=t;b();$(document).on(PageNodes.MainLayout.Event.RESIZE,c);c()};PageNodes.Page=function(a){var b=this,c={width:2,color:6710886},d={font:"22px Arial",fill:"#000000"},e=!1,f=!1;this.originSize=JSON.parse(JSON.stringify(PageNodes.Settings.pageSize));this.size={width:this.originSize.width*PageNodes.Settings.pageScale,height:this.originSize.height*PageNodes.Settings.pageScale};this.content=function(){var a=new PIXI.Container,c=new PIXI.Graphics;c.beginFill(16724736,0);var d=b.size.width,e=b.size.height;c.drawRect(-d*0.5,-e*0.5,d,e);c.endFill();a.addChild(c);return a}();
this.border=new PIXI.Graphics;this.titleLabel=function(){var b=new PIXI.Text(a.title);b.anchor.x=0.5;b.anchor.y=1;return b}();this.buttons=[];var g=new PIXI.filters.DropShadowFilter;g.angle=Math.PI*2;g.blur=10;g.alpha=0.2;g.distance=2;this.descriptor=new PageNodes.PageDescriptor(this);this.getTitle=function(){return a.title};this.setTitle=function(b){a.title=b;this.titleLabel.text=b};this.setSize=function(a,b){var c=this.content.getChildAt(0);this.originSize={width:a,height:b};this.size={width:this.originSize.width*
PageNodes.Settings.pageScale,height:this.originSize.height*PageNodes.Settings.pageScale};c.width=this.size.width;c.height=this.size.height;this.update()};this.update=function(){var a=this.content.parent.scale.x;this.border.clear();this.border.lineStyle(c.width,c.color);this.border.beginFill(16777215,0.8);var e=b.size.width*a,f=b.size.height*a;this.border.drawRoundedRect(-e*0.5,-f*0.5,e,f,5);this.border.endFill();this.border.x=this.content.x*a;this.border.y=this.content.y*a;this.titleLabel.x=this.border.x;
this.titleLabel.y=this.border.y-f*0.5-3;this.titleLabel.style=d;$.each(this.buttons,function(){this.update()});this.descriptor.update()};this.setSelected=function(a){c.color=a?16763904:6710886;c.width=2;d.fill=a?13382400:0;this.border.filters=a?[g]:null;this.update();e=a};this.setHighlight=function(a){if(f!=a)a?(c.color=16711680,c.width=4,d.fill=16711680,this.update()):this.setSelected(e),f=a};this.add=function(a){a.page=this;this.atach(a);this.buttons.push(a)};this.remove=function(a){a.page=null;
this.detach(a);this.buttons.splice(this.buttons.indexOf(a),1)};this.atach=function(a){a.content.x-=this.size.width*0.5;a.content.y-=this.size.height*0.5;this.content.addChild(a.content);this.titleLabel.parent.addChild(a.label);this.border.parent.addChild(a.border);a.update();PageNodes.ToolManager.initObj(a)};this.detach=function(a){a.content.x+=this.size.width*0.5;a.content.y+=this.size.height*0.5;this.content.removeChild(a.content);this.titleLabel.parent.removeChild(a.label);this.border.parent.removeChild(a.border);
PageNodes.ToolManager.clearObj(a)};this.clone=function(){var b=JSON.parse(JSON.stringify(a)),c=new PageNodes.Page(b);c.content.x=this.content.x;c.content.y=this.content.y;$.each(this.buttons,function(){var a=this.clone();a.page=c;c.buttons.push(a)});return c};this.getDesc=function(){var b={title:a.title,buttons:[],position:{x:this.content.x,y:this.content.y}};$.each(this.buttons,function(){b.buttons.push(this.getDesc())});return b}};PageNodes.Button=function(a){var b=this;this.page=void 0;this.size={width:a.width*PageNodes.Settings.pageScale,height:a.height*PageNodes.Settings.pageScale};this.position={x:a.x*PageNodes.Settings.pageScale,y:a.y*PageNodes.Settings.pageScale};this.content=function(){var a=new PIXI.Graphics;a.beginFill(16711680,0);var c=b.size.width,d=b.size.height,h=-c*0.5,i=-d*0.5;a.drawRect(h,i,c,d);a.endFill();a.x=b.position.x-h;a.y=b.position.y-i;return a}();this.label=function(){var b=new PIXI.Text(a.label);
b.anchor.x=0.5;b.anchor.y=0.5;return b}();this.border=new PIXI.Graphics;this.descriptor=new PageNodes.ButtonDescriptor(this);var c={font:"11px Arial",fill:"#0000ff"},d={width:1,color:255};this.getLabel=function(){return a.label};this.setLabel=function(b){a.label=b;this.label.text=b};this.update=function(){this.position={x:this.content.x-this.content.width*0.5+this.page.size.width*0.5,y:this.content.y-this.content.height*0.5+this.page.size.height*0.5};this.size={width:this.content.width,height:this.content.height};
a.x=this.position.x/PageNodes.Settings.pageScale;a.y=this.position.y/PageNodes.Settings.pageScale;a.width=this.size.width/PageNodes.Settings.pageScale;a.height=this.size.height/PageNodes.Settings.pageScale;var e=this.content.parent.parent.scale.x;this.border.clear();this.border.lineStyle(d.width,d.color);var f=b.size.width*e,g=b.size.height*e;this.border.drawRect(-f*0.5,-g*0.5,f,g);this.border.x=(this.content.parent.x+this.content.x)*e;this.border.y=(this.content.parent.y+this.content.y)*e;e=f<g?
f:g;e*=0.6;c.font=e+"px Arial";this.label.style=c;this.label.x=this.border.x;this.label.y=this.border.y;this.descriptor.update()};this.setState=function(a){switch(a){case "down":d.color=16711680;c.fill="#ff0000";d.width=3;break;case "normal":d.color=255;c.fill="#0000ff";d.width=1;break;case "selected":d.color=16763904,c.fill="#cc3300",d.width=1}this.update()};this.clone=function(){var b=JSON.parse(JSON.stringify(a));return new PageNodes.Button(b)};this.getDesc=function(){return{x:a.x,y:a.y,width:a.width,
height:a.height,label:a.label}}};PageNodes.NodeLinking=function(){this.content=new PIXI.Graphics;this.lineStyle={width:2,color:16711680};this.update=function(a,b){this.content.clear();this.content.beginFill(this.lineStyle.color);this.content.drawCircle(a.x,a.y,3);this.content.endFill();this.content.beginFill(this.lineStyle.color);this.content.drawCircle(b.x,b.y,3);this.content.endFill();this.content.lineStyle(this.lineStyle.width,this.lineStyle.color);this.content.moveTo(a.x,a.y);var c=(b.x-a.x)*0.5;this.content.bezierCurveTo(a.x+
c,a.y,b.x-c,b.y,b.x,b.y)}};PageNodes.NodeLink=function(a,b){this.from=a;this.to=b;PageNodes.NodeLinking.call(this);this.normalColor=255;this.selectedColor=16763904;this.lineWidth=2;this.lineStyle={width:this.lineWidth,color:this.normalColor};var c=new PIXI.filters.DropShadowFilter;c.angle=Math.PI*2;c.blur=5;c.alpha=0.2;c.distance=2;this.descriptor=new PageNodes.LinkDescriptor(this);super_update=this.update;this.update=function(){var c=new PIXI.Point(a.btn.border.x,a.btn.border.y),e=new PIXI.Point(b.border.x,b.border.y);super_update.call(this,
c,e)};this.setSelected=function(a){this.lineStyle.color=a?this.selectedColor:this.normalColor;this.content.filters=a?[c]:null;this.update()}};PageNodes.RectUtil={};PageNodes.RectUtil.testRectCross=function(a,b){var c,d,e,f;c=a.x+a.width/2;d=a.y+a.height/2;e=b.x+b.width/2;f=b.y+b.height/2;return Math.abs(c-e)<=a.width/2+b.width/2&&Math.abs(d-f)<=a.height/2+b.height/2};PageNodes.RectUtil.merge=function(a,b){var c={};c.x=a.x<b.x?a.x:b.x;c.y=a.y<b.y?a.y:b.y;c.width=a.x+a.width>b.x+b.width?a.x+a.width-c.x:b.x+b.width-c.x;c.height=a.y+a.height>b.y+b.height?a.y+a.height-c.y:b.y+b.height-c.y;return c};PageNodes.ArrayUtil={};PageNodes.ArrayUtil.equals=function(a,b){var c=!0;if(a.length!=b.length)c=!1;else for(var d=a.length,e=0;e<d;e++)if(a[e]!==b[e]){c=!1;break}return c};PageNodes.ArrayUtil.invert=function(a,b){var c=[];$.each(a,function(){b.indexOf(this)==-1&&c.push(this)});return c};PageNodes.ArrayUtil.filterRepeat=function(a){var b=[];$.each(a,function(){b.indexOf(this)==-1&&b.push(this)});return b};
PageNodes.ArrayUtil.getSameValue=function(a,b){b==void 0&&(b=function(a,b){return a==b});for(var c,d=0;d<a.length;d++)if(d==0)c=a[d];else if(!b(a[d],c)){c="-";break}return c};PageNodes.ArrayUtil.repeatValue=function(a,b){for(var c=[],d=0;d<b;d++)c.push(a);return c};PageNodes.BezierCurveHitTestUtil={canvas:void 0,hitTest:function(a,b,c){if(a.width==0||a.height==0)return!1;var d=!1;if(this.canvas==void 0)this.canvas=$("<canvas>"),this.canvas.css("position","absolute");this.canvas.get(0).width=a.width;this.canvas.get(0).height=a.height;var e=b.x-a.x,b=b.y-a.y,f=c.x-a.x,c=c.y-a.y,g=this.canvas.get(0).getContext("2d");g.beginPath();g.strokeStyle="#ff0000";g.lineWidth=1;g.moveTo(e,b);var h=(f-e)*0.5;g.bezierCurveTo(e+h,b,f-h,c,f,c);g.stroke();a=g.getImageData(0,0,
a.width,a.height);e=a.data.length;for(b=0;b<e;b+=4)if(a.data[b+0]>0){d=!0;break}return d}};
