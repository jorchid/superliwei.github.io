var Firefly={Event:{UnHandledCommand:"FireflyUnHandledCommandEvent"}};
Firefly.init=function(){this.mainLayout=new Firefly.MainLayout("#mainLayout");this.topMenu=new Firefly.TopMenu("#topMenu");var b=$("#mainLayout #centerBox");this.editor=new Firefly.Editor(b);this.resourcePanel=new Firefly.ResourcePanel;this.propertiesPanel=new Firefly.PropertiesPanel;this.historyPanel=new Firefly.HistoryPanel;this.settingWin=new Firefly.SettingWin("#settingWin");this.inputWin=new Firefly.InputWin("#inputWin");this.onlineFileWin=new Firefly.OnlineFileWin("#onlineFileWin")};$(function(){Firefly.init()});function trace(b){console.log(b)};Firefly.File={openFile:function(){var b=this;this.browser(function(a){a.name.split(".").indexOf("ff")!==1?Firefly.Alert.show("\u6587\u4ef6\u683c\u5f0f\u4e0d\u5bf9!"):b.readText(a,function(a){Firefly.editor.checkSource(a)?Firefly.editor.importSource(a):Firefly.Alert.show("\u6587\u4ef6\u6e90\u7801\u9519\u8bef!")})})},exportFile:function(){var b=this;Firefly.inputWin.show({icon:"save icon",title:"\u4fdd\u5b58\u6e90\u6587\u4ef6",placeholder:"\u8f93\u5165\u6587\u4ef6\u540d\u79f0",rightlabel:".ff",value:"firefly-"+
(new Date).getTime(),submitLabel:"\u4fdd\u5b58",onSubmit:function(a){var c=Firefly.editor.exportSource();b.saveText(c,a+".ff")}})},browser:function(b){var a=$("<input type='file'>");a.trigger("click");a.change(function(){var c=a.get(0).files[0];b(c)})},saveData:function(b,a){var c=$("<a>");c.attr("href",b);c.attr("download",a);c.get(0).click()},saveText:function(b,a){this.saveData("data:application/octet-stream;base64,"+Base64.encode(b),a)},readText:function(b,a){$("#loadingMask").dimmer({closable:!1});
$("#loadingMask").find(".ui.text.loader").text("\u6587\u4ef6\u8bfb\u53d6\u4e2d...");$("#loadingMask").dimmer("show");var c=new FileReader;c.onload=function(){$("#loadingMask").dimmer("hide");a(c.result)};c.readAsText(b)}};Firefly.KeyboardManager={};
Firefly.KeyboardManager.init=function(){function b(a){return a.target instanceof HTMLTextAreaElement||a.target instanceof HTMLInputElement}$(window).keydown(function(a){if(!b(a))switch(a.keyCode){case 38:a.preventDefault();!a.ctrlKey&&!a.shiftKey&&Firefly.KeyboardManager.execute("\u2191");break;case 40:a.preventDefault();!a.ctrlKey&&!a.shiftKey&&Firefly.KeyboardManager.execute("\u2193");break;case 37:a.preventDefault();!a.ctrlKey&&!a.shiftKey&&Firefly.KeyboardManager.execute("\u2190");break;case 39:a.preventDefault();
!a.ctrlKey&&!a.shiftKey&&Firefly.KeyboardManager.execute("\u2192");break;case 65:a.ctrlKey&&a.preventDefault();break;case 68:a.ctrlKey&&a.preventDefault();break;case 73:a.ctrlKey&&a.shiftKey&&a.preventDefault();break;case 79:a.ctrlKey&&a.preventDefault();break;case 85:a.ctrlKey&&a.preventDefault();break;case 49:a.ctrlKey&&a.preventDefault();break;case 50:a.ctrlKey&&a.preventDefault();break;case 89:a.ctrlKey&&a.preventDefault();break;case 90:a.ctrlKey&&a.preventDefault();break;case 71:a.ctrlKey&&a.preventDefault()}});
$(window).keyup(function(a){if(!b(a))switch(a.keyCode){case 46:Firefly.KeyboardManager.execute("Delete");break;case 65:a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+A");break;case 68:a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+D");break;case 73:a.ctrlKey&&a.shiftKey&&Firefly.KeyboardManager.execute("Ctrl+Shift+I");break;case 79:a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+O");break;case 85:a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+U");break;case 49:a.ctrlKey&&a.shiftKey?Firefly.KeyboardManager.execute("Ctrl+Shift+1"):
a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+1");break;case 50:a.ctrlKey&&a.shiftKey?Firefly.KeyboardManager.execute("Ctrl+Shift+2"):a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+2");break;case 90:a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+Z");break;case 89:a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+Y");break;case 67:a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+C");break;case 86:a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+V");break;case 88:a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+X");
break;case 38:a.preventDefault();a.ctrlKey&&a.shiftKey?Firefly.KeyboardManager.execute("Ctrl+Shift+\u2191"):a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+\u2191");break;case 40:a.preventDefault();a.ctrlKey&&a.shiftKey?Firefly.KeyboardManager.execute("Ctrl+Shift+\u2193"):a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+\u2193");break;case 37:a.preventDefault();a.ctrlKey&&a.shiftKey?Firefly.KeyboardManager.execute("Ctrl+Shift+\u2190"):a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+\u2190");break;
case 39:a.preventDefault();a.ctrlKey&&a.shiftKey?Firefly.KeyboardManager.execute("Ctrl+Shift+\u2192"):a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+\u2192");break;case 71:a.ctrlKey&&a.shiftKey?Firefly.KeyboardManager.execute("Ctrl+Shift+G"):a.ctrlKey&&Firefly.KeyboardManager.execute("Ctrl+G")}});$(window).mousewheel(function(a){a.ctrlKey&&(a.preventDefault(),Firefly.editor.getEditorCanvas().zoom({delta:a.deltaY,point:new Firefly.Point(a.clientX,a.clientY)}))})};
Firefly.KeyboardManager.execute=function(b){switch(b){case "Delete":Firefly.HistoryManager.addRemoveSelectedComponentsAction();break;case "Ctrl+Z":Firefly.HistoryManager.undo();break;case "Ctrl+Y":Firefly.HistoryManager.redo();break;case "Ctrl+C":Firefly.Clipboard.copy();break;case "Ctrl+V":Firefly.Clipboard.paste();break;case "Ctrl+X":Firefly.Clipboard.cut();break;case "\u2191":Firefly.HistoryManager.addStepMoveAction("up");break;case "\u2193":Firefly.HistoryManager.addStepMoveAction("down");break;
case "\u2190":Firefly.HistoryManager.addStepMoveAction("left");break;case "\u2192":Firefly.HistoryManager.addStepMoveAction("right");break;case "Ctrl+\u2191":Firefly.HistoryManager.addMoveSelectedComponentLayerAction("up");break;case "Ctrl+\u2193":Firefly.HistoryManager.addMoveSelectedComponentLayerAction("down");break;case "Ctrl+Shift+\u2191":Firefly.HistoryManager.addMoveSelectedComponentLayerAction("top");break;case "Ctrl+Shift+\u2193":Firefly.HistoryManager.addMoveSelectedComponentLayerAction("bottom");
break;case "Ctrl+A":Firefly.HistoryManager.addSelectAllAction();break;case "Ctrl+Shift+I":Firefly.HistoryManager.addInvertSelectAction();break;case "Ctrl+D":Firefly.HistoryManager.addCancelSelectAction();break;case "Ctrl+1":Firefly.topMenu.panelMenuController.getMenu().dropdown("set selected","properties");break;case "Ctrl+2":Firefly.topMenu.panelMenuController.getMenu().dropdown("set selected","history");break;case "Ctrl+Shift+1":Firefly.mainLayout.toggleLeft();break;case "Ctrl+Shift+2":Firefly.mainLayout.toggleRight();
break;case "Ctrl+O":Firefly.File.openFile();break;case "export":Firefly.File.exportFile();break;case "Ctrl+U":Firefly.settingWin.show(0);break;case "showQuickKey":Firefly.settingWin.show(1);break;case "about":Firefly.settingWin.show(2);break;case "Ctrl+G":Firefly.HistoryManager.addGroupAction();break;case "Ctrl+Shift+G":Firefly.HistoryManager.addBreakGroupAction();break;case "onlineFile":Firefly.onlineFileWin.show()}};$(function(){Firefly.KeyboardManager.init()});Firefly.HistoryManager={};Firefly.HistoryManager.UPDATE="historyManagerUpdate";Firefly.HistoryManager.maxLen=50;Firefly.HistoryManager.items=[];Firefly.HistoryManager.idx=-1;Firefly.HistoryManager.add=function(b,a,c){for(;this.items.length-1>this.idx;)this.items.pop();b=new Firefly.HistoryItem(b,a,c);this.items.push(b);this.items.length>this.maxLen&&this.items.shift();b.redo();this.idx=this.items.length-1;$(document).trigger(Firefly.HistoryManager.UPDATE)};
Firefly.HistoryManager.addChangeAction=function(b,a,c,e){this.add(b,function(){e(a)},function(){e(c)})};Firefly.HistoryManager.undo=function(){this.idx>-1&&(this.items[this.idx].undo(),this.idx--,$(document).trigger(Firefly.HistoryManager.UPDATE))};Firefly.HistoryManager.redo=function(){this.idx<this.items.length-1&&(this.idx++,this.items[this.idx].redo(),$(document).trigger(Firefly.HistoryManager.UPDATE))};
Firefly.HistoryManager.removeAll=function(){for(;this.items.length>0;)this.items.pop();this.idx=-1;$(document).trigger(Firefly.HistoryManager.UPDATE)};Firefly.HistoryManager.go=function(b){for(b=this.items.indexOf(b);this.idx!=b;)b<this.idx?(this.items[this.idx].undo(),this.idx--):(this.idx++,this.items[this.idx].redo());$(document).trigger(Firefly.HistoryManager.UPDATE)};Firefly.HistoryItem=function(b,a,c){this.type=b;this.undo=a;this.redo=c};
Firefly.HistoryManager.addComponentAction=function(b){var a=Firefly.editor.getEditorCanvas(),c;this.add("new",function(){a.remove(c)},function(){c==void 0?(Firefly.editor.runCmd(b),c=a.components[a.components.length-1]):Firefly.editor.getEditorCanvas().add(c)})};Firefly.HistoryManager.addSelectAction=function(b,a){Firefly.ArrayUtil.equals(b,a)?Firefly.editor.getEditorCanvas().scaleTool.setTargets(a):this.addChangeAction(a.length>0?"select":"unselect",b,a,function(a){Firefly.editor.getEditorCanvas().scaleTool.setTargets(a)})};
Firefly.HistoryManager.addSelectAllAction=function(){var b=Firefly.editor.getEditorCanvas().components,a=Firefly.editor.getEditorCanvas().scaleTool.targets;b.length>0&&b.length!=a.length&&this.addSelectAction(a.concat(),b.concat())};
Firefly.HistoryManager.addInvertSelectAction=function(){var b=Firefly.editor.getEditorCanvas().components,a=Firefly.editor.getEditorCanvas().scaleTool.targets;if(b.length>0&&b.length-a.length>0){var c=function(){var c=[];$.each(b,function(){a.indexOf(this)==-1&&c.push(this)});return c}();this.addSelectAction(a.concat(),c)}};Firefly.HistoryManager.addCancelSelectAction=function(){var b=Firefly.editor.getEditorCanvas().scaleTool.targets;b.length>0&&this.addSelectAction(b.concat(),[])};
Firefly.HistoryManager.addMoveAction=function(b,a,c){this.addChangeAction("move",a,c,function(a){$.each(b,function(d){this.view.css("left",a[d].left);this.view.css("top",a[d].top);this.descriptor.update()});Firefly.editor.getEditorCanvas().scaleTool.update()})};var lastTargets,firstPos;
Firefly.HistoryManager.addStepMoveAction=function(b){var a=Firefly.editor.getEditorCanvas().scaleTool.targets.concat();if(a.length>0){var c=function(){var d=[];$.each(a,function(){var a=parseInt(this.view.css("left")),c=parseInt(this.view.css("top"));d.push({left:a,top:c})});return d}(),e=function(){var a=[];$.each(c,function(){var c={};switch(b){case "up":c.left=this.left;c.top=this.top-1;break;case "down":c.left=this.left;c.top=this.top+1;break;case "left":c.left=this.left-1;c.top=this.top;break;
case "right":c.left=this.left+1,c.top=this.top}a.push(c)});return a}();lastTargets!=void 0&&Firefly.ArrayUtil.equals(lastTargets,a)&&this.items[this.items.length-1].type=="move"?(this.items.pop(),this.addMoveAction(a,firstPos,e)):(lastTargets=a,firstPos=c,this.addMoveAction(a,c,e))}};
Firefly.HistoryManager.addRemoveSelectedComponentsAction=function(){var b=Firefly.editor.getEditorCanvas().scaleTool.targets.concat();b.length!=0&&this.add("del",function(){$.each(b,function(){Firefly.editor.getEditorCanvas().add(this)});Firefly.editor.getEditorCanvas().scaleTool.setTargets(b)},function(){$.each(b,function(){Firefly.editor.getEditorCanvas().remove(this)});Firefly.editor.getEditorCanvas().scaleTool.setTargets([])})};
Firefly.HistoryManager.addScaleSelectedComponentsAction=function(b,a,c){this.addChangeAction("scale",a,c,function(a){$.each(b,function(d){this.view.css("left",a[d].left);this.view.css("top",a[d].top);this.view.outerWidth(a[d].width);this.view.outerHeight(a[d].height);this.descriptor.update()});Firefly.editor.getEditorCanvas().scaleTool.update()})};Firefly.HistoryManager.addPropertiesEditAction=function(b,a,c){this.addChangeAction("edit",b,a,c)};
Firefly.HistoryManager.addMoveSelectedComponentLayerAction=function(b){var a=Firefly.editor.getEditorCanvas().scaleTool.targets;a.length==1&&this.addMoveLayerAction(a[0],b)};
Firefly.HistoryManager.addMoveLayerAction=function(b,a){function c(){var a=Firefly.editor.getEditorCanvas().components,d=a.indexOf(b),c=d+1;c<a.length&&Firefly.HistoryManager.add("edit",function(){b.view.insertBefore(a[d].view);a.splice(c,1);a.splice(d,0,b)},function(){b.view.insertAfter(a[c].view);a.splice(d,1);a.splice(c,0,b)})}function e(){var a=Firefly.editor.getEditorCanvas().components,d=a.indexOf(b),c=d-1;c>-1&&Firefly.HistoryManager.add("edit",function(){b.view.insertAfter(a[d].view);a.splice(c,
1);a.splice(d,0,b)},function(){b.view.insertBefore(a[c].view);a.splice(d,1);a.splice(c,0,b)})}function d(){var a=Firefly.editor.getEditorCanvas().components,d=Firefly.editor.getEditorCanvas().contentLayer,c=a.indexOf(b);c!=a.length-1&&Firefly.HistoryManager.add("edit",function(){b.view.insertBefore(a[c].view);a.pop();a.splice(c,0,b)},function(){b.view.appendTo(d);a.splice(c,1);a.push(b)})}function g(){var a=Firefly.editor.getEditorCanvas().components,d=Firefly.editor.getEditorCanvas().contentLayer,
c=a.indexOf(b);c>0&&Firefly.HistoryManager.add("edit",function(){b.view.insertAfter(a[c].view);a.shift();a.splice(c,0,b)},function(){b.view.prependTo(d);a.splice(c,1);a.unshift(b)})}switch(a){case "up":c();break;case "down":e();break;case "top":d();break;case "bottom":g()}};
Firefly.HistoryManager.addGroupAction=function(){var b=Firefly.editor.getEditorCanvas(),a=b.scaleTool;if(!(a.targets.length<=1)){var c=a.targets.concat(),e=a.getRectOfTargets(),d=e.x+b.view.offset().left,g=e.y+b.view.offset().top,d=b.globalToLocalPoint(new Firefly.Point(d,g)),g=b.scale,e=new Firefly.Rect(d.x,d.y,e.width/g,e.height/g),f,h=[];$.each(c,function(){var a=this;h.push({idx:-1,x:-1,y:-1,undo:function(){b.add(a);var c=b.components.length;this.idx>0&&this.idx<c-1&&(b.components.pop(),b.components.splice(this.idx,
0,a),a.view.insertBefore(b.components[this.idx].view));a.view.css("left",this.x);a.view.css("top",this.y)},redo:function(){this.idx=b.components.indexOf(a);this.x=parseInt(a.view.css("left"));this.y=parseInt(a.view.css("top"));b.remove(a)}})});this.add("group",function(){b.remove(f);var d=c.length;$.each(c,function(a){h[d-1-a].undo()});a.setTargets(c)},function(){f==void 0?(f=new Firefly.Group,f.moveTo(e.x,e.y),f.resizeTo(e.width,e.height)):(f.components.concat(),f.components=[],f.view.empty());b.add(f);
var d=[];$.each(c,function(){var a=parseInt(this.view.css("left"))-e.x,c=parseInt(this.view.css("top"))-e.y;d.push({x:a,y:c})});$.each(c,function(a){h[a].redo();f.addComponent(this,d[a].x,d[a].y)});a.setTargets([f])})}};
Firefly.HistoryManager.addBreakGroupAction=function(){var b=Firefly.editor.getEditorCanvas(),a=b.scaleTool,c,e,d=[];a.targets.length==1&&a.targets[0]instanceof Firefly.Group&&(c=a.targets[0],this.add("ungroup",function(){b.add(c);var g=b.components.length;e>0&&e<g-1&&(b.components.pop(),b.components.splice(e,0,c),c.view.insertBefore(b.components[e].view));g=c.components.concat();c.components=[];c.view.empty();var f=parseInt(c.view.css("left")),h=parseInt(c.view.css("top"));$.each(g,function(a){b.remove(this);
c.addComponent(this,d[a].x-f,d[a].y-h)});a.setTargets([c])},function(){e=b.components.indexOf(c);$.each(c.components,function(){var a=parseInt(c.view.css("left"))+parseInt(this.view.css("left")),b=parseInt(c.view.css("top"))+parseInt(this.view.css("top"));d.push({x:a,y:b})});b.remove(c);$.each(c.components,function(a){this.view.css("left",d[a].x);this.view.css("top",d[a].y);b.add(this)});a.setTargets(c.components)}))};Firefly.Clipboard={};Firefly.Clipboard.targets=[];Firefly.Clipboard.isCut=!1;Firefly.Clipboard.copy=function(){var b=Firefly.editor.getEditorCanvas().scaleTool.targets;if(!Firefly.ArrayUtil.equals(b,this.targets)&&b.length>0){var a=this.targets.concat(),c=this.isCut;Firefly.HistoryManager.add("copy",function(){Firefly.Clipboard.targets=a;Firefly.Clipboard.isCut=c},function(){Firefly.Clipboard.targets=b.concat();Firefly.Clipboard.isCut=!1})}};
Firefly.Clipboard.cut=function(){var b=Firefly.editor.getEditorCanvas().scaleTool.targets;if(b.length>0){var a=this.targets.concat(),c=Firefly.editor.getEditorCanvas().scaleTool.targets.concat(),e=this.isCut;Firefly.HistoryManager.add("cut",function(){$.each(Firefly.Clipboard.targets,function(){Firefly.editor.getEditorCanvas().add(this)});Firefly.Clipboard.targets=a;Firefly.editor.getEditorCanvas().scaleTool.setTargets(c);Firefly.Clipboard.isCut=e},function(){Firefly.Clipboard.targets=b.concat();
$.each(Firefly.Clipboard.targets,function(){Firefly.editor.getEditorCanvas().remove(this)});Firefly.editor.getEditorCanvas().scaleTool.setTargets([]);Firefly.Clipboard.isCut=!0})}};
Firefly.Clipboard.paste=function(){if(this.targets.length>0&&this.isCut){var b=Firefly.Clipboard.targets.concat(),a=Firefly.editor.getEditorCanvas().scaleTool.targets.concat();Firefly.HistoryManager.add("paste",function(){$.each(b,function(){Firefly.editor.getEditorCanvas().remove(this)});Firefly.editor.getEditorCanvas().scaleTool.setTargets(a);Firefly.Clipboard.targets=b;Firefly.Clipboard.isCut=!0},function(){$.each(Firefly.Clipboard.targets,function(){Firefly.editor.getEditorCanvas().add(this)});
Firefly.editor.getEditorCanvas().scaleTool.setTargets(Firefly.Clipboard.targets);Firefly.Clipboard.targets=[];Firefly.Clipboard.isCut=!1})}else if(this.targets.length>0&&!this.isCut){var c=[],e=!1,a=Firefly.editor.getEditorCanvas().scaleTool.targets.concat();Firefly.HistoryManager.add("paste",function(){$.each(c,function(){Firefly.editor.getEditorCanvas().remove(this)});Firefly.editor.getEditorCanvas().scaleTool.setTargets(a)},function(){$.each(Firefly.Clipboard.targets,function(a){e?a=c[a]:(a=this.clone(),
c.push(a));Firefly.editor.getEditorCanvas().add(a)});Firefly.editor.getEditorCanvas().scaleTool.setTargets(c);e=!0})}};Firefly.DragItem=function(b,a){this.view=$("<div class='dragItem'></div>");this.img=$("<img>",{src:b});this.img.appendTo(this.view);a!=void 0&&(this.view.outerWidth(a.width),this.view.outerHeight(a.height),this.img.css("max-width",a.width-10),this.img.css("max-height",a.height-10));this.getSnapshot=function(){var a=$("<div class='dragItemSnapshot'></div>");this.img.clone().appendTo(a);return a};this.setTip=function(a){this.view.attr("data-content",a);this.view.attr("data-variation","mini");this.view.popup({position:"bottom center"})}};Firefly.ColorPicker=function(b,a){var c=this;this.view=a;if(this.view==void 0)this.view=$('<div class="colorPicker"><div class="box"></div></div>');var e=this.view.find(".box");this.view.colpick({flat:!1,layout:"hex",submit:1,onChange:function(a,b){var e;if(c.onChange!=void 0)c.onChange("#"+b)},onSubmit:function(a,b){var f="#"+b;e.css("background-color",f);if(c.onSubmit!=void 0)c.onSubmit(f)},color:b});e.css("background-color",b);this.setColor=function(a){e.css("background-color",a);this.view.colpickSetColor(a)}};Firefly.Dropdown=function(b,a){var c=this;this.view=Firefly.FormViewManager.createDropdownView(b,a);this.dropdown=this.view.find(".ui.dropdown");this.fireChangeEvent=!0;this.dropdown.dropdown({onChange:function(a,d,b){if(c.onChange!=void 0&&c.fireChangeEvent)c.onChange(a,d,b)}});this.setValue=function(a){this.fireChangeEvent=!1;this.dropdown.dropdown("set selected",a.toString());this.fireChangeEvent=!0}};Firefly.EditorCanvas=function(b){var a=this;this.size={width:960,height:540};this.scale=1;var c=[0.06,0.12,0.25,0.5,0.66,1,2,3,4,8,16,32,64],e=5;this.view=$("<div style='position:absolute;'></div>");this.view.outerWidth(this.size.width);this.view.outerHeight(this.size.height);this.view.appendTo(b);this.view.css("background-color","#FFFFFF");this.components=[];this.contentLayer=$("<div style='position:absolute;'></div>");this.contentLayer.appendTo(this.view);this.overLayer=$("<div style='position:absolute;'></div>");
this.overLayer.appendTo(this.view);this.topLayer=$("<div style='position:absolute;'></div>");this.topLayer.appendTo(this.view);this.scaleTool=new Firefly.ScaleTool(this);this.scaleTool.view.appendTo(this.overLayer);this.alignManager=new Firefly.AlignManager(this);this.enableAutoAlign=!0;this.descriptor=new Firefly.EditorCanvasDescriptor(this);(function(){var c=new Firefly.SelectBox;c.view.appendTo(a.topLayer);b.mousedown(function(b){function e(a){a.preventDefault();var b=a.clientX-l.x,g=a.clientY-
l.y;b>=0?(c.view.offset({left:l.x}),c.view.outerWidth(b)):(c.view.offset({left:a.clientX}),c.view.outerWidth(-b));g>=0?(c.view.offset({top:l.y}),c.view.outerHeight(g)):(c.view.offset({top:a.clientY}),c.view.outerHeight(-g))}function h(){for(var b=[],g=new Firefly.Rect(c.view.position().left,c.view.position().top,c.view.outerWidth(),c.view.outerHeight()),l=0;l<a.components.length;l++){var p=a.components[l].view.position().left,r=a.components[l].view.position().top,s=a.components[l].view.outerWidth()*
a.scale,q=a.components[l].view.outerHeight()*a.scale,p=new Firefly.Rect(p,r,s,q);Firefly.Rect.testRectCross(g,p)&&b.push(a.components[l])}Firefly.HistoryManager.addSelectAction(k,b);$(document).unbind("mousemove",e);$(document).unbind("mouseup",h);c.view.hide()}b.preventDefault();$(document).bind("mousemove",e);$(document).bind("mouseup",h);var k=a.scaleTool.targets.concat();a.scaleTool.setTargets([]);var l={x:b.clientX,y:b.clientY};c.view.show();c.view.outerWidth(0);c.view.outerHeight(0);c.view.offset({left:l.x,
top:l.y})})})();this.add=function(c){c.view.appendTo(this.contentLayer);this.components.push(c);c.view.mousedown(function(b){function e(c){c.preventDefault();p||(p=!0);var b={x:c.clientX-m.client.x,y:c.clientY-m.client.y},c=m.scaleToolPos.x+b.x,b=m.scaleToolPos.y+b.y;if(a.enableAutoAlign)b=a.alignManager.update({x:c,y:b}),c=b.x,b=b.y;a.scaleTool.moveTo(c,b)}function h(){$(document).unbind("mousemove",e);$(document).unbind("mouseup",h);a.enableAutoAlign&&a.alignManager.clear();if(p){var c=a.scaleTool.targets.concat(),
b=k();Firefly.HistoryManager.addMoveAction(c,o,b)}}function k(){var c=[];$.each(a.scaleTool.targets,function(){var a=parseInt(this.view.css("left")),b=parseInt(this.view.css("top"));c.push({left:a,top:b})});return c}b.preventDefault();b.stopImmediatePropagation();var l=a.scaleTool.targets.concat(),n;if(a.scaleTool.targets.indexOf(c)<0)b.shiftKey?(n=l.concat(),n.push(c)):n=[c],Firefly.HistoryManager.addSelectAction(l,n);else if(b.shiftKey){n=l.concat();b=n.indexOf(c);n.splice(b,1);Firefly.HistoryManager.addSelectAction(l,
n);return}$(document).bind("mousemove",e);$(document).bind("mouseup",h);var m={client:{x:b.clientX,y:b.clientY},scaleToolPos:{x:a.scaleTool.view.position().left,y:a.scaleTool.view.position().top}},o=k(),p=!1})};this.remove=function(a){this.components.splice(this.components.indexOf(a),1);a.view.remove()};this.toXmlNode=function(){var a=$("<div>");a.width(this.descriptor.getWidth());a.height(this.descriptor.getHeight());a.css("background-color",this.descriptor.getColor());a.attr("ff-type","EditorCanvas");
return a};this.globalToLocalPoint=function(a){var c=a.x-this.view.offset().left,a=a.y-this.view.offset().top;c/=this.scale;a/=this.scale;return new Firefly.Point(c,a)};this.globalToLocalRect=function(a){var c=this.globalToLocalPoint(new Firefly.Point(a.x,a.y));return new Firefly.Rect(c.x,c.y,a.width/this.scale,a.height/this.scale)};this.localToGlobalPoint=function(a){var c=a.x,a=a.y;c*=this.scale;a*=this.scale;c+=this.view.offset().left;a+=this.view.offset().top;return new Firefly.Point(c,a)};this.localToGlobalRect=
function(a){var c=this.localToGlobalPoint(new Firefly.Point(a.x,a.y));return new Firefly.Rect(c.x,c.y,a.width*this.scale,a.height*this.scale)};this.zoomToLevel=function(a,b){a!=e&&(this.zoom({to:c[a],point:b}),Firefly.topMenu.zoomMenuController.selectValue(a),e=a)};this.zoom=function(a){var b;if(a.delta!=void 0){var f=a.delta;b=a.point;a=e+f;a=a<0?0:a;a=a>c.length-1?c.length-1:a;this.zoomToLevel(a,b)}else if(a.to!=void 0)b=a.point,b==void 0&&(b=this.view.offset().left+this.view.outerWidth()*0.5,f=
this.view.offset().top+this.view.outerHeight()*0.5,b=new Firefly.Point(b,f)),b=this.globalToLocalPoint(b),targetScale=a.to,a=Firefly.editor.view.scrollLeft(),f=Firefly.editor.view.scrollTop(),this.contentLayer.css("-webkit-transform","scale("+targetScale+")"),this.view.outerWidth(this.size.width*targetScale),this.view.outerHeight(this.size.height*targetScale),Firefly.editor.updateSize(),a+=(targetScale-this.scale)*b.x,f+=(targetScale-this.scale)*b.y,Firefly.editor.view.scrollLeft(a),Firefly.editor.view.scrollTop(f),
this.scale=targetScale,this.scaleTool.update()}};Firefly.Editor=function(b){function a(){var a=e.view.outerWidth()+1E3,g=e.view.outerHeight()+1E3,a=a>b.outerWidth()?a:b.outerWidth(),g=g>b.outerHeight()?g:b.outerHeight();c.outerWidth(a);c.outerHeight(g);a=(a-e.view.outerWidth())*0.5;g=(g-e.view.outerHeight())*0.5;e.view.css("left",a);e.view.css("top",g)}this.view=$("<div style='position:absolute;'></div>");this.view.outerWidth("100%");this.view.outerHeight("100%");this.view.css("overflow","auto");this.view.appendTo(b);var c=$("<div style='position:absolute;'></div>");
c.appendTo(this.view);var e=new Firefly.EditorCanvas(c);this.getEditorCanvas=function(){return e};this.scrollToCenter=function(){this.view.scrollTop((c.outerHeight()-b.outerHeight())*0.5);this.view.scrollLeft((c.outerWidth()-b.outerWidth())*0.5)};this.updateSize=function(){a()};this.testDragDrop=function(a){return(new Firefly.Rect(b.offset().left,b.offset().top,b.outerWidth(),b.outerHeight())).contain(a)};this.globalToLocalPoint=function(a){return e.globalToLocalPoint(a)};this.runCmd=function(a){function c(){var b=
new Firefly.Image(a.src);e.add(b);b.moveTo(a.x,a.y)}switch(a.cmd){case "create":switch(a.type){case "Image":c();break;default:$(document).trigger(Firefly.Event.UnHandledCommand,a)}}};this.exportSource=function(){var a=$("<div>"),c=e.toXmlNode();c.appendTo(a);$.each(e.components,function(){this.toXmlNode().appendTo(c)});return a.html()};this.checkSource=function(a){var c=!0,b;try{b=$(a);if(b.attr("ff-type")==void 0||b.attr("ff-type")!="EditorCanvas")return c=!1;b.children().each(function(){$(this).attr("ff-type")==
void 0&&(c=!1)})}catch(e){c=!1}return c};this.importSource=function(a){for(a=$(a);e.components.length>0;)e.remove(e.components[0]);Firefly.HistoryManager.removeAll();e.zoomToLevel(5);e.descriptor.setWidth(a.width());e.descriptor.setHeight(a.height());var c=a.css("background-color"),c=Firefly.Color.getCSSHexColor(c);e.descriptor.setColor(c);Firefly.editor.getEditorCanvas().scaleTool.setTargets([]);a.children().each(function(){var a=$(this).attr("ff-type"),a=Firefly[a].create($(this));e.add(a)});this.scrollToCenter()};
$(window).resize(a);a();this.scrollToCenter()};Firefly.ScaleTool=function(b){function a(a){this.direction=a;var c={width:10,height:10},b=this,f={"left-up":"nw-resize","right-up":"ne-resize","left-down":"sw-resize","right-down":"se-resize","left-middle":"w-resize","right-middle":"e-resize","up-middle":"n-resize","down-middle":"s-resize"};this.view=$("<div class='controlBtn'><div class='circle'></div>");this.view.css("cursor",f[a]);this.onDrag=function(a,c,b){this.dragStart=a;this.dragMove=c;this.dragEnd=b};this.view.mousedown(function(h){function k(h){function f(){var a=
{width:m.width,height:m.height};a.width=m.width<0?0:m.width;a.height=m.height<0?0:m.height;var a=a.width/a.height<b.rect.width/b.rect.height?a.width/b.rect.width:a.height/b.rect.height,e=b.rect.width<b.rect.height?c.width/b.rect.width:c.height/b.rect.height,a=a<e?e:a;return{width:b.rect.width*a,height:b.rect.height*a}}function l(){var a={width:m.width,height:m.height};a.width=m.width<c.width?c.width:m.width;a.height=m.height<c.height?c.height:m.height;return a}var k={x:h.clientX-n.x,y:h.clientY-n.y},
q,t;switch(a){case "left-up":m.width=b.rect.width-k.x;m.height=b.rect.height-k.y;k=h.shiftKey?f():l();q=b.rect.width-k.width;t=b.rect.height-k.height;break;case "left-down":m.width=b.rect.width-k.x;m.height=b.rect.height+k.y;k=h.shiftKey?f():l();q=b.rect.width-k.width;t=k.height;break;case "right-up":m.width=b.rect.width+k.x;m.height=b.rect.height-k.y;k=h.shiftKey?f():l();q=k.width;t=b.rect.height-k.height;break;case "right-down":m.width=b.rect.width+k.x;m.height=b.rect.height+k.y;k=h.shiftKey?f():
l();q=k.width;t=k.height;break;case "left-middle":m.width=b.rect.width-k.x;k=l();q=b.rect.width-k.width;break;case "right-middle":m.width=b.rect.width+k.x;k=l();q=k.width;break;case "up-middle":m.height=b.rect.height-k.y;k=l();t=b.rect.height-k.height;break;case "down-middle":m.height=b.rect.height+k.y,k=l(),t=k.height}b.view.css("left",q);b.view.css("top",t);b.dragMove!=void 0&&b.dragMove(h)}function l(a){b.view.removeClass("selected");$(document).unbind("mousemove",k);$(document).unbind("mouseup",
l);$(document.body).css("cursor","auto");b.dragEnd!=void 0&&b.dragEnd(a)}h.preventDefault();h.stopImmediatePropagation();b.view.addClass("selected");$(document).bind("mousemove",k);$(document).bind("mouseup",l);$(document.body).css("cursor",f[a]);var n={x:h.clientX,y:h.clientY},m={width:b.rect.width,height:b.rect.height};b.dragStart!=void 0&&b.dragStart(h)});this.setPosForRect=function(c){this.rect=c;var b,d;switch(a){case "left-up":d=b=0;break;case "right-up":b=c.width;d=0;break;case "left-down":b=
0;d=c.height;break;case "right-down":b=c.width;d=c.height;break;case "left-middle":b=0;d=c.height*0.5;break;case "right-middle":b=c.width;d=c.height*0.5;break;case "up-middle":b=c.width*0.5;d=0;break;case "down-middle":b=c.width*0.5,d=c.height}this.view.css("left",b);this.view.css("top",d)}}var c=this;this.targets=[];this.view=$("<div class='scaleTool'></div>");this.box=$("<div class='box'></div>");this.box.appendTo(this.view);this.descriptor=new Firefly.MultipleSelectDescriptor(this);this.controlBtns=
function(){function b(){o=!1;l=new Firefly.Rect(c.view.position().left,c.view.position().top,c.box.outerWidth(),c.box.outerHeight());m=c.getInitLayouts(l);p=c.getTargetsTransform()}function d(){if(!o){o=!0;for(var a=0;a<c.targets.length;a++){var b=c.targets[a];b.getAutoSize()&&(!b.lockWidth||!b.lockHeight)&&b.setAutoSize(!1)}}b=this.view.position().left;a=this.view.position().top;switch(this.direction){case "left-up":c.controlBtns["left-middle"].view.css("left",b);c.controlBtns["left-down"].view.css("left",
b);b=(c.controlBtns["right-middle"].view.position().left-b)*0.5+b;c.controlBtns["up-middle"].view.css("left",b);c.controlBtns["down-middle"].view.css("left",b);var d=(c.controlBtns["down-middle"].view.position().top-a)*0.5+a;c.controlBtns["left-middle"].view.css("top",d);c.controlBtns["right-middle"].view.css("top",d);c.controlBtns["up-middle"].view.css("top",a);c.controlBtns["right-up"].view.css("top",a);break;case "right-up":c.controlBtns["left-up"].view.css("top",a);c.controlBtns["up-middle"].view.css("top",
a);c.controlBtns["right-middle"].view.css("left",b);c.controlBtns["right-down"].view.css("left",b);b*=0.5;d=(c.controlBtns["down-middle"].view.position().top-a)*0.5+a;c.controlBtns["up-middle"].view.css("left",b);c.controlBtns["down-middle"].view.css("left",b);c.controlBtns["left-middle"].view.css("top",d);c.controlBtns["right-middle"].view.css("top",d);break;case "left-down":c.controlBtns["left-up"].view.css("left",b);c.controlBtns["left-middle"].view.css("left",b);c.controlBtns["down-middle"].view.css("top",
a);c.controlBtns["right-down"].view.css("top",a);b=(c.controlBtns["right-middle"].view.position().left-b)*0.5+b;d=a*0.5;c.controlBtns["up-middle"].view.css("left",b);c.controlBtns["down-middle"].view.css("left",b);c.controlBtns["left-middle"].view.css("top",d);c.controlBtns["right-middle"].view.css("top",d);break;case "right-down":c.controlBtns["right-up"].view.css("left",b);c.controlBtns["right-middle"].view.css("left",b);c.controlBtns["left-down"].view.css("top",a);c.controlBtns["down-middle"].view.css("top",
a);b*=0.5;d=a*0.5;c.controlBtns["up-middle"].view.css("left",b);c.controlBtns["down-middle"].view.css("left",b);c.controlBtns["left-middle"].view.css("top",d);c.controlBtns["right-middle"].view.css("top",d);break;case "left-middle":c.controlBtns["left-up"].view.css("left",b);c.controlBtns["left-down"].view.css("left",b);b=(c.controlBtns["right-middle"].view.position().left-b)*0.5+b;c.controlBtns["up-middle"].view.css("left",b);c.controlBtns["down-middle"].view.css("left",b);break;case "right-middle":c.controlBtns["right-up"].view.css("left",
b);c.controlBtns["right-down"].view.css("left",b);b*=0.5;c.controlBtns["up-middle"].view.css("left",b);c.controlBtns["down-middle"].view.css("left",b);break;case "up-middle":c.controlBtns["left-up"].view.css("top",a);c.controlBtns["right-up"].view.css("top",a);d=(c.controlBtns["down-middle"].view.position().top-a)*0.5+a;c.controlBtns["left-middle"].view.css("top",d);c.controlBtns["right-middle"].view.css("top",d);break;case "down-middle":c.controlBtns["left-down"].view.css("top",a),c.controlBtns["right-down"].view.css("top",
a),d=a*0.5,c.controlBtns["left-middle"].view.css("top",d),c.controlBtns["right-middle"].view.css("top",d)}a=new Firefly.Rect(c.controlBtns["left-up"].view.position().left,c.controlBtns["left-up"].view.position().top,c.controlBtns["right-up"].view.position().left-c.controlBtns["left-up"].view.position().left,c.controlBtns["left-down"].view.position().top-c.controlBtns["left-up"].view.position().top);c.box.css("left",a.x);c.box.css("top",a.y);c.box.outerWidth(a.width);c.box.outerHeight(a.height);n=
new Firefly.Rect(c.view.position().left+a.x,c.view.position().top+a.y,a.width,a.height);c.resizeTargets(m,n);c.descriptor.update()}function g(){c.view.offset(c.box.offset());c.box.css("left",0);c.box.css("top",0);c.update();if(o){var a=c.getTargetsTransform(),b=c.targets.concat();Firefly.HistoryManager.addScaleSelectedComponentsAction(b,p,a)}}for(var f={},h=["left-up","right-up","left-down","right-down","left-middle","right-middle","up-middle","down-middle"],k=h.length,l,n,m,o,p,r=0;r<k;r++){var s=
new a(h[r]);f[h[r]]=s;s.view.appendTo(c.view);s.onDrag(b,d,g)}return f}();this.view.hide();this.setTargets=function(a){this.targets=a;a.length==0?this.view.hide():(this.view.show(),this.update());Firefly.propertiesPanel.setTargets(a)};this.update=function(){if(this.targets.length!=0){var a=this.getRectOfTargets();this.view.css("left",a.x);this.view.css("top",a.y);this.box.outerWidth(a.width);this.box.outerHeight(a.height);(function(){var b={none:[],all:["left-up","right-up","left-down","right-down",
"left-middle","right-middle","up-middle","down-middle"],width:["left-middle","right-middle"],height:["up-middle","down-middle"]},g=b.all;if(c.targets.length==1){var f=c.targets[0];if(f.getAutoSize()||f.lockWidth&&f.lockHeight)g=b.none;else if(f.lockWidth&&!f.lockHeight)g=b.height;else if(!f.lockWidth&&f.lockHeight)g=b.width}for(direction in c.controlBtns)b=c.controlBtns[direction],b.setPosForRect(a),g.indexOf(direction)>-1?(b.view.css("pointer-events","auto"),b.view.css("opacity",1)):(b.view.css("pointer-events",
"none"),b.view.css("opacity",0))})();this.descriptor.update()}};this.getRectOfTargets=function(){var a,c,g,f;f=this.targets[0];a=f.view.position().left;c=f.view.position().top;var h=b.scale;g=a+f.view.outerWidth()*h;f=c+f.view.outerHeight()*h;if(this.targets.length>1)for(var k=1;k<this.targets.length;k++){var l=this.targets[k].view.position().left,n=this.targets[k].view.position().top,m=l+this.targets[k].view.outerWidth()*h,o=n+this.targets[k].view.outerHeight()*h;a=a>l?l:a;c=c>n?n:c;g=g<m?m:g;f=
f<o?o:f}return new Firefly.Rect(a,c,g-a,f-c)};this.moveTo=function(a,c){var g={},a=a==void 0?this.view.position().left:a,c=c==void 0?this.view.position().top:c;g.x=a-this.view.position().left;g.y=c-this.view.position().top;this.view.css("left",a);this.view.css("top",c);for(var f=0;f<this.targets.length;f++){var h=this.targets[f].view.position().left+g.x,k=this.targets[f].view.position().top+g.y;h+=b.view.offset().left;k+=b.view.offset().top;k=b.globalToLocalPoint(new Firefly.Point(h,k));this.targets[f].moveTo(k.x,
k.y)}this.descriptor.update()};this.resizeTo=function(a,b){var a=a==void 0?this.box.outerWidth():a,b=b==void 0?this.box.outerHeight():b,c=new Firefly.Rect(this.view.position().left,this.view.position().top,this.box.outerWidth(),this.box.outerHeight()),f=new Firefly.Rect(c.x,c.y,a,b);this.resizeTargets(c,f);this.box.outerWidth(a);this.box.outerHeight(b)};this.getInitLayouts=function(a){for(var d=[],g=b.scale,f=0;f<this.targets.length;f++){var h=c.targets[f];d.push({x:(h.view.position().left-a.x)/a.width,
y:(h.view.position().top-a.y)/a.height,w:h.view.outerWidth()*g/a.width,h:h.view.outerHeight()*g/a.height,left:h.view.position().left-a.x,right:a.x+a.width-h.view.position().left-h.view.outerWidth()*g,top:h.view.position().top-a.y,down:a.y+a.height-h.view.position().top-h.view.outerHeight()*g})}return d};this.resizeTargets=function(a,d){var g=b.scale,f;f=a instanceof Firefly.Rect?this.getInitLayouts(a):a;for(var h=0;h<this.targets.length;h++){var k=c.targets[h],l=f[h],n=d.x+d.width*l.x,m=d.y+d.height*
l.y,o=d.width*l.w,p=d.height*l.h;k.lockWidth&&(n=l.left==0?d.x:n,n=l.right==0?d.x+d.width-k.view.outerWidth()*g:n,n=n+k.view.outerWidth()*g<d.x+d.width?n:d.x+d.width-k.view.outerWidth()*g,n=n>d.x?n:d.x);k.lockHeight&&(m=l.top==0?d.y:m,m=l.down==0?d.y+d.height-k.view.outerHeight()*g:m,m=m+k.view.outerHeight()*g<d.y+d.height?m:d.y+d.height-k.view.outerHeight()*g,m=m>d.y?m:d.y);l=n+b.view.offset().left;m+=b.view.offset().top;m=b.globalToLocalPoint(new Firefly.Point(l,m));k.moveTo(m.x,m.y);k.resizeTo(o/
g,p/g)}};this.getTargetsTransform=function(){var a=[];$.each(this.targets,function(){var b=parseInt(this.view.css("left")),c=parseInt(this.view.css("top")),f=this.view.outerWidth(),h=this.view.outerHeight();a.push({left:b,top:c,width:f,height:h})});return a}};Firefly.AlignManager=function(b){function a(){e.lineX!=void 0&&e.lineX.remove()}function c(){e.lineY!=void 0&&e.lineY.remove()}var e=this;this.fix=5;this.update=function(d){var g=d.y,f,d=d.x,h=b.scaleTool.box.outerWidth(),k=[d,d+h*0.5,d+h],h=b.view.width(),h=[0,h*0.5,h],l=b.scale;for(i=0;i<b.components.length;i++)if(b.scaleTool.targets.indexOf(b.components[i])==-1)var n=b.components[i].view.position().left,m=b.components[i].view.outerWidth()*l,h=h.concat([n,n+m*0.5,n+m]);for(i=0;i<k.length;i++){for(j=
0;j<h.length;j++)if(Math.abs(k[i]-h[j])<e.fix){f=[i,j];break}if(f!=void 0)break}if(f!=void 0){d=h[f[1]];if(e.lineX==void 0)e.lineX=$("<div style='position:absolute;border-left:dashed 1px #FF0000;width:0px;'></div>");e.lineX.css("height",b.view.height());e.lineX.appendTo(b.overLayer);e.lineX.css("left",d);d=f[0];f=h[f[1]];d!=0&&(d==1?f-=b.scaleTool.box.outerWidth()*0.5:d==2&&(f-=b.scaleTool.box.outerWidth()));d=f}else a();f=d;d=b.scaleTool.box.outerHeight();h=[g,g+d*0.5,g+d];d=b.view.height();d=[0,
d*0.5,d];k=b.scale;for(i=0;i<b.components.length;i++)if(b.scaleTool.targets.indexOf(b.components[i])==-1)l=b.components[i].view.position().top,n=b.components[i].view.outerHeight()*k,d=d.concat([l,l+n*0.5,l+n]);var o;for(i=0;i<h.length;i++){for(j=0;j<d.length;j++)if(Math.abs(h[i]-d[j])<e.fix){o=[i,j];break}if(o!=void 0)break}if(o!=void 0){g=d[o[1]];if(e.lineY==void 0)e.lineY=$("<div style='position:absolute;border-top:dashed 1px #FF0000;height:0px;'></div>");e.lineY.css("width",b.view.width());e.lineY.appendTo(b.overLayer);
e.lineY.css("top",g);g=o[0];o=d[o[1]];g!=0&&(g==1?o-=b.scaleTool.box.outerHeight()*0.5:g==2&&(o-=b.scaleTool.box.outerHeight()));g=o}else c();return{x:f,y:g}};this.clear=function(){a();c()}};Firefly.SelectBox=function(){this.view=$('<div style="position:absolute;border: solid 1px #0000ff;"></div>');this.view.hide()};Firefly.ResourcePanel=function(){function b(a){function b(c){var g=a.getIconUrl(f[c]),l=new Firefly.DragItem(g,a.item);l.view.appendTo(d);l.view.mousedown(function(){function b(a){a.preventDefault();g||(g=!0,k=l.getSnapshot(),k.offset({left:a.clientX,top:a.clientY}),k.appendTo("body"));k!=void 0&&k.offset({left:a.clientX,top:a.clientY})}function d(){k!=void 0&&(a.onSnapshotDrop(f[c],k),k.remove());$(document).unbind("mousemove",b);$(document).unbind("mouseup",d)}e(l);$(document).bind("mousemove",
b);$(document).bind("mouseup",d);var g=!1,k});if(a.onItemCreate!=void 0)a.onItemCreate(f[c],l)}function e(a){g!=void 0&&g.view.removeClass("selected");g=a;a.view.addClass("selected")}var d=a.view,g,f;$.getJSON(a.listUrl,function(d){f=d;for(var d=f.length,e=0;e<d;e++)new b(e);if(a.onItemsCreateComplete!=void 0)a.onItemsCreateComplete()})}new function(){var a={view:$("#componentContainer"),listUrl:"componentLib/list.json",getIconUrl:function(a){return"componentLib/"+a+"/icon.png"},onSnapshotDrop:function(a,
b){var d=new Firefly.Point(b.offset().left,b.offset().top);if(Firefly.editor.testDragDrop(d)){var g={cmd:"create",type:a},d=Firefly.editor.globalToLocalPoint(d);g.x=d.x;g.y=d.y;Firefly.HistoryManager.addComponentAction(g)}},item:{width:50,height:50},onItemCreate:function(a,b){b.view.css("pointer-events","none");b.view.css("opacity",0.5);Firefly.ComponentManager.append(a,function(a){b.view.css("pointer-events","auto");b.view.css("opacity",1);b.setTip(a.desc)})},onItemsCreateComplete:function(){Firefly.ComponentManager.startLoad()}};
b.call(this,a)};new function(){var a={view:$("#photoContainer"),listUrl:"photoLib/list.json",getIconUrl:function(a){return"photoLib/"+a},onSnapshotDrop:function(a,b){var d=new Firefly.Point(b.offset().left,b.offset().top),g="photoLib/"+a;if(Firefly.editor.testDragDrop(d))g={cmd:"create",type:"Image",src:g},d=Firefly.editor.globalToLocalPoint(d),g.x=d.x,g.y=d.y,Firefly.HistoryManager.addComponentAction(g)}};b.call(this,a)}};
Firefly.ComponentManager={loadItems:[],loadComponent:function(b,a){$.getJSON("componentLib/"+b+"/config.json",function(c){function e(){$.getScript("componentLib/"+b+"/"+c.require[d],function(){d++;d==c.require.length?a(c):e(d)})}if(c.require.length==0)a(c);else{var d=0;e()}})},append:function(b,a){this.loadItems.push({dir:b,onComplete:a})},startLoad:function(b){function a(e){var d=c.loadItems[e];c.loadComponent(d.dir,function(g){d.onComplete(g);e++;e<c.loadItems.length?a(e):b!=void 0&&b()})}var c=
this;a(0)}};Firefly.PropertiesPanel=function(){this.view=$("#propertiesPanel");this.header=this.view.find("#header");this.form=this.view.find(".ui.form");this.layoutPanel=this.view.find("#layoutPanel");this.setTargets=function(b){this.clear();var a=b.length;a==0?Firefly.editor.getEditorCanvas().descriptor.init(this):a==1?b[0].descriptor.init(this):Firefly.editor.getEditorCanvas().scaleTool.descriptor.init(this)};this.clear=function(){this.view.find(".ui.dropdown").dropdown("hide");var b=$(document).find(".colpick.colpick_hex");
b.length>0&&b.each(function(){$(this).data("colpick").clear();$(this).remove()});this.header.text("");this.form.empty();this.layoutPanel.empty()};this.setTargets([])};Firefly.HistoryPanel=function(){function b(){var a=Firefly.HistoryManager.items.length,b=Firefly.HistoryManager.idx;a==0?(e.addClass("disabled"),d.addClass("disabled"),g.addClass("disabled")):(g.removeClass("disabled"),b==a-1?(d.addClass("disabled"),e.removeClass("disabled")):(b==-1?e.addClass("disabled"):e.removeClass("disabled"),d.removeClass("disabled")));f.empty();a=Firefly.HistoryManager.items.length;if(a==0)f.text("\u6ca1\u6709\u4efb\u4f55\u5386\u53f2\u8bb0\u5f55");else for(var b=[],c=Firefly.HistoryManager.idx,
n=0;n<a;n++){var m=new Firefly.HistoryItemView(Firefly.HistoryManager.items[n]);m.view.prependTo(f);b.push(m);n==c&&b[n].view.addClass("active")}}var a=$("#historyPanel"),c=a.find(".ui.tab.segment .menu .item"),e=c.eq(0),d=c.eq(1),g=c.eq(2),f=a.find(".ui.tab.segment .list");b();e.click(function(){Firefly.HistoryManager.undo()});d.click(function(){Firefly.HistoryManager.redo()});g.click(function(){Firefly.HistoryManager.removeAll()});$(document).bind(Firefly.HistoryManager.UPDATE,b);this.getUndoAble=
function(){return!e.hasClass("disabled")};this.getRedoAble=function(){return!d.hasClass("disabled")}};
Firefly.HistoryItemView=function(b){var a={"new":{icon:"add circle icon",label:"\u6dfb\u52a0\u4e86\u7ec4\u4ef6"},del:{icon:"trash icon",label:"\u5220\u9664\u4e86\u7ec4\u4ef6"},select:{icon:"check circle icon",label:"\u9009\u62e9\u4e86\u7ec4\u4ef6"},unselect:{icon:"circle thin icon",label:"\u53d6\u6d88\u4e86\u9009\u62e9"},move:{icon:"move icon",label:"\u79fb\u52a8\u4e86\u7ec4\u4ef6"},scale:{icon:"expand icon",label:"\u7f29\u653e\u4e86\u7ec4\u4ef6"},edit:{icon:"edit icon",label:"\u7f16\u8f91\u4e86\u7ec4\u4ef6"},
copy:{icon:"copy icon",label:"\u590d\u5236\u4e86\u7ec4\u4ef6"},paste:{icon:"paste icon",label:"\u7c98\u8d34\u4e86\u7ec4\u4ef6"},cut:{icon:"cut icon",label:"\u526a\u5207\u4e86\u7ec4\u4ef6"},group:{icon:"iconfont icon-group icon",label:"\u7ec4\u6210\u4e86\u7fa4\u7ec4"},ungroup:{icon:"iconfont icon-ungroup icon",label:"\u89e3\u6563\u4e86\u7fa4\u7ec4"}};this.view=$('<div class="item"></div>');this.icon=$('<i class="'+a[b.type].icon+'"></i>');this.content=$('<div class="content"><div class="header">'+
a[b.type].label+"</div></div>");this.icon.appendTo(this.view);this.content.appendTo(this.view);this.view.click(function(){Firefly.HistoryManager.go(b)})};Firefly.ComponentBase=function(){this.view=$('<div style="width:100px; height:100px;position:absolute;"></div>');this.lockHeight=this.lockWidth=!1;this.descriptor=new Firefly.ComponentBaseDescriptor(this);this.moveTo=function(b,a){b!=void 0&&this.view.css("left",b);a!=void 0&&this.view.css("top",a);this.descriptor.update()};this.resizeTo=function(b,a){b!=void 0&&!this.lockWidth&&this.view.outerWidth(b);a!=void 0&&!this.lockHeight&&this.view.outerHeight(a);this.descriptor.update()};this.getAutoSize=
function(){return this.view.attr("ff-autoSize")=="true"?!0:!1};this.setAutoSize=function(b){this.view.attr("ff-autoSize",b?"true":"false");this.descriptor.update()};this.clone=function(){var b=new Firefly.ComponentBase;b.view=this.view.clone();return b};this.toXmlNode=function(){var b=this.view.clone();b.attr("ff-type","ComponentBase");return b}};Firefly.ComponentBase.create=function(b){var a=new Firefly.ComponentBase;a.view=b;return a};Firefly.ImageScaleMode={Stretch:0,Inside:1,Outside:2};
Firefly.Image=function(b){Firefly.ComponentBase.call(this);var a=this;this.img=$("<img>",{src:b,style:"position:absolute;"});this.view.css("overflow","hidden");this.descriptor=new Firefly.ImageDescriptor(this);this.view.attr("ff-autoSize","true");this.img.get(0).onload=function(){a.img.appendTo(a.view);a.setOriginSize(a.img.width(),a.img.height());a.view.outerWidth(a.img.width());a.view.outerHeight(a.img.height())};this.getOriginSize=function(){var a=this.view.attr("ff-originSize");a!=void 0&&(a=
a.split(","),a={width:a[0],height:a[1]});return a};this.setOriginSize=function(a,b){this.view.attr("ff-originSize",[a,b].join(","))};this.getScaleMode=function(){var a=this.view.attr("ff-scaleMode");return a=a==void 0?0:parseInt(a)};this.setScaleMode=function(a){this.view.attr("ff-scaleMode",a);var a=this.view.outerWidth(),b=this.view.outerHeight();this.resizeTo(a,b)};var c=this.setAutoSize;this.setAutoSize=function(a){a&&(this.view.outerWidth(this.getOriginSize().width),this.view.outerHeight(this.getOriginSize().height),
this.img.width(this.getOriginSize().width),this.img.height(this.getOriginSize().height),this.img.css("left",0),this.img.css("top",0));c.call(this,a)};var e=this.resizeTo;this.resizeTo=function(a,b){a=a==void 0?this.view.outerWidth():a;b=b==void 0?this.view.outerHeight():b;if(this.getScaleMode()==Firefly.ImageScaleMode.Stretch)this.img.width(a),this.img.height(b),this.img.css("left",0),this.img.css("top",0);else if(this.getScaleMode()==Firefly.ImageScaleMode.Inside){var c=a/this.getOriginSize().width<
b/this.getOriginSize().height?a/this.getOriginSize().width:b/this.getOriginSize().height;this.img.width(this.getOriginSize().width*c);this.img.height(this.getOriginSize().height*c);var c=(a-this.img.width())*0.5,h=(b-this.img.height())*0.5;this.img.css("left",c);this.img.css("top",h)}else this.getScaleMode()==Firefly.ImageScaleMode.Outside&&(c=a/this.getOriginSize().width>b/this.getOriginSize().height?a/this.getOriginSize().width:b/this.getOriginSize().height,this.img.width(this.getOriginSize().width*
c),this.img.height(this.getOriginSize().height*c),c=(a-this.img.width())*0.5,h=(b-this.img.height())*0.5,this.img.css("left",c),this.img.css("top",h));e.call(this,a,b)};this.clone=function(){var a=new Firefly.Image;a.view=this.view.clone();a.img=a.view.find("img").eq(0);return a};this.toXmlNode=function(){var a=this.view.clone();a.attr("ff-type","Image");return a}};Firefly.Image.create=function(b){var a=new Firefly.Image;a.view=b;a.img=a.view.find("img").eq(0);return a};Firefly.TopMenu=function(b){function a(){$.each(d,function(){this.update()})}function c(a){function b(){if(d!="")Firefly.KeyboardManager.execute(d);else switch(c){case "\u5bfc\u51fa":Firefly.KeyboardManager.execute("export");break;case "\u952e\u76d8\u5feb\u6377\u952e":Firefly.KeyboardManager.execute("showQuickKey");break;case "\u5173\u4e8eFirefly":Firefly.KeyboardManager.execute("about");break;case "\u5728\u7ebf\u6587\u4ef6":Firefly.KeyboardManager.execute("onlineFile")}}var c=a.find("span.text").eq(0).text();
a.find(".item").length==0&&a.click(b);var d=a.find("span.description").text();this.update=function(){var a=!0;switch(c){case "\u64a4\u6d88":a=Firefly.historyPanel.getUndoAble();break;case "\u91cd\u505a":a=Firefly.historyPanel.getRedoAble();break;case "\u5220\u9664":a=Firefly.editor.getEditorCanvas().scaleTool.targets.length>0;break;case "\u590d\u5236":a=Firefly.editor.getEditorCanvas().scaleTool.targets.length>0;break;case "\u526a\u5207":a=Firefly.editor.getEditorCanvas().scaleTool.targets.length>
0;break;case "\u7c98\u8d34":a=Firefly.Clipboard.targets.length>0;break;case "\u79fb\u52a8":a=Firefly.editor.getEditorCanvas().scaleTool.targets.length>0;break;case "\u7f6e\u9876":a=Firefly.editor.getEditorCanvas().scaleTool.targets.length==1;break;case "\u7f6e\u5e95":a=Firefly.editor.getEditorCanvas().scaleTool.targets.length==1;break;case "\u4e0a\u79fb\u4e00\u5c42":a=Firefly.editor.getEditorCanvas().scaleTool.targets.length==1;break;case "\u4e0b\u79fb\u4e00\u5c42":a=Firefly.editor.getEditorCanvas().scaleTool.targets.length==
1;break;case "\u5168\u9009":a=Firefly.editor.getEditorCanvas().components.length>0&&Firefly.editor.getEditorCanvas().components.length!=Firefly.editor.getEditorCanvas().scaleTool.targets.length;break;case "\u53cd\u9009":a=Firefly.editor.getEditorCanvas().components.length>0&&Firefly.editor.getEditorCanvas().components.length-Firefly.editor.getEditorCanvas().scaleTool.targets.length>0;break;case "\u53d6\u6d88\u9009\u62e9":a=Firefly.editor.getEditorCanvas().scaleTool.targets.length>0;break;case "\u5c5e\u6027\u9762\u677f":a=
Firefly.topMenu.panelMenuController.getSelectedValue()!="properties";break;case "\u5386\u53f2\u8bb0\u5f55":a=Firefly.topMenu.panelMenuController.getSelectedValue()!="history";break;case "\u7ec4\u6210\u7fa4\u7ec4":a=Firefly.editor.getEditorCanvas().scaleTool.targets.length>1;break;case "\u89e3\u6563\u7fa4\u7ec4":a=Firefly.editor.getEditorCanvas().scaleTool.targets.length==1&&Firefly.editor.getEditorCanvas().scaleTool.targets[0]instanceof Firefly.Group}this.setEnabled(a)};this.setEnabled=function(b){b?
a.removeClass("disabled"):a.addClass("disabled")}}this.view=$(b);b=this.view.find(".ui.dropdown:not(.right.menu .ui.dropdown)");b.dropdown({on:"hover",onShow:function(){a()}});var e=b.find(".item"),d=[];e.each(function(){d.push(new c($(this)))});this.zoomMenuController=new function(a){var b=[0.06,0.12,0.25,0.5,0.66,1,2,3,4,8,16,32,64];$.each(b,function(c){$('<a class="item" data-value="'+c+'">'+b[c]*100+"%</a>").appendTo(a.find(".menu").eq(0))});a.dropdown({onChange:function(a){Firefly.editor.getEditorCanvas().zoomToLevel(Number(a))}});
this.selectValue=function(c){a.dropdown("set text",b[c]*100+"%")};this.selectValue(5)}(this.view.find(".right.menu .ui.dropdown").eq(0));this.panelMenuController=new function(a){var b=this,c,d={properties:$("#propertiesPanel"),history:$("#historyPanel")};$.each(d,function(){$(this).css("display","none")});this.selectValue=function(a){c!=void 0&&d[c].css("display","none");c=a;d[c].css("display","block")};this.getSelectedValue=function(){return c};this.getMenu=function(){return a};this.selectValue("properties");
a.dropdown("set selected",c);a.dropdown({onChange:function(a){b.selectValue(a)}})}(this.view.find(".right.menu .ui.dropdown").eq(1));this.getItems=function(){return e}};Firefly.SettingWin=function(b){function a(a,b){this.setDisplay=function(c){a.css("display",c?"block":"none");b.css("display",c?"block":"none")}}var c=this;this.view=$(b);var e=this.view.find(".ui.menu .item"),b=this.view.find(".content").eq(0).children(),d=this.view.find(".actions").eq(0).children(),g=[new function(b,c){a.call(this,b,c);var d=this,e=b.find(".ui.checkbox"),f=b.find("input").eq(1),g=b.find("input").eq(2),p=c.find("button").eq(0);this.getEnableAlign=function(){return Firefly.editor.getEditorCanvas().enableAutoAlign};
this.setEnableAlign=function(a){Firefly.editor.getEditorCanvas().enableAutoAlign=a};this.getDis=function(){return Firefly.editor.getEditorCanvas().alignManager.fix};this.setDis=function(a){Firefly.editor.getEditorCanvas().alignManager.fix=a};this.getMaxHistory=function(){return Firefly.HistoryManager.maxLen};this.setMaxHistory=function(a){Firefly.HistoryManager.maxLen=a};this.initValues=function(){var a=this.getEnableAlign();e.checkbox(a?"set checked":"set unchecked");f.parent()[a?"removeClass":"addClass"]("disabled");
f.val(this.getDis());g.val(this.getMaxHistory())};this.initValues();e.checkbox({onChange:function(){var a=e.checkbox("is checked");f.parent()[a?"removeClass":"addClass"]("disabled")}});p.click(function(){var a=e.checkbox("is checked");d.setEnableAlign(a);d.setDis(f.val());d.setMaxHistory(g.val())})}(b.eq(0),d.eq(0)),new function(b,c){a.call(this,b,c);var d='<table class="ui celled table">';d+=" <thead><tr>";d+="  <th>\u5feb\u6377\u952e</th>";d+="  <th>\u8bf4\u660e</th>";d+=" </tr></thead>";d+=" <tbody>";
Firefly.topMenu.getItems().each(function(){if($(this).find(".item").length==0){var a=$(this).find("span.text").text(),b=$(this).find("span.description").text();b!=""&&(d+="<tr><td>"+b+"</td><td>"+a+"</td></tr>")}});d+=" </tbody>";d+="</table>";$(d).appendTo(b)}(b.eq(1),d.eq(1)),new function(b,c){a.call(this,b,c);var d=this,e=$("<audio>",{src:"assets/sounds/m01.m4a",loop:!0}),f=b.find(".icon.music");f.addClass("red");f.click(function(){f.toggleClass("red");f.hasClass("red")?d.playMusic():d.stopMusic()});
var g=this.setDisplay;this.setDisplay=function(a){g.call(this,a);b.parent().css("background-color",a?"#000000":"#ffffff");a?this.playMusic():this.stopMusic()};this.playMusic=function(){f.hasClass("red")&&e.get(0).play()};this.stopMusic=function(){e.get(0).pause();e.get(0).currentTime=0};var p='<div style="color:#999999;text-align: center;">'+Base64.decode("Qmxhbms=")+"</div>";p+='<div style="color:#999999;text-align: center;">'+Base64.decode("aGVyb2JsYW5rQGdtYWlsLmNvbQ==")+"</div>";$(p).appendTo(b)}(b.eq(2),
d.eq(2))],f=-1;e.each(function(a){$(this).click(function(){c.selectTabIdx(a)})});this.view.modal({onHide:function(){g[2].stopMusic()}});this.show=function(a){g[0].initValues();this.selectTabIdx(a);this.view.modal("show")};this.selectTabIdx=function(a){f>-1&&(e.eq(f).removeClass("active blue"),g[f].setDisplay(!1));e.eq(a).addClass("active blue");f=a;g[a].setDisplay(!0);this.view.modal("refresh")}};Firefly.Alert=function(){var b={},a=$("<div class='ui small modal'>");$("<div class='header'><i class='warning circle icon'></i><label>\u63d0\u793a</label></div>").appendTo(a);var c=$("<div class='content'>");c.appendTo(a);$("<div class='actions'>").appendTo(a);b.show=function(b){c.text(b);a.modal("show")};return b}();Firefly.InputWin=function(b){var a=$(b),c=a.find(".header i").eq(0),e=a.find(".header label").eq(0),d=a.find("input").eq(0),g=a.find(".right.labeled .label").eq(0),f=a.find(".actions button").eq(0),h;f.click(function(){f.addClass("disabled");a.modal("hide");h!=void 0&&h(d.val())});this.setOption=function(a){c.attr("class",a.icon);e.text(a.title);d.attr("placeholder",a.placeholder);g.text(a.rightlabel);f.text(a.submitLabel);d.val(a.value);h=a.onSubmit};this.show=function(b){this.setOption(b);f.removeClass("disabled");
a.modal("show")}};Firefly.OnlineFileWin=function(b){function a(a){var b='<div style="display:table;border: solid 1px #E3E3E3;float: left;margin-left: 10px;margin-top: 10px;width:160px;height:120px;padding:1px;">';b+='<div class="ui dimmer">';b+='<div class="content">';b+='<div class="center">';b+='<div class="ui button">\u7f16\u8f91\u6587\u4ef6</div>';b+="</div>";b+="</div>";b+="</div>";b+='<div style="display:table-cell;vertical-align: middle;text-align: center;width:100%;height:100%;font-size:25px;">'+a+"</div>";
b+="</div>";this.view=$(b);this.view.dimmer({on:"hover"});var d=this.view.find(".ui.dimmer .ui.button").eq(0);d.click(function(){c.openFile(a);d.addClass("disabled")});this.reset=function(){d.removeClass("disabled")}}var c=this,e=$(b),d=e.find(".content").eq(0),g=!1,f=[];this.show=function(){g?(this.reset(),e.modal("show")):($("#loadingMask").dimmer({closable:!1}),$("#loadingMask").find(".ui.text.loader").text("\u5217\u8868\u8bfb\u53d6\u4e2d..."),$("#loadingMask").dimmer("show"),$.getJSON("examples/list.json",
function(b){$("#loadingMask").dimmer("hide");for(var c=0;c<b.length;c++){var l=new a(b[c]);l.view.prependTo(d);f.push(l)}g=!0;e.modal("show")}))};this.reset=function(){for(var a=0;a<f.length;a++)f[a].reset()};this.openFile=function(a){e.modal("hide");a="examples/"+a;$("#loadingMask").dimmer({closable:!1});$("#loadingMask").find(".ui.text.loader").text("\u6570\u636e\u8bfb\u53d6\u4e2d...");$("#loadingMask").dimmer("show");$.get(a,function(a){$("#loadingMask").dimmer("hide");Firefly.editor.importSource(a)})}};Firefly.Group=function(){Firefly.ComponentBase.call(this);this.view.css("overflow","hidden");this.view.attr("ff-autoSize",!0);this.descriptor=new Firefly.GroupDescriptor(this);this.components=[];this.addComponent=function(a,b,e){this.components.push(a);a.view.css("left",b);a.view.css("top",e);a.view.appendTo(this.view)};var b=this.resizeTo;this.resizeTo=function(a,c){b.call(this,a,c)};this.clone=function(){var a=new Firefly.Group;a.view=this.view.clone();a.view.empty();$.each(this.components,function(){var b=
this.view.css("left"),e=this.view.css("top");a.addComponent(this.clone(),b,e)});return a};this.toXmlNode=function(){var a=this.view.clone();a.attr("ff-type","Group");a.empty();$.each(this.components,function(){this.toXmlNode().appendTo(a)});return a}};Firefly.Group.create=function(b){var a=new Firefly.Group;a.view=b.clone();a.view.empty();b.children().each(function(){var b=$(this),e=Firefly[b.attr("ff-type")].create(b),d=b.css("left"),b=b.css("top");a.addComponent(e,d,b)});return a};Firefly.EditorCanvasDescriptor=function(b){var a=this;this.title="\u753b\u5e03";this.initComplete=!1;this.init=function(a){this.createChildren(a);this.initComplete=!0;this.update()};this.createChildren=function(b){b.header.text(this.title);var b=b.form,e=Firefly.FormViewManager.createSizeView();e.appendTo(b);Firefly.FormViewManager.createHline().appendTo(b);var d=Firefly.FormViewManager.createColorPickerView("\u80cc\u666f\u989c\u8272");d.appendTo(b);this.colorPicker=new Firefly.ColorPicker(this.getColor(),
d.find(".colorPicker"));b=e.find("input");this.widthInput=b.eq(0);this.heightInput=b.eq(1);this.colorPicker.onSubmit=function(b){var c=a.getColor();Firefly.HistoryManager.addPropertiesEditAction(c,b,function(b){a.setColor(b);a.colorPicker.setColor(b)})};this.widthInput.change(function(){var b=a.getWidth(),c=a.widthInput.val();Firefly.HistoryManager.addPropertiesEditAction(b,c,function(b){a.setWidth(b);a.widthInput.val(b)})});this.heightInput.change(function(){var b=a.getHeight(),c=a.heightInput.val();
Firefly.HistoryManager.addPropertiesEditAction(b,c,function(b){a.setHeight(b);a.heightInput.val(b)})})};this.update=function(){this.initComplete&&(this.widthInput.val(this.getWidth()),this.heightInput.val(this.getHeight()))};this.getWidth=function(){return b.size.width};this.setWidth=function(a){a=parseInt(a);b.size.width=a;b.view.outerWidth(a*b.scale);Firefly.editor.updateSize()};this.getHeight=function(){return b.size.height};this.setHeight=function(a){a=parseInt(a);b.size.height=a;b.view.outerHeight(a*
b.scale);Firefly.editor.updateSize()};this.getColor=function(){var a=b.view.css("background-color");return Firefly.Color.getCSSHexColor(a)};this.setColor=function(a){b.view.css("background-color",a)}};Firefly.ComponentBaseDescriptor=function(b){var a=this;this.title="\u57fa\u672c\u7ec4\u4ef6";this.initComplete=!1;this.init=function(a){this.createChildren(a);this.initComplete=!0;this.update()};this.createChildren=function(c){c.header.text(this.title);var e=c.form,d=Firefly.FormViewManager.createPositionView();d.appendTo(e);var g=Firefly.FormViewManager.createSizeView();g.appendTo(e);Firefly.FormViewManager.createHline().appendTo(e);var f=Firefly.FormViewManager.createCheckBoxView("\u81ea\u52a8\u5927\u5c0f");
f.appendTo(e);e=d.find("input");this.xInput=e.eq(0);this.yInput=e.eq(1);g=g.find("input");this.widthInput=g.eq(0);this.heightInput=g.eq(1);this.autoSizeCheckBox=f.find(".ui.checkbox").eq(0);b.lockWidth&&b.lockHeight&&f.addClass("disabled");this.xInput.change(function(){var b=a.getX(),c=a.xInput.val();Firefly.HistoryManager.addPropertiesEditAction(b,c,function(b){a.setX(b);a.xInput.val(b)})});this.yInput.change(function(){var b=a.getY(),c=a.yInput.val();Firefly.HistoryManager.addPropertiesEditAction(b,
c,function(b){a.setY(b);a.yInput.val(b)})});this.widthInput.change(function(){var b=a.getWidth(),c=a.widthInput.val();Firefly.HistoryManager.addPropertiesEditAction(b,c,function(b){a.setWidth(b);a.widthInput.val(b)})});this.heightInput.change(function(){var b=a.getHeight(),c=a.heightInput.val();Firefly.HistoryManager.addPropertiesEditAction(b,c,function(b){a.setHeight(b);a.heightInput.val(b)})});this.autoSizeCheckBox.checkbox({onChange:function(){var b=a.getAutoSize(),c=a.autoSizeCheckBox.checkbox("is checked");
Firefly.HistoryManager.addPropertiesEditAction(b,c,function(b){a.setAutoSize(b);a.autoSizeCheckBox.checkbox(b?"set checked":"set unchecked")})}});Firefly.FormViewManager.createHeaderView("\u53e0\u653e\u987a\u5e8f").appendTo(c.layoutPanel);f=Firefly.FormViewManager.createLayoutView();f.appendTo(c.layoutPanel);c=f.find("button");c.popup();c.each(function(b){$(this).click(function(){switch(b){case 0:a.goTopLayer();break;case 1:a.goBottomLayer();break;case 2:a.goUpLayer();break;case 3:a.goDownLayer()}})})};
this.update=function(){if(this.initComplete){this.xInput.val(this.getX());this.yInput.val(this.getY());this.widthInput.val(this.getWidth());this.heightInput.val(this.getHeight());var a=this.getAutoSize();this.autoSizeCheckBox.checkbox(a?"set checked":"set unchecked");this.widthInput.parent()[a?"addClass":"removeClass"]("disabled");this.heightInput.parent()[a?"addClass":"removeClass"]("disabled");b.lockWidth&&this.widthInput.parent().addClass("disabled");b.lockHeight&&this.heightInput.parent().addClass("disabled")}};
this.getX=function(){return parseInt(b.view.css("left"))};this.setX=function(a){b.moveTo(a);Firefly.editor.getEditorCanvas().scaleTool.update()};this.getY=function(){return parseInt(b.view.css("top"))};this.setY=function(a){b.moveTo(void 0,a);Firefly.editor.getEditorCanvas().scaleTool.update()};this.getWidth=function(){return b.view.outerWidth()};this.setWidth=function(a){b.resizeTo(a);Firefly.editor.getEditorCanvas().scaleTool.update()};this.getHeight=function(){return b.view.outerHeight()};this.setHeight=
function(a){b.resizeTo(void 0,a);Firefly.editor.getEditorCanvas().scaleTool.update()};this.getAutoSize=function(){return b.getAutoSize()};this.setAutoSize=function(a){b.setAutoSize(a);Firefly.editor.getEditorCanvas().scaleTool.update()};this.goTopLayer=function(){Firefly.HistoryManager.addMoveLayerAction(b,"top")};this.goBottomLayer=function(){Firefly.HistoryManager.addMoveLayerAction(b,"bottom")};this.goUpLayer=function(){Firefly.HistoryManager.addMoveLayerAction(b,"up")};this.goDownLayer=function(){Firefly.HistoryManager.addMoveLayerAction(b,
"down")}};Firefly.MultipleSelectDescriptor=function(b){var a=this;this.title="\u9009\u62e9\u591a\u4e2a";this.initComplete=!1;this.init=function(a){this.createChildren(a);this.initComplete=!0;this.update()};this.createChildren=function(b){b.header.text(this.title);var e=b.form,d=Firefly.FormViewManager.createPositionView();d.appendTo(e);b=Firefly.FormViewManager.createSizeView();b.appendTo(e);e=d.find("input");this.xInput=e.eq(0);this.yInput=e.eq(1);b=b.find("input");this.widthInput=b.eq(0);this.heightInput=
b.eq(1);this.xInput.change(function(){var b=a.getX(),c=a.xInput.val();Firefly.HistoryManager.addPropertiesEditAction(b,c,function(b){a.setX(b);a.xInput.val(b)})});this.yInput.change(function(){var b=a.getY(),c=a.yInput.val();Firefly.HistoryManager.addPropertiesEditAction(b,c,function(b){a.setY(b);a.yInput.val(b)})});this.widthInput.change(function(){var b=a.getWidth(),c=a.widthInput.val();Firefly.HistoryManager.addPropertiesEditAction(b,c,function(b){a.setWidth(b);a.widthInput.val(b)})});this.heightInput.change(function(){var b=
a.getHeight(),c=a.heightInput.val();Firefly.HistoryManager.addPropertiesEditAction(b,c,function(b){a.setHeight(b);a.heightInput.val(b)})})};this.update=function(){this.initComplete&&(this.xInput.val(this.getX()),this.yInput.val(this.getY()),this.widthInput.val(this.getWidth()),this.heightInput.val(this.getHeight()))};this.getX=function(){var a=Firefly.editor.getEditorCanvas(),e=b.view.position().left+a.view.offset().left,a=a.globalToLocalPoint(new Firefly.Point(e,0));return parseInt(a.x)};this.setX=
function(a){var e=Firefly.editor.getEditorCanvas(),a=new Firefly.Point(a,0),e=e.localToGlobalPoint(a).x-e.view.offset().left;b.moveTo(e)};this.getY=function(){var a=Firefly.editor.getEditorCanvas(),e=b.view.position().top+a.view.offset().top,a=a.globalToLocalPoint(new Firefly.Point(0,e));return parseInt(a.y)};this.setY=function(a){var e=Firefly.editor.getEditorCanvas(),a=new Firefly.Point(0,a),e=e.localToGlobalPoint(a).y-e.view.offset().top;b.moveTo(void 0,e)};this.getWidth=function(){var a=Firefly.editor.getEditorCanvas().scale;
return parseInt(b.box.outerWidth()/a)};this.setWidth=function(a){var e=Firefly.editor.getEditorCanvas().scale;b.resizeTo(a*e);b.update()};this.getHeight=function(){var a=Firefly.editor.getEditorCanvas().scale;return parseInt(b.box.outerHeight()/a)};this.setHeight=function(a){var e=Firefly.editor.getEditorCanvas().scale;b.resizeTo(void 0,a*e);b.update()}};Firefly.ImageDescriptor=function(b){var a=this;Firefly.ComponentBaseDescriptor.call(this,b);this.title="\u56fe\u7247";var c=this.createChildren;this.createChildren=function(b){c.call(this,b);this.scaleModeDropdown=new Firefly.Dropdown("\u7f29\u653e\u6a21\u5f0f",[{value:0,label:"\u62c9\u4f38"},{value:1,label:"\u5185\u9002\u5e94"},{value:2,label:"\u5916\u9002\u5e94"}]);this.scaleModeDropdown.view.appendTo(b.form);this.scaleModeDropdown.setValue(this.getScaleMode());this.scaleModeDropdown.onChange=function(b){var c=
a.getScaleMode();Firefly.HistoryManager.addPropertiesEditAction(c,b,function(b){a.setScaleMode(b);a.scaleModeDropdown.setValue(b)})}};this.getScaleMode=function(){return b.getScaleMode()};this.setScaleMode=function(a){b.setScaleMode(a)}};Firefly.GroupDescriptor=function(b){Firefly.ComponentBaseDescriptor.call(this,b);this.title="\u7fa4\u7ec4"};Firefly.FormViewManager={};Firefly.FormViewManager.createPositionView=function(){return $('<div class="inline fields">\t<div class="eight wide field">\t\t<label>X</label>\t\t<input type="text" placeholder="">   </div>   <div class="eight wide field">\t\t<label>Y</label>\t\t<input type="text" placeholder="">\t</div></div>')};Firefly.FormViewManager.createSizeView=function(){return $('<div class="inline fields">\t<div class="eight wide field">\t\t<label>\u5bbd</label>\t\t<input type="text" placeholder="">   </div>   <div class="eight wide field">\t\t<label>\u9ad8</label>\t\t<input type="text" placeholder="">\t</div></div>')};
Firefly.FormViewManager.createHline=function(){return $('<div class="ui divider"></div>')};Firefly.FormViewManager.createHeader=function(b){var a=$("<div>",{style:"padding:3px;background-color:#e9e9e9;margin-bottom:10px;font-size:11px;"});a.text(b);return a};Firefly.FormViewManager.createCheckBoxView=function(b){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+b+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui checkbox">\t\t\t<input type="checkbox">\t\t\t<label></label>\t\t</div>\t</div></div>')};
Firefly.FormViewManager.createDropdownView=function(b,a){for(var c=$('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+b+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui selection dropdown">\t\t\t<i class="dropdown icon"></i>\t\t\t<div class="default text"></div>\t\t\t<div class="menu">\t\t\t</div>\t\t</div>\t</div></div>'),e=c.find(".menu"),d=a.length,g=0;g<d;g++)$('<div class="item" data-value="'+a[g].value+'">'+a[g].label+"</div>").appendTo(e);return c};
Firefly.FormViewManager.createHeaderView=function(b){return $('<div class="ui small header">'+b+"</div>")};Firefly.FormViewManager.createLayoutView=function(){return $('<div class="ui basic buttons">\t<button class="ui icon button" data-content="\u7f6e\u9876"><i class="arrow circle up icon"></i></button>\t<button class="ui icon button" data-content="\u7f6e\u5e95"><i class="arrow circle down icon"></i></button>\t<button class="ui icon button" data-content="\u4e0a\u79fb\u4e00\u5c42"><i class="arrow up icon"></i></button>\t<button class="ui icon button" data-content="\u4e0b\u79fb\u4e00\u5c42"><i class="arrow down icon"></i></button></div>')};
Firefly.FormViewManager.createColorPickerView=function(b){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+b+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="colorPicker">\t\t\t<div class="box"></div>\t\t</div>\t</div></div>')};Firefly.FormViewManager.createTextInputView=function(b){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+b+'</label>\t</div>\t<div class="eleven wide field">\t\t<input type="text" placeholder="">\t</div></div>')};
Firefly.FormViewManager.createTextInputWithRightLabelView=function(b,a){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+b+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui right labeled input">\t\t\t<input type="text" placeholder="">\t\t\t<div class="ui basic label">'+a+"</div>\t\t</div>\t</div></div>")};Firefly.FormViewManager.createTextAreaView=function(b){return $('<div class="field">\t<label>'+b+'</label>\t<textarea style="margin-top: 0px; margin-bottom: 0px; height: 148px;"></textarea></div>')};
Firefly.FormViewManager.createFontStyleView=function(b){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+b+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui icon basic buttons">\t\t\t<button class="ui button"><i class="bold icon"></i></button>\t\t\t<button class="ui button"><i class="italic icon"></i></button>\t\t\t<button class="ui button"><i class="underline icon"></i></button>\t\t\t<button class="ui button"><i class="strikethrough icon"></i></button>\t\t</div>\t</div></div>')};
Firefly.FormViewManager.createTextHAlignView=function(b){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+b+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui icon basic buttons">\t\t\t<button class="ui button"><i class="align left icon"></i></button>\t\t\t<button class="ui button"><i class="align center icon"></i></button>\t\t\t<button class="ui button"><i class="align right icon"></i></button>\t\t</div>\t</div></div>')};Firefly.Rect=function(b,a,c,e){this.x=b;this.y=a;this.width=c;this.height=e;this.contain=function(a){return a.x>=this.x&&a.x<=this.x+this.width&&a.y>=this.y&&a.y<=this.y+this.height}};Firefly.Rect.testRectCross=function(b,a){var c,e,d,g;c=b.x+b.width/2;e=b.y+b.height/2;d=a.x+a.width/2;g=a.y+a.height/2;return Math.abs(c-d)<=b.width/2+a.width/2&&Math.abs(e-g)<=b.height/2+a.height/2};Firefly.Point=function(b,a){this.x=b;this.y=a};Firefly.Color={};Firefly.Color.randomColor=function(){var b=Math.floor(Math.random()*16777215).toString(16);return b.length==6?"#"+b:Firefly.Color.randomColor()};Firefly.Color.getCSSHexColor=function(b){if(b.indexOf("rgb")>-1){var a=b,a=b.indexOf("rgba")>-1?a.substr(5,a.length-6):a.substr(4,a.length-5),b=a.split(","),b={r:parseInt(b[0]),g:parseInt(b[1]),b:parseInt(b[2])};return"#"+$.colpick.rgbToHex(b)}else return b};Firefly.ArrayUtil={};Firefly.ArrayUtil.equals=function(b,a){var c=!0;if(b.length!=a.length)c=!1;else for(var e=b.length,d=0;d<e;d++)if(b[d]!==a[d]){c=!1;break}return c};Firefly.MainLayout=function(b){function a(){e.outerWidth(n);g.outerWidth(m);var a=$(window).width()-n-m-f.outerWidth()-h.outerWidth();d.outerWidth(a);var b=$(window).height()-$("#topMenu").outerHeight();e.outerHeight(b);g.outerHeight(b);d.outerHeight(b);d.css("left",n+f.outerWidth());g.css("left",n+a+f.outerWidth()+h.outerWidth());f.outerHeight(b);h.outerHeight(b);f.css("left",n);h.css("left",n+a+f.outerWidth());a=b-c.view.find(".menu").outerHeight()-10;o.outerHeight(a);p.outerHeight(a-r.outerHeight());
s.outerHeight(a)}var c=this;this.view=$(b);var e=this.view.find("#leftBox"),d=this.view.find("#centerBox"),g=this.view.find("#rightBox"),b=this.view.find(".vDivide"),f=b.eq(0),h=b.eq(1),k=f.find(".handle"),l=h.find(".handle"),n=322,m=320;k.click(function(){n=n==322?0:322;a()});l.click(function(){m=m==320?0:320;a()});e.css("position","absolute");d.css("position","absolute");g.css("position","absolute");this.view.find(".menu .item").tab();this.view.find(".segment").css("overflow","auto");var o=this.view.find("#resourcePanel .segment");
o.css("padding",5);var p=this.view.find("#propertiesPanel .segment"),r=this.view.find("#propertiesPanel #header"),s=this.view.find("#historyPanel .segment");s.css("padding",5);$(window).resize(a);a();this.toggleLeft=function(){k.trigger("click")};this.toggleRight=function(){l.trigger("click")}};
