function trace(a){console.log(a)};var Painter={};
Painter.init=function(){this.mainLayout=new Painter.MainLayout("#mainLayout");this.topMenu=new Painter.TopMenu("#topMenu");this.propertiesPanel=new Painter.PropertiesPanel;this.historyPanel=new Painter.HistoryPanel;this.layerPanel=new Painter.LayerPanel;this.previewView=new Painter.PreviewView;var a=$("#mainLayout #centerBox");this.editor=new Painter.Editor(a);this.toolPanel=new Painter.ToolPanel;this.materialSelectWin=new Painter.MaterialSelectWin;this.brushShapeSelectWin=new Painter.BrushShapeSelectWin;this.filterWin=
new Painter.FilterWin;this.settingWin=new Painter.SettingWin("#settingWin");this.inputWin=new Painter.InputWin("#inputWin");this.editCanvasSizeWin=new Painter.EditCanvasSizeWin("#eidtCanvasSizeWin");this.onlineFileWin=new Painter.OnlineFileWin("#onlineFileWin")};$(function(){Painter.init()});Painter.MainLayout=function(a){function b(){c.outerWidth(k);f.outerWidth(i);var a=$(window).width()-k-i-e.outerWidth()-g.outerWidth();d.outerWidth(a);var b=$(window).height()-$("#topMenu").outerHeight();c.outerHeight(b);f.outerHeight(b);d.outerHeight(b);d.css("left",k+e.outerWidth());f.css("left",k+a+e.outerWidth()+g.outerWidth());e.outerHeight(b);g.outerHeight(b);e.css("left",k);g.css("left",k+a+e.outerWidth());m.outerWidth(i);m.outerHeight(o);n.outerWidth(i);a=b-o-l.outerHeight();n.outerHeight(a);
l.css("top",o);n.css("top",o+l.outerHeight());a=a-r-10;p.outerHeight(a);q.outerHeight(a-s.outerHeight());t.outerHeight(a);u.update()}this.view=$(a);var c=this.view.find("#leftBox"),d=this.view.find("#centerBox"),f=this.view.find("#rightBox"),a=this.view.find(".vDivide"),e=a.eq(0),g=a.eq(1),j=e.find(".handle"),h=g.find(".handle"),k=51,i=320;j.click(function(){k=k==51?0:51;b()});h.click(function(){i=i==320?0:320;b()});c.css("position","absolute");d.css("position","absolute");f.css("position","absolute");
var m=f.find("#topBox"),n=f.find("#bottomBox"),l=f.find(".hDivide"),o=200;l.click(function(){o=o==200?0:200;b()});m.css("position","absolute");n.css("position","absolute");this.view.find(".menu.tabular .item").tab();var p=this.view.find("#layerPanel .segment");p.css("padding",5);p.css("overflow","hidden");var q=this.view.find("#propertiesPanel .segment");q.css("overflow","auto");var s=this.view.find("#propertiesPanel #header"),t=this.view.find("#historyPanel .segment");t.css("padding",5);t.css("overflow",
"auto");var r=this.view.find(".menu.tabular").outerHeight(),u=new function(){var a=p.find("#listContainer");this.update=function(){var b=p.outerHeight()-95;a.outerHeight(b)}};$(window).resize(b);b();this.toggleLeft=function(){j.trigger("click")};this.toggleRight=function(){h.trigger("click")};this.toggleRightTop=function(){l.trigger("click")}};Painter.TopMenu=function(a){function b(){$.each(f,function(){this.update()})}function c(a){function b(){if(d!="")Painter.KeyboardManager.execute(d);else switch(c){case "\u5bfc\u51fa\u56fe\u7247":Painter.KeyboardManager.execute("export");break;case "\u952e\u76d8\u5feb\u6377\u952e":Painter.KeyboardManager.execute("showQuickKey");break;case "\u64ad\u653e\u5f53\u524d\u7ed8\u753b\u8fc7\u7a0b":Painter.KeyboardManager.execute("playPaintPath");break;case "\u5173\u4e8ePainter":Painter.KeyboardManager.execute("about");
break;case "\u6253\u5f00\u7ed8\u753b\u8fc7\u7a0b":Painter.KeyboardManager.execute("openPaintPath");break;case "\u4fdd\u5b58\u7ed8\u753b\u8fc7\u7a0b":Painter.KeyboardManager.execute("savePaintPath");break;case "\u5728\u7ebf\u6587\u4ef6":Painter.KeyboardManager.execute("onlineFile")}}var c=a.find("span.text").eq(0).text();a.find(".item").length==0&&a.click(b);var d=a.find("span.description").text();this.update=function(){var a=!0;switch(c){case "\u64a4\u6d88":a=Painter.historyPanel.getUndoAble();break;
case "\u91cd\u505a":a=Painter.historyPanel.getRedoAble();break;case "\u5220\u9664\u56fe\u5c42":a=Painter.editor.getEditorCanvas().getSelectedLayer();break;case "\u79fb\u52a8\u56fe\u5c42":a=Painter.editor.getEditorCanvas().getSelectedLayer();break;case "\u6dfb\u52a0\u6ee4\u955c":a=Painter.editor.getEditorCanvas().getSelectedLayer();break;case "\u64ad\u653e\u5f53\u524d\u7ed8\u753b\u8fc7\u7a0b":a=Painter.Recorder.getActions().length>0;break;case "\u56fe\u5c42\u9762\u677f":a=Painter.topMenu.panelMenuController.getSelectedValue()!=
"layers";break;case "\u5c5e\u6027\u9762\u677f":a=Painter.topMenu.panelMenuController.getSelectedValue()!="properties";break;case "\u5386\u53f2\u8bb0\u5f55":a=Painter.topMenu.panelMenuController.getSelectedValue()!="history";break;case "\u753b\u7b14":a=Painter.toolPanel.getCurrentToolIdx()!=0;break;case "\u6a61\u76ae\u64e6":a=Painter.toolPanel.getCurrentToolIdx()!=1;break;case "\u5438\u8272\u5de5\u5177":a=Painter.toolPanel.getCurrentToolIdx()!=2;break;case "\u6cb9\u6f06\u6876":a=Painter.toolPanel.getCurrentToolIdx()!=
3}this.setEnabled(a)};this.setEnabled=function(b){b?a.removeClass("disabled"):a.addClass("disabled")}}this.view=$(a);a=this.view.find(".ui.dropdown:not(.right.menu .ui.dropdown)");a.dropdown({on:"hover",onShow:function(){b()}});var d=a.find(".item"),f=[];d.each(function(){f.push(new c($(this)))});this.panelMenuController=new function(a){var b=this,c,d={properties:$("#propertiesPanel"),history:$("#historyPanel"),layers:$("#layerPanel")};$.each(d,function(){$(this).css("display","none")});this.selectValue=
function(a){c!=void 0&&d[c].css("display","none");c=a;d[c].css("display","block")};this.getSelectedValue=function(){return c};this.getMenu=function(){return a};this.selectValue("layers");a.dropdown("set selected",c);a.dropdown({onChange:function(a){b.selectValue(a)}})}(this.view.find(".right.menu .ui.dropdown").eq(0));this.getItems=function(){return d}};Painter.Editor=function(a){function b(){var b=d.view.outerWidth()+1E3,e=d.view.outerHeight()+1E3,b=b>a.outerWidth()?b:a.outerWidth(),e=e>a.outerHeight()?e:a.outerHeight();c.outerWidth(b);c.outerHeight(e);b=(b-d.view.outerWidth())*0.5;e=(e-d.view.outerHeight())*0.5;d.view.css("left",b);d.view.css("top",e)}this.view=$("<div style='position:absolute;'></div>");this.view.outerWidth("100%");this.view.outerHeight("100%");this.view.css("overflow","auto");this.view.appendTo(a);var c=$("<div style='position:absolute;'></div>");
c.appendTo(this.view);var d=new Painter.EditorCanvas(c);this.getEditorCanvas=function(){return d};this.scrollToCenter=function(){this.view.scrollTop((c.outerHeight()-a.outerHeight())*0.5);this.view.scrollLeft((c.outerWidth()-a.outerWidth())*0.5)};this.updateSize=function(){b();this.scrollToCenter()};$(window).resize(b);b();this.scrollToCenter()};Painter.EditorCanvas=function(a){function b(a,b){b==void 0||b!=void 0&&b>i.length-1?(a.getCanvas().appendTo(j),i.push(a)):(a.getCanvas().insertBefore(i[b].getCanvas()),i.splice(b,0,a));Painter.layerPanel.getLayerListController().addItem(a,b)}function c(a){m!=void 0&&Painter.layerPanel.getLayerListController().unSelectItemByLayer(m);m=a;a!=void 0&&Painter.layerPanel.getLayerListController().selectItemByLayer(a)}function d(a){var b=i.indexOf(a);i.splice(b,1);a.getCanvas().remove();Painter.layerPanel.getLayerListController().removeItemByLayer(a);
m===a&&(m=void 0)}function f(a,b){g.view.outerWidth(a);g.view.outerHeight(b);for(var c=0;c<i.length;){var d=i[c],e=d.getCanvas();e.get(0).width=a;e.get(0).height=b;d.repaint();c++}g.bufferCanvas.get(0).width=a;g.bufferCanvas.get(0).height=b;$(window).trigger("resize")}function e(a){a=i.indexOf(a);if(a+1<i.length)return i[a+1];else if(a-1>-1&&i.length>0)return i[a-1]}var g=this;this.view=$("<div style='position:absolute;'></div>");this.view.outerWidth(800);this.view.outerHeight(600);this.view.appendTo(a);
this.view.css("background-image","url(assets/image/alphaBg.png)");var j=$("<div style='position:absolute;'></div>");j.appendTo(this.view);var h=$("<div style='position:absolute;'></div>");h.appendTo(this.view);var k=$("<div style='position:absolute;width:100%;height:100%'></div>");k.appendTo(this.view);this.bufferCanvas=$("<canvas>",{style:"position:absolute;"});this.bufferCanvas.attr("width",this.view.outerWidth());this.bufferCanvas.attr("height",this.view.outerHeight());var i=[],m,n,a=new Painter.Layer(this);
a.setName("\u80cc\u666f\u5c42");var l=new Painter.LayerAction(Painter.LayerActionType.SetBackgroundColor,"#ffffff");a.addAction(l);b(a);c(a);Painter.Recorder.addAction(new Painter.Recorder.Action(Painter.Recorder.Type.newLayer));Painter.Recorder.addAction(new Painter.Recorder.Action(Painter.Recorder.Type.drawLayer,{layerIdx:0,action:l}));(function(){k.mouseover(function(){n!=void 0&&n.view.show()});k.on("mouseout",function(){n!=void 0&&n.view.hide()});$(document).mousemove(function(a){a=g.globalToLocalPoint(new Painter.Point(a.clientX,
a.clientY));n!=void 0&&(n.view.css("left",a.x),n.view.css("top",a.y))});k.mousedown(function(a){function b(a){a=g.globalToLocalPoint(new Painter.Point(a.clientX,a.clientY));e.mousemove(a)}function c(a){$(document).off("mousemove",b);$(document).off("mouseup",c);a=g.globalToLocalPoint(new Painter.Point(a.clientX,a.clientY));e.mouseup(a);j.remove();g.addLayerAction(d,e.getAction())}var d=g.getSelectedLayer();if(d!=void 0){$(document).on("mousemove",b);$(document).on("mouseup",c);var e=Painter.toolPanel.getCurrentTool(),
j=g.bufferCanvas;j.insertAfter(d.getCanvas());a=g.globalToLocalPoint(new Painter.Point(a.clientX,a.clientY));e.setDrawCanvasAndBufferCanvas(d.getCanvas().get(0),j.get(0));e.mousedown(a)}})})();this.globalToLocalPoint=function(a){return new Painter.Point(a.x-this.view.offset().left,a.y-this.view.offset().top)};this.open=function(a){var e=JSON.parse(a);$("#loadingMask").dimmer({closable:!1});$("#loadingMask").find(".ui.text.loader").text("\u9884\u52a0\u8f7d\u56fe\u5c42");$("#loadingMask").dimmer("show");
var j=[];(function(a){function b(a,d){var g=new Image;g.onload=function(){j.push(c(this));d()};g.src=a}function c(a){g.width=a.width;g.height=a.height;var b=g.getContext("2d");b.drawImage(a,0,0,a.width,a.height,0,0,g.width,g.height);return b.getImageData(0,0,g.width,g.height)}var d=0,g=$("<canvas>").get(0);e.layers.length==0?a():(d=0,b(e.layers[d].data,function(){d++;d==e.layers.length?a():b(e.layers[d].data,arguments.callee)}))})(function(){for($("#loadingMask").dimmer("hide");i.length>0;)d(i[0]);
Painter.HistoryManager.removeAll();Painter.Recorder.removeAll();var a={width:e.width,height:e.height};f(a.width,a.height);for(a=0;a<e.layers.length;a++){var h=e.layers[a],r=new Painter.Layer(g);r.setName(h.name);r.setAlpha(h.alpha);r.setVisible(h.visible);var k=new Painter.LayerAction(Painter.LayerActionType.SetData,j[a]);r.addAction(k);b(r);Painter.Recorder.addAction(new Painter.Recorder.Action(Painter.Recorder.Type.newLayer));Painter.Recorder.addAction(new Painter.Recorder.Action(Painter.Recorder.Type.setLayerAlpha,
{layerIdx:a,alpha:h.alpha}));Painter.Recorder.addAction(new Painter.Recorder.Action(Painter.Recorder.Type.setLayerVisible,{layerIdx:a,visible:h.visible}));Painter.Recorder.addAction(new Painter.Recorder.Action(Painter.Recorder.Type.drawLayer,{layerIdx:a,action:k}))}c(i[i.length-1]);g.dispatchUpdateEvent()})};this.setCursor=function(a){k.css("cursor",a)};this.setDragView=function(a){n=a;h.empty();n!=void 0&&(n.view.hide(),n.view.appendTo(h))};this.getSelectedLayer=function(){return m};this.getLayers=
function(){return i};this.dispatchUpdateEvent=function(){this.view.trigger("editCanvasUpdate")};this.setSize=function(a,b){var c={width:g.view.outerWidth(),height:g.view.outerHeight()};Painter.HistoryManager.addEditAction("changeSize",c,{width:a,height:b},function(a){f(a.width,a.height);g.dispatchUpdateEvent()})};this.addLayerAction=function(a,b){if(b!=void 0){var c=new Painter.Recorder.Action(Painter.Recorder.Type.drawLayer,{layerIdx:i.indexOf(a),action:b});Painter.HistoryManager.add("paint",function(){a.removeAction(b);
Painter.Recorder.removeAction(c);g.dispatchUpdateEvent()},function(){a.addAction(b);Painter.Recorder.addAction(c);g.dispatchUpdateEvent()})}};this.applyFilterToSelectedLayer=function(a){var b=this.getSelectedLayer();b!=void 0&&(a=new Painter.LayerAction(Painter.LayerActionType.ApplyFilter,a),this.addLayerAction(b,a))};this.newLayer=function(){var a=this.getSelectedLayer(),g=new Painter.Layer(this);g.setName("\u65b0\u56fe\u5c42");var e=a!=void 0?i.indexOf(a)+1:void 0,j=new Painter.Recorder.Action(Painter.Recorder.Type.newLayer,
e);Painter.HistoryManager.add("newLayer",function(){d(g);c(a);Painter.Recorder.removeAction(j)},function(){b(g,e);c(g);Painter.Recorder.addAction(j)})};this.removeSelectedLayer=function(){var a=this.getSelectedLayer(),j=i.indexOf(a);if(a!=void 0){var f=e(a),h=new Painter.Recorder.Action(Painter.Recorder.Type.removeLayer,j);Painter.HistoryManager.add("removeLayer",function(){b(a,j);c(a);g.dispatchUpdateEvent();Painter.Recorder.removeAction(h)},function(){d(a);f!=void 0&&c(f);g.dispatchUpdateEvent();
Painter.Recorder.addAction(h)})}};this.moveSelectedLayer=function(a){function b(){var c=i.indexOf(f),d=c+1;if(d<i.length){var e=new Painter.Recorder.Action(Painter.Recorder.Type.moveLayer,{layerIdx:c,direction:a});Painter.HistoryManager.add("moveLayer",function(){f.getCanvas().insertBefore(i[c].getCanvas());i.splice(d,1);i.splice(c,0,f);Painter.layerPanel.getLayerListController().moveItemByLayer(f,"down");g.dispatchUpdateEvent();Painter.Recorder.removeAction(e)},function(){f.getCanvas().insertAfter(i[d].getCanvas());
i.splice(c,1);i.splice(d,0,f);Painter.layerPanel.getLayerListController().moveItemByLayer(f,"up");g.dispatchUpdateEvent();Painter.Recorder.addAction(e)})}}function c(){var b=i.indexOf(f),d=b-1;if(d>-1){var e=new Painter.Recorder.Action(Painter.Recorder.Type.moveLayer,{layerIdx:b,direction:a});Painter.HistoryManager.add("moveLayer",function(){f.getCanvas().insertAfter(i[b].getCanvas());i.splice(d,1);i.splice(b,0,f);Painter.layerPanel.getLayerListController().moveItemByLayer(f,"up");g.dispatchUpdateEvent();
Painter.Recorder.removeAction(e)},function(){f.getCanvas().insertBefore(i[d].getCanvas());i.splice(b,1);i.splice(d,0,f);Painter.layerPanel.getLayerListController().moveItemByLayer(f,"down");g.dispatchUpdateEvent();Painter.Recorder.addAction(e)})}}function d(){var b=i.indexOf(f);if(b!=i.length-1){var c=new Painter.Recorder.Action(Painter.Recorder.Type.moveLayer,{layerIdx:b,direction:a});Painter.HistoryManager.add("moveLayer",function(){f.getCanvas().insertBefore(i[b].getCanvas());i.pop();i.splice(b,
0,f);Painter.layerPanel.getLayerListController().moveTopItemToIdxByLayer(f,b);g.dispatchUpdateEvent();Painter.Recorder.removeAction(c)},function(){f.getCanvas().appendTo(j);i.splice(b,1);i.push(f);Painter.layerPanel.getLayerListController().moveItemByLayer(f,"top");g.dispatchUpdateEvent();Painter.Recorder.addAction(c)})}}function e(){var b=i.indexOf(f);if(b>0){var c=new Painter.Recorder.Action(Painter.Recorder.Type.moveLayer,{layerIdx:b,direction:a});Painter.HistoryManager.add("moveLayer",function(){f.getCanvas().insertAfter(i[b].getCanvas());
i.shift();i.splice(b,0,f);Painter.layerPanel.getLayerListController().moveBottomItemToIdxByLayer(f,b);g.dispatchUpdateEvent();Painter.Recorder.removeAction(c)},function(){f.getCanvas().prependTo(j);i.splice(b,1);i.unshift(f);Painter.layerPanel.getLayerListController().moveItemByLayer(f,"bottom");g.dispatchUpdateEvent();Painter.Recorder.addAction(c)})}}var f=this.getSelectedLayer();if(f!=void 0)switch(a){case "up":b();break;case "down":c();break;case "top":d();break;case "bottom":e()}};this.changeSelectedLayerAlpha=
function(a){var b=this.getSelectedLayer(),c=b.getAlpha(),d=i.indexOf(b),e=new Painter.Recorder.Action(Painter.Recorder.Type.setLayerAlpha,{layerIdx:d,alpha:a});Painter.HistoryManager.addEditAction("editLayer",c,a,function(c){Painter.layerPanel.getToolBarController().getAlphaSlider().setValue(c);Painter.layerPanel.getLayerListController().setLayerAlpha(b,c);g.dispatchUpdateEvent();c==a?Painter.Recorder.addAction(e):Painter.Recorder.removeAction(e)})};this.setLayerVisible=function(a,b){var c=a.getVisible(),
d=i.indexOf(a),e=new Painter.Recorder.Action(Painter.Recorder.Type.setLayerVisible,{layerIdx:d,visible:b});Painter.HistoryManager.addEditAction("editLayer",c,b,function(c){Painter.layerPanel.getLayerListController().setLayerVisible(a,c);g.dispatchUpdateEvent();c==b?Painter.Recorder.addAction(e):Painter.Recorder.removeAction(e)})};this.setLayerName=function(a,b){var c=a.getName();c!=b&&Painter.HistoryManager.addEditAction("editLayer",c,b,function(b){Painter.layerPanel.getLayerListController().setLayerName(a,
b)})};this.selectLayer=function(a){var b=this.getSelectedLayer();b!=a&&Painter.HistoryManager.addEditAction("selectLayer",b,a,function(a){c(a)})};Painter.previewView.init(this)};Painter.ToolPanel=function(){function a(a){d!=void 0&&d.removeClass("basic violet active");d=a;d.addClass("basic violet active");a=b.getCurrentTool();Painter.propertiesPanel.setTargets([a]);Painter.editor.getEditorCanvas().setCursor(a.getCursor());Painter.editor.getEditorCanvas().setDragView(a.getDragView())}var b=this,c=$("#toolPanel").find("button");c.each(function(){$(this).click(function(){var a=c.index($(this));b.switchToolIdx(a)})});var d,f=[new Painter.Brush,new Painter.Eraser,new Painter.ColorSucker,
new Painter.PaintBucket];this.getCurrentToolIdx=function(){return c.index(d)};this.getCurrentTool=function(){var a=this.getCurrentToolIdx();return f[a]};this.getBrush=function(){return f[0]};this.getPaintBucket=function(){return f[3]};this.switchToolIdx=function(b){var d=this.getCurrentTool();Painter.HistoryManager.addEditAction("switchTool",d,f[b],function(b){b=f.indexOf(b);a(c.eq(b))})};a(c.eq(0))};Painter.Brush=function(){this.items=[new Painter.LineBrush,new Painter.ShapeBrush];this.settingsItems=[new Painter.LineBrushSettings,new Painter.ShapeBrushSettings];this.brushIcons=["write","paint brush"];this.selectedBrush=this.items[0];this.descriptor=new Painter.BrushDescriptor(this);var a;this.getSettingsByItem=function(a){return this.settingsItems[this.items.indexOf(a)]};this.getCursor=function(){return"url(assets/image/cursors/CrossHair.gif) 7 7,auto"};this.getDragView=function(){return this.selectedBrush.getDragView()};
this.setDrawCanvasAndBufferCanvas=function(a,c){this.selectedBrush.setDrawCanvasAndBufferCanvas(a,c);this.selectedBrush.useSettings(this.getSettingsByItem(this.selectedBrush))};this.mousedown=function(b){this.selectedBrush.mousedown(b);a={};a.mousedownPoint=b;a.mousemovePoints=[]};this.mousemove=function(b){this.selectedBrush.mousemove(b);a.mousemovePoints.push(b)};this.mouseup=function(b){this.selectedBrush.mouseup(b);a.mouseupPoint=b};this.getAction=function(){a.brush=this.selectedBrush;a.brushSettings=
this.selectedBrush.settings.clone();var b=new Painter.Shape(a);return new Painter.LayerAction(Painter.LayerActionType.AddShape,b)}};Painter.Eraser=function(){this.settings=new Painter.LineBrushSettings;this.settings.globalCompositeOperation="destination-out";this.settings.lineCap="round";this.settings.lineJoin="round";this.brush=new Painter.LineBrush;this.descriptor=new Painter.EraserDescriptor(this);this.getCursor=function(){return"url(assets/image/cursors/eraser.png) 15 18,auto"};var a;this.getDragView=function(){a==void 0&&(a=new Painter.BasicDragView);return a};var b={};this.setDrawCanvasAndBufferCanvas=function(a,b){this.brush.setDrawCanvasAndBufferCanvas(a,
b);this.brush.useSettings(this.settings)};this.mousedown=function(a){this.brush.mousedown(a);b.mousedownPoint=a;b.mousemovePoints=[]};this.mousemove=function(a){this.brush.mousemove(a);b.mousemovePoints.push(a)};this.mouseup=function(a){this.brush.mouseup(a);b.mouseupPoint=a};this.getAction=function(){b.brush=this.brush;b.brushSettings=this.settings.clone();var a=new Painter.Shape(b);return new Painter.LayerAction(Painter.LayerActionType.AddShape,a)}};Painter.ColorSucker=function(){this.descriptor=new Painter.ColorSuckerDescriptor(this);this.getCursor=function(){return"url(assets/image/cursors/Eyedropper.png) 18 18,auto"};this.getDragView=function(){};this.setDrawCanvasAndBufferCanvas=function(a){this.canvas=a};this.mousedown=function(a){a=getCanvasPixelColor(this.canvas,a.x,a.y);a=tinycolor({r:a.r,g:a.b,b:a.g});this.setPainterColor(a.toHexString())};this.mousemove=function(){};this.mouseup=function(){};this.getAction=function(){};this.setPainterColor=
function(a){var b=[],c=[],d=[];$.each(Painter.toolPanel.getBrush().settingsItems,function(){b.push(this);c.push(this.color);d.push(a)});b.push(Painter.toolPanel.getPaintBucket().settings);c.push(Painter.toolPanel.getPaintBucket().settings);d.push(a);Painter.HistoryManager.addEditAction("suckColor",c,d,function(a){$.each(b,function(b){this.color=a[b]})})}};Painter.PaintBucket=function(){this.settings=new Painter.PaintBucketSettings;this.descriptor=new Painter.PaintBucketDescriptor(this);var a;this.getCursor=function(){return"url(assets/image/cursors/bucket.png) 16 15,auto"};this.getDragView=function(){};this.setDrawCanvasAndBufferCanvas=function(){};this.mousedown=function(b){a={};a.point=b};this.mousemove=function(){};this.mouseup=function(){};this.getAction=function(){a.settings=this.settings.clone();return new Painter.LayerAction(Painter.LayerActionType.FloodFill,
a)}};Painter.PropertiesPanel=function(){this.view=$("#propertiesPanel");this.header=this.view.find("#header");this.form=this.view.find(".ui.form");this.layoutPanel=this.view.find("#layoutPanel");this.setTargets=function(a){this.clear();a.length==1&&a[0].descriptor.init(this)};this.clear=function(){this.view.find(".ui.dropdown").dropdown("hide");var a=$(document).find(".colpick.colpick_hex");a.length>0&&a.each(function(){$(this).data("colpick").clear();$(this).remove()});this.header.text("");this.form.empty();
this.layoutPanel.empty()}};Painter.BrushDescriptor=function(a){var b=this;this.title="\u753b\u7b14";this.init=function(c){function d(b){e.empty();a.items[b].descriptor.init(e,a.settingsItems[b])}c.header.text(this.title);var f=Painter.FormViewManager.createIconButtonGroupView("\u7c7b\u578b",function(){var b=[];$.each(a.items,function(c){var d={};d.icon=a.brushIcons[c];d.value=c;b.push(d)});return b}());f.appendTo(c.form);this.typeToggle=new Painter.ButtonGroupSwitcher(f,this.getType());var e=$("<div>");e.appendTo(c.form);d(this.getType());
this.typeToggle.onChange=function(a){var c=b.getType();Painter.HistoryManager.addEditAction("switchBrush",c,a,function(a){b.typeToggle.setValue(a);d(a);b.setType(a)})}};this.getType=function(){return a.items.indexOf(a.selectedBrush).toString()};this.setType=function(b){b=parseInt(b);a.selectedBrush=a.items[b];Painter.editor.getEditorCanvas().setDragView(a.selectedBrush.getDragView())}};Painter.EraserDescriptor=function(a){var b=this;this.title="\u6a61\u76ae\u64e6";this.init=function(a){a.header.text(this.title);var d=Painter.FormViewManager.createSliderView("\u5927\u5c0f");d.appendTo(a.form);this.sizeSlider=new Painter.Slider(d,1,100,this.getSize());d=Painter.FormViewManager.createSliderView("\u900f\u660e\u5ea6");d.appendTo(a.form);this.alphaSlider=new Painter.Slider(d,0,1,this.getAlpha());d=Painter.FormViewManager.createIconButtonGroupView("\u5f62\u72b6",[{icon:"circle",value:"circle"},
{icon:"stop brush",value:"box"}]);d.appendTo(a.form);this.shapeToggle=new Painter.ButtonGroupSwitcher(d,this.getShapeStyle());this.sizeSlider.onChange=function(a){var c=b.getSize();Painter.HistoryManager.addEditAction("editEraser",c,a,function(a){b.setSize(a);b.sizeSlider.setValue(a)})};this.alphaSlider.onChange=function(a){var c=b.getAlpha();Painter.HistoryManager.addEditAction("editEraser",c,a,function(a){b.setAlpha(a);b.alphaSlider.setValue(a)})};this.shapeToggle.onChange=function(a){var c=b.getShapeStyle();
Painter.HistoryManager.addEditAction("editEraser",c,a,function(a){b.setShapeStyle(a);b.shapeToggle.setValue(a)})}};this.getSize=function(){return a.settings.size};this.setSize=function(b){a.settings.size=b;a.getDragView().setSize(b)};this.getAlpha=function(){return a.settings.alpha};this.setAlpha=function(b){a.settings.alpha=b};this.getShapeStyle=function(){return a.settings.lineCap=="round"?"circle":"box"};this.setShapeStyle=function(b){b=="circle"?(a.settings.lineCap="round",a.settings.lineJoin=
"round"):(a.settings.lineCap="square",a.settings.lineJoin="miter");a.getDragView().setShape(b)}};Painter.ColorSuckerDescriptor=function(){this.title="\u5438\u8272\u5de5\u5177";this.init=function(a){a.header.text(this.title);$("<div>\u65e0\u4efb\u4f55\u5c5e\u6027</div>").appendTo(a.form)}};Painter.PaintBucketDescriptor=function(a){var b=this;this.title="\u6cb9\u6f06\u6876";this.init=function(a){a.header.text(this.title);var d=Painter.FormViewManager.createColorPickerView("\u586b\u5145\u989c\u8272");d.appendTo(a.form);this.colorPicker=new Painter.ColorPicker(this.getColor(),d.find(".colorPicker"));d=Painter.FormViewManager.createSliderView("\u5bb9\u8bb8\u5ea6");d.appendTo(a.form);this.allowFactorSlider=new Painter.Slider(d,0,100,this.getAllowFactor());this.colorPicker.onSubmit=function(a){var d=
b.getColor();d!=a&&Painter.HistoryManager.addEditAction("editBucket",d,a,function(a){b.colorPicker.setColor(a);b.setColor(a)})};this.allowFactorSlider.onChange=function(a){var d=b.getAllowFactor();Painter.HistoryManager.addEditAction("editBucket",d,a,function(a){b.allowFactorSlider.setValue(a);b.setAllowFactor(a)})}};this.getColor=function(){return a.settings.color};this.setColor=function(b){a.settings.color=b};this.getAllowFactor=function(){return a.settings.allowFactor};this.setAllowFactor=function(b){a.settings.allowFactor=
b}};Painter.FormViewManager={};Painter.FormViewManager.createHline=function(){return $('<div class="ui divider"></div>')};Painter.FormViewManager.createCheckBoxView=function(a){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui checkbox">\t\t\t<input type="checkbox">\t\t\t<label></label>\t\t</div>\t</div></div>')};
Painter.FormViewManager.createDropdownView=function(a,b){for(var c=$('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui selection dropdown">\t\t\t<i class="dropdown icon"></i>\t\t\t<div class="default text"></div>\t\t\t<div class="menu">\t\t\t</div>\t\t</div>\t</div></div>'),d=c.find(".menu"),f=b.length,e=0;e<f;e++)$('<div class="item" data-value="'+b[e].value+'">'+b[e].label+"</div>").appendTo(d);return c};
Painter.FormViewManager.createHeaderView=function(a){return $('<div class="ui small header">'+a+"</div>")};Painter.FormViewManager.createColorPickerView=function(a){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="colorPicker">\t\t\t<div class="box"></div>\t\t</div>\t</div></div>')};
Painter.FormViewManager.createTextInputView=function(a){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<input type="text" placeholder="">\t</div></div>')};
Painter.FormViewManager.createTextInputWithRightLabelView=function(a,b){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui right labeled input">\t\t\t<input type="text" placeholder="">\t\t\t<div class="ui basic label">'+b+"</div>\t\t</div>\t</div></div>")};Painter.FormViewManager.createTextAreaView=function(a){return $('<div class="field">\t<label>'+a+'</label>\t<textarea style="margin-top: 0px; margin-bottom: 0px; height: 148px;"></textarea></div>')};
Painter.FormViewManager.createSliderView=function(a){return $('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eight wide field">\t\t<div class="ui slider" style="width:95%"></div>\t</div>\t<div class="four wide field">\t\t<input type="text" placeholder="">\t</div></div>')};
Painter.FormViewManager.createIconButtonGroupView=function(a,b){for(var c=$('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui icon basic buttons"></div>\t</div></div>'),d=c.find(".buttons"),f=0;f<b.length;f++)$('<button class="ui button" data-value="'+b[f].value+'"><i class="'+b[f].icon+' icon"></i></button>').appendTo(d);return c};
Painter.FormViewManager.createButtonGroupView=function(a,b){for(var c=$('<div class="inline fields">\t<div class="five wide field">\t\t<label>'+a+'</label>\t</div>\t<div class="eleven wide field">\t\t<div class="ui icon basic buttons"></div>\t</div></div>'),d=c.find(".buttons"),f=0;f<b.length;f++)$('<button class="ui button" data-value="'+b[f].value+'">'+b[f].label+"</button>").appendTo(d);return c};Painter.ColorPicker=function(a,b){var c=this;this.view=b;if(this.view==void 0)this.view=$('<div class="colorPicker"><div class="box"></div></div>');var d=this.view.find(".box");this.view.colpick({flat:!1,layout:"hex",submit:1,onChange:function(a,b){var d;if(c.onChange!=void 0)c.onChange("#"+b)},onSubmit:function(a,b){var g="#"+b;d.css("background-color",g);if(c.onSubmit!=void 0)c.onSubmit(g)},color:a});d.css("background-color",a);this.setColor=function(a){d.css("background-color",a);this.view.colpickSetColor(a)}};Painter.Layer=function(a){var b=[],c;this.getCanvas=function(){c==void 0&&(c=$("<canvas>"),c.css("position","absolute"),c.attr("width",a.view.outerWidth()),c.attr("height",a.view.outerHeight()));return c};this.setName=function(a){this.getCanvas().attr("name",a)};this.getName=function(){return this.getCanvas().attr("name")};this.setSelected=function(a){this.getCanvas().attr("selected",a)};this.getSelected=function(){return this.getCanvas().hasAttribute("selected")};this.setVisible=function(a){a?this.getCanvas().show():
this.getCanvas().hide()};this.getVisible=function(){return this.getCanvas().css("display")!="none"};this.setAlpha=function(a){this.getCanvas().css("opacity",a)};this.getAlpha=function(){return this.getCanvas().css("opacity")};this.repaint=function(){this.clear();for(var a=0;a<b.length;)b[a].effectTo(this),a++};this.clear=function(){this.getCanvas().get(0).getContext("2d").clearRect(0,0,a.view.outerWidth(),a.view.outerHeight())};this.setBackgroundColor=function(b){this.clear();var c=this.getCanvas().get(0).getContext("2d");
c.save();c.fillStyle=b;c.fillRect(0,0,a.view.outerWidth(),a.view.outerHeight());c.restore()};this.addAction=function(a){b.push(a);a.effectTo(this)};this.removeAction=function(a){a=b.indexOf(a);b.splice(a,1);this.repaint()}};Painter.LayerActionType={AddShape:0,FloodFill:1,ApplyFilter:2,SetBackgroundColor:3,SetData:4};
Painter.LayerAction=function(a,b){this.type=a;switch(a){case Painter.LayerActionType.AddShape:this.shape=b;break;case Painter.LayerActionType.FloodFill:this.floodFill=b;break;case Painter.LayerActionType.ApplyFilter:this.filter=b;break;case Painter.LayerActionType.SetBackgroundColor:this.backgroundColor=b;break;case Painter.LayerActionType.SetData:this.data=b}this.effectTo=function(a){switch(this.type){case Painter.LayerActionType.AddShape:this.shape.paintTo(a);break;case Painter.LayerActionType.FloodFill:var b=
tinycolor(this.floodFill.settings.color),b=b.toRgb();floodFillLinear(a.getCanvas().get(0),this.floodFill.point.x,this.floodFill.point.y,[b.r,b.g,b.b,b.a*255],this.floodFill.settings.allowFactor);break;case Painter.LayerActionType.ApplyFilter:var b=a.getCanvas().get(0).getContext("2d"),f=a.getCanvas().get(0).width,a=a.getCanvas().get(0).height,a=b.getImageData(0,0,f,a);JSManipulate[this.filter.name].filter(a,this.filter.option);b.putImageData(a,0,0);break;case Painter.LayerActionType.SetBackgroundColor:a.setBackgroundColor(this.backgroundColor);
break;case Painter.LayerActionType.SetData:b=a.getCanvas().get(0).getContext("2d"),b.putImageData(this.data,0,0)}};this.getJsonObj=function(){var a={};a.type=this.type;switch(this.type){case Painter.LayerActionType.AddShape:a.shape=this.shape.getJsonObj();break;case Painter.LayerActionType.FloodFill:a.floodFill=this.floodFill;break;case Painter.LayerActionType.ApplyFilter:a.filter=this.filter;break;case Painter.LayerActionType.SetBackgroundColor:a.backgroundColor=this.backgroundColor;break;case Painter.LayerActionType.SetData:var b=
$("<canvas>").get(0);b.width=this.data.width;b.height=this.data.height;b.getContext("2d").putImageData(this.data,0,0);a.data=b.toDataURL()}return a}};Painter.Shape=function(a){this.brush=a.brush;this.brushSettings=a.brushSettings;this.mousedownPoint=a.mousedownPoint;this.mousemovePoints=a.mousemovePoints;this.mouseupPoint=a.mouseupPoint;this.paintTo=function(a){var c=Painter.editor.getEditorCanvas().bufferCanvas.get(0);this.brush.setDrawCanvasAndBufferCanvas(a.getCanvas().get(0),c);var d=this.brushSettings.clone();d.globalCompositeOperation="source-over";if(d.style==0)d.alpha=1;this.brush.useSettings(d);this.brush.mousedown(this.mousedownPoint);
for(d=0;d<this.mousemovePoints.length;)this.brush.mousemove(this.mousemovePoints[d]),d++;this.brush.mouseup(this.mouseupPoint);a=a.getCanvas().get(0).getContext("2d");a.save();a.globalCompositeOperation=this.brushSettings.globalCompositeOperation;if(this.brushSettings.style==0)a.globalAlpha=this.brushSettings.alpha;a.drawImage(c,0,0);a.restore();c.getContext("2d").clearRect(0,0,c.width,c.height)};this.getJsonObj=function(){var a={};a.brushIdx=Painter.toolPanel.getBrush().items.indexOf(this.brush);
a.brushIdx=a.brushIdx==-1?0:a.brushIdx;a.brushSettings=this.brushSettings;a.mousedownPoint=this.mousedownPoint;a.mousemovePoints=this.mousemovePoints;a.mouseupPoint=this.mouseupPoint;return a}};Painter.PreviewView=function(){var a=$("#previewContainer"),b,c,d;this.init=function(f){d=f;b=$("<div>");b.css("position","absolute");b.css("background-image","url(assets/image/alphaBg.png)");b.appendTo(a);c=$("<canvas>");c.css("position","absolute");c.appendTo(b);this.update();var e=this;d.view.on("editCanvasUpdate",function(){e.update()})};this.update=function(){var f=a.prev().outerHeight(),e=d.view.outerWidth(),g=d.view.outerHeight(),j=a.outerWidth(),h=a.outerHeight()-f,k=j/e<h/g?j/e:h/g;e*=k;
g*=k;j=(j-e)*0.5;h=(h-g)*0.5;e=Math.round(e);g=Math.round(g);b.outerWidth(e);b.outerHeight(g);b.css("left",j);b.css("top",h+f);c.attr("width",e);c.attr("height",g);f=c.get(0).getContext("2d");f.clearRect(0,0,c.get(0).width,c.get(0).height);for(h=0;h<d.getLayers().length;){e=d.getLayers()[h];if(e.getVisible())j=e.getCanvas().get(0),f.save(),f.globalAlpha=e.getAlpha(),f.drawImage(j,0,0,j.width,j.height,0,0,c.get(0).width,c.get(0).height),f.restore();h++}}};Painter.HistoryPanel=function(){function a(){var a=Painter.HistoryManager.items.length,b=Painter.HistoryManager.idx;a==0?(d.addClass("disabled"),f.addClass("disabled"),e.addClass("disabled")):(e.removeClass("disabled"),b==a-1?(f.addClass("disabled"),d.removeClass("disabled")):(b==-1?d.addClass("disabled"):d.removeClass("disabled"),f.removeClass("disabled")));g.empty();a=Painter.HistoryManager.items.length;if(a==0)g.text("\u6ca1\u6709\u4efb\u4f55\u5386\u53f2\u8bb0\u5f55");else for(var b=[],c=Painter.HistoryManager.idx,
i=0;i<a;i++){var m=new Painter.HistoryItemView(Painter.HistoryManager.items[i]);m.view.prependTo(g);b.push(m);i==c&&b[i].view.addClass("active")}}var b=$("#historyPanel"),c=b.find(".ui.tab.segment .menu .item"),d=c.eq(0),f=c.eq(1),e=c.eq(2),g=b.find(".ui.tab.segment .list");a();d.click(function(){Painter.HistoryManager.undo()});f.click(function(){Painter.HistoryManager.redo()});e.click(function(){Painter.HistoryManager.removeAll()});$(document).bind(Painter.HistoryManager.UPDATE,a);this.getUndoAble=
function(){return!d.hasClass("disabled")};this.getRedoAble=function(){return!f.hasClass("disabled")}};
Painter.HistoryItemView=function(a){var b={switchTool:{icon:"check circle icon",label:"\u5207\u6362\u4e86\u5de5\u5177"},newLayer:{icon:"add circle icon",label:"\u6dfb\u52a0\u4e86\u56fe\u5c42"},removeLayer:{icon:"trash icon",label:"\u5220\u9664\u4e86\u56fe\u5c42"},editLayer:{icon:"edit icon",label:"\u7f16\u8f91\u4e86\u56fe\u5c42"},selectLayer:{icon:"check circle icon",label:"\u9009\u62e9\u4e86\u56fe\u5c42"},moveLayer:{icon:"move icon",label:"\u79fb\u52a8\u4e86\u56fe\u5c42"},paint:{icon:"paint brush icon",
label:"\u6539\u53d8\u4e86\u56fe\u5c42"},switchBrush:{icon:"edit icon",label:"\u5207\u6362\u4e86\u753b\u7b14"},editBrush:{icon:"edit icon",label:"\u7f16\u8f91\u4e86\u753b\u7b14"},editEraser:{icon:"edit icon",label:"\u7f16\u8f91\u4e86\u6a61\u76ae\u64e6"},editBucket:{icon:"edit icon",label:"\u7f16\u8f91\u4e86\u6cb9\u6f06\u6876"},suckColor:{icon:"eyedropper icon",label:"\u5438\u53d6\u4e86\u989c\u8272"},changeSize:{icon:"edit icon",label:"\u6539\u53d8\u4e86\u753b\u5e03\u5927\u5c0f"}};this.view=$('<div class="item"></div>');
this.icon=$('<i class="'+b[a.type].icon+'"></i>');this.content=$('<div class="content"><div class="header">'+b[a.type].label+"</div></div>");this.icon.appendTo(this.view);this.content.appendTo(this.view);this.view.click(function(){Painter.HistoryManager.go(a)})};Painter.HistoryManager={};Painter.HistoryManager.UPDATE="historyManagerUpdate";Painter.HistoryManager.maxLen=50;Painter.HistoryManager.items=[];Painter.HistoryManager.idx=-1;Painter.HistoryManager.add=function(a,b,c){for(;this.items.length-1>this.idx;)this.items.pop();a=new Painter.HistoryItem(a,b,c);this.items.push(a);this.items.length>this.maxLen&&this.items.shift();a.redo();this.idx=this.items.length-1;$(document).trigger(Painter.HistoryManager.UPDATE)};
Painter.HistoryManager.undo=function(){this.idx>-1&&(this.items[this.idx].undo(),this.idx--,$(document).trigger(Painter.HistoryManager.UPDATE))};Painter.HistoryManager.redo=function(){this.idx<this.items.length-1&&(this.idx++,this.items[this.idx].redo(),$(document).trigger(Painter.HistoryManager.UPDATE))};Painter.HistoryManager.removeAll=function(){for(;this.items.length>0;)this.items.pop();this.idx=-1;$(document).trigger(Painter.HistoryManager.UPDATE)};
Painter.HistoryManager.go=function(a){for(a=this.items.indexOf(a);this.idx!=a;)a<this.idx?(this.items[this.idx].undo(),this.idx--):(this.idx++,this.items[this.idx].redo());$(document).trigger(Painter.HistoryManager.UPDATE)};Painter.HistoryItem=function(a,b,c){this.type=a;this.undo=b;this.redo=c};Painter.HistoryManager.addEditAction=function(a,b,c,d){this.add(a,function(){d(b)},function(){d(c)})};Painter.Slider=function(a,b,c,d){var f=this,e=a.find(".ui.slider").get(0);noUiSlider.create(e,{start:[d],range:{min:[b],max:[c]}});var g=a.find("input").get(0);e.noUiSlider.on("update",function(a,b){g.value=a[b]});g.addEventListener("change",function(){e.noUiSlider.set(this.value);if(f.onChange!=void 0)f.onChange(this.value)});e.noUiSlider.on("change",function(){var a=f.getValue();if(f.onChange!=void 0)f.onChange(a)});this.getValue=function(){return e.noUiSlider.get()};this.setValue=function(a){e.noUiSlider.set(a)}};Painter.ButtonGroupSwitcher=function(a,b){var c=this,d=a.find("button"),f=-1,e=[];d.each(function(a,b){$(b).click(function(){if(f!=a&&(c.selectIdx(a),c.onChange!=void 0))c.onChange(c.getValue())});e.push($(b).attr("data-value"))});this.selectIdx=function(a){f>-1&&d.eq(f).removeClass("active");f=a;d.eq(a).addClass("active")};this.setValue=function(a){this.selectIdx(e.indexOf(a))};this.getValue=function(){return e[f]};b!=void 0&&this.setValue(b)};Painter.MaterialPicker=function(a,b){function c(a){if(d.getValue()!=a&&(d.setValue(a),d.onChange!=void 0))d.onChange(a)}var d=this,f=a.find(".colorPicker"),e=f.find(".box");f.click(function(){Painter.materialSelectWin.show(d.getValue(),c)});this.getValue=function(){return _value};this.setValue=function(a){_value=a;a==""?e.css("background-image","url(assets/image/alphaBg.png)"):e.css("background-image","url("+a+")")};this.setValue(b)};
Painter.MaterialSelectWin=function(){function a(a){g!=void 0&&g.setSelected(!1);g=a;a.setSelected(!0)}function b(b){$.each(e,function(){b=b==""?"assets/image/alphaBg.png":b;this.url==b&&a(this)})}var c=this,d=$("#materialSelectWin"),f=d.find(".content"),e=[],g;d.find(".actions button").click(function(){if(g!=void 0){var a=g.url;c.onSelect(a=="assets/image/alphaBg.png"?"":a);d.modal("hide")}});var j=Painter.MaterialList.concat();j.unshift("alphaBg.png");$.each(j,function(){var b=new Painter.ImageSelectableItem("assets/image/"+
this);e.push(b);b.view.appendTo(f);b.view.click(function(){a(b)})});$('<div style="clear: both;"></div>').appendTo(f);this.show=function(a,c){this.onSelect=c;b(a);d.modal("show")}};
Painter.ImageSelectableItem=function(a){this.url=a;this.view=$('<div class="imageItem">');var b=$("<div>");b.appendTo(this.view);b.css("background-image","url("+a+")");$('<div class="icon"><i class="check circle icon yellow large"></i></div>').appendTo(this.view);this.setSelected=function(a){a?this.view.addClass("selected"):this.view.removeClass("selected")}};Painter.BrushShapePicker=function(a,b){function c(a){if(d.getValue()!=a&&(d.setValue(a),d.onChange!=void 0))d.onChange(a)}var d=this,f=a.find(".colorPicker"),e=f.find(".box");e.css("background-color","#000000");e.css("background-size","contain");f.click(function(){Painter.brushShapeSelectWin.show(d.getValue(),c)});this.getValue=function(){return _value};this.setValue=function(a){_value=a;e.css("background-image","url("+a.src+")")};this.setValue(b)};
Painter.BrushShapeSelectWin=function(){function a(a){g!=void 0&&g.setSelected(!1);g=a;a.setSelected(!0)}function b(b){$.each(e,function(){this.url==b&&a(this)})}var c=this,d=$("#brushShapeSelectWin"),f=d.find(".content"),e=[],g;d.find(".actions button").click(function(){if(g!=void 0){var a=g.url,b=g.view.attr("shape");c.onSelect({src:a,style:b});d.modal("hide")}});$.each(Painter.ShapeList,function(){var b=new Painter.ImageSelectableItem(this.src);b.view.attr("shape",this.style);var c=b.view.children().eq(0);
c.css("background-color","#000000");c.css("background-size","contain");e.push(b);b.view.appendTo(f);b.view.click(function(){a(b)})});$('<div style="clear: both;"></div>').appendTo(f);this.show=function(a,c){this.onSelect=c;b(a.src);d.modal("show")}};Painter.LayerPanel=function(){function a(a){var b=this,c=a.find(".ui.slider"),d=a.find("#alphaValue");noUiSlider.create(c.get(0),{start:[1],range:{min:[0],max:[1]}});c.get(0).noUiSlider.on("update",function(a,b){d.text(a[b])});c.get(0).noUiSlider.on("change",function(){var a=b.getValue();if(b.onChange!=void 0)b.onChange(a)});this.getValue=function(){return c.get(0).noUiSlider.get()};this.setValue=function(a){c.get(0).noUiSlider.set(a)}}var b=$("#layerPanel"),c=new function(){var c=b.find("#layerToolBar"),
d=new a(c);d.onChange=function(a){Painter.editor.getEditorCanvas().changeSelectedLayerAlpha(a)};var g=c.find("button");g.click(function(){[function(){Painter.editor.getEditorCanvas().newLayer()},function(){Painter.editor.getEditorCanvas().removeSelectedLayer()},function(){Painter.editor.getEditorCanvas().moveSelectedLayer("top")},function(){Painter.editor.getEditorCanvas().moveSelectedLayer("bottom")},function(){Painter.editor.getEditorCanvas().moveSelectedLayer("up")},function(){Painter.editor.getEditorCanvas().moveSelectedLayer("down")},
function(){Painter.filterWin.show()}][g.index($(this))]()});this.getAlphaSlider=function(){return d}},d=new function(){function a(b){var c;$.each(g,function(){this.layer===b&&(c=this)});return c}var d=b.find(".ui.selection.list"),g=[];this.addItem=function(a,b){var c=new Painter.LayerItemView(a);b==void 0||b!=void 0&&b>g.length-1?(c.view.prependTo(d),g.push(c)):(c.view.insertAfter(g[b].view),g.splice(b,0,c))};this.selectItemByLayer=function(b){a(b).setSelected(!0);c.getAlphaSlider().setValue(b.getAlpha())};
this.unSelectItemByLayer=function(b){a(b).setSelected(!1)};this.removeItemByLayer=function(b){var b=a(b),c=g.indexOf(b);g.splice(c,1);b.view.remove()};this.setLayerAlpha=function(b,c){a(b).setAlpha(c)};this.setLayerVisible=function(b,c){a(b).setVisible(c)};this.setLayerName=function(b,c){a(b).setName(c)};this.moveItemByLayer=function(b,c){function k(){var a=g.indexOf(l),b=a+1;l.view.insertBefore(g[b].view);g.splice(a,1);g.splice(b,0,l)}function i(){var a=g.indexOf(l),b=a-1;l.view.insertAfter(g[b].view);
g.splice(a,1);g.splice(b,0,l)}function m(){var a=g.indexOf(l);l.view.prependTo(d);g.splice(a,1);g.push(l)}function n(){var a=g.indexOf(l);l.view.appendTo(d);g.splice(a,1);g.unshift(l)}var l=a(b);switch(c){case "up":k();break;case "down":i();break;case "top":m();break;case "bottom":n()}};this.moveTopItemToIdxByLayer=function(b,c){var d=a(b);d.view.insertAfter(g[c].view);g.pop();g.splice(c,0,d)};this.moveBottomItemToIdxByLayer=function(b,c){var d=a(b);d.view.insertBefore(g[c].view);g.shift();g.splice(c,
0,d)}};this.getLayerListController=function(){return d};this.getToolBarController=function(){return c}};
Painter.LayerItemView=function(a){function b(a){var b=f.find("i");a?(b.addClass("unhide"),b.removeClass("hide")):(b.removeClass("unhide"),b.addClass("hide"))}this.layer=a;var c='<div class="item">';c+='\t<div class="right floated content">';c+='\t\t<span style="margin-right: 10px;">100</span>';c+='\t\t<button class="ui icon basic button"><i class="unhide icon"></i></button>';c+="\t</div>";c+=' <div class="content">';c+='     <div class="ui input" style="width: 155px;"><input type="text" value=""></div>';
c+=" </div>";c+="</div>";this.view=$(c);var d=this.view.find("input"),f=this.view.find("button"),e=this.view.find("span");d.val(a.getName());e.text(a.getAlpha());b(a.getVisible());f.click(function(b){b.stopImmediatePropagation();b=!a.getVisible();Painter.editor.getEditorCanvas().setLayerVisible(a,b)});d.click(function(a){a.stopImmediatePropagation()});d.change(function(){Painter.editor.getEditorCanvas().setLayerName(a,this.value)});this.view.click(function(){Painter.editor.getEditorCanvas().selectLayer(a)});
this.setSelected=function(b){b?this.view.addClass("active"):this.view.removeClass("active");a.setSelected(b)};this.setAlpha=function(b){e.text(b);a.setAlpha(b)};this.setVisible=function(c){b(c);a.setVisible(c)};this.setName=function(b){d.val(b);a.setName(b)}};Painter.KeyboardManager={};
Painter.KeyboardManager.init=function(){$(window).keydown(function(a){switch(a.keyCode){case 70:a.ctrlKey&&a.preventDefault();case 78:a.ctrlKey&&a.preventDefault();break;case 79:a.ctrlKey&&a.preventDefault();break;case 83:a.ctrlKey&&a.preventDefault();break;case 85:a.ctrlKey&&a.preventDefault();break;case 49:(a.ctrlKey||a.shiftKey)&&a.preventDefault();break;case 50:(a.ctrlKey||a.shiftKey)&&a.preventDefault();break;case 51:(a.ctrlKey||a.shiftKey)&&a.preventDefault();break;case 89:a.ctrlKey&&a.preventDefault();
break;case 90:a.ctrlKey&&a.preventDefault()}});$(window).keyup(function(a){switch(a.keyCode){case 79:a.ctrlKey&&Painter.KeyboardManager.execute("Ctrl+O");break;case 83:a.ctrlKey&&Painter.KeyboardManager.execute("Ctrl+S");break;case 90:a.ctrlKey&&Painter.KeyboardManager.execute("Ctrl+Z");break;case 89:a.ctrlKey&&Painter.KeyboardManager.execute("Ctrl+Y");break;case 77:a.ctrlKey&&Painter.KeyboardManager.execute("Ctrl+M");break;case 78:a.ctrlKey&&Painter.KeyboardManager.execute("Ctrl+N");break;case 46:Painter.KeyboardManager.execute("Delete");
break;case 49:a.ctrlKey&&a.shiftKey?Painter.KeyboardManager.execute("Ctrl+Shift+1"):a.ctrlKey?Painter.KeyboardManager.execute("Ctrl+1"):a.shiftKey&&Painter.KeyboardManager.execute("Shift+1");break;case 50:a.ctrlKey&&a.shiftKey?Painter.KeyboardManager.execute("Ctrl+Shift+2"):a.ctrlKey?Painter.KeyboardManager.execute("Ctrl+2"):a.shiftKey&&Painter.KeyboardManager.execute("Shift+2");break;case 51:a.ctrlKey&&a.shiftKey?Painter.KeyboardManager.execute("Ctrl+Shift+3"):a.ctrlKey?Painter.KeyboardManager.execute("Ctrl+3"):
a.shiftKey&&Painter.KeyboardManager.execute("Shift+3");break;case 52:a.shiftKey&&Painter.KeyboardManager.execute("Shift+4");break;case 38:a.preventDefault();a.ctrlKey&&a.shiftKey?Painter.KeyboardManager.execute("Ctrl+Shift+\u2191"):a.ctrlKey&&Painter.KeyboardManager.execute("Ctrl+\u2191");break;case 40:a.preventDefault();a.ctrlKey&&a.shiftKey?Painter.KeyboardManager.execute("Ctrl+Shift+\u2193"):a.ctrlKey&&Painter.KeyboardManager.execute("Ctrl+\u2193");break;case 70:a.ctrlKey&&Painter.KeyboardManager.execute("Ctrl+F");
break;case 85:a.ctrlKey&&Painter.KeyboardManager.execute("Ctrl+U")}})};
Painter.KeyboardManager.execute=function(a){switch(a){case "Ctrl+N":Painter.editor.getEditorCanvas().newLayer();break;case "Ctrl+F":Painter.filterWin.show();break;case "Delete":Painter.editor.getEditorCanvas().removeSelectedLayer();break;case "Ctrl+Z":Painter.HistoryManager.undo();break;case "Ctrl+Y":Painter.HistoryManager.redo();break;case "Ctrl+\u2191":Painter.editor.getEditorCanvas().moveSelectedLayer("up");break;case "Ctrl+\u2193":Painter.editor.getEditorCanvas().moveSelectedLayer("down");break;
case "Ctrl+Shift+\u2191":Painter.editor.getEditorCanvas().moveSelectedLayer("top");break;case "Ctrl+Shift+\u2193":Painter.editor.getEditorCanvas().moveSelectedLayer("bottom");break;case "Shift+1":Painter.toolPanel.switchToolIdx(0);break;case "Shift+2":Painter.toolPanel.switchToolIdx(1);break;case "Shift+3":Painter.toolPanel.switchToolIdx(2);break;case "Shift+4":Painter.toolPanel.switchToolIdx(3);break;case "Ctrl+1":Painter.topMenu.panelMenuController.selectValue("layers");break;case "Ctrl+2":Painter.topMenu.panelMenuController.selectValue("properties");
break;case "Ctrl+3":Painter.topMenu.panelMenuController.selectValue("history");break;case "Ctrl+Shift+1":Painter.mainLayout.toggleLeft();break;case "Ctrl+Shift+2":Painter.mainLayout.toggleRight();break;case "Ctrl+Shift+3":Painter.mainLayout.toggleRightTop();break;case "Ctrl+U":Painter.settingWin.show(0);break;case "showQuickKey":Painter.settingWin.show(1);break;case "about":Painter.settingWin.show(2);break;case "Ctrl+O":Painter.File.openFile();break;case "openPaintPath":Painter.File.openPaintPathFile();
break;case "Ctrl+S":Painter.File.saveFile();break;case "savePaintPath":Painter.File.savePaintPathFile();break;case "export":Painter.File.exportImage();break;case "playPaintPath":Painter.PathPlayer.playCurrent();break;case "Ctrl+M":Painter.editCanvasSizeWin.show();break;case "onlineFile":Painter.onlineFileWin.show()}};$(function(){Painter.KeyboardManager.init()});Painter.BasicBrushDescriptor=function(a){var b=this;this.init=function(a,d){this.settings=d;var f=Painter.FormViewManager.createColorPickerView("\u989c\u8272");f.appendTo(a);this.colorPicker=new Painter.ColorPicker(this.getColor(),f.find(".colorPicker"));f=Painter.FormViewManager.createSliderView("\u5927\u5c0f");f.appendTo(a);this.sizeSlider=new Painter.Slider(f,1,100,this.getSize());f=Painter.FormViewManager.createSliderView("\u900f\u660e\u5ea6");f.appendTo(a);this.alphaSlider=new Painter.Slider(f,
0,1,this.getAlpha());this.colorPicker.onSubmit=function(a){var c=b.getColor();c!=a&&Painter.HistoryManager.addEditAction("editBrush",c,a,function(a){b.setColor(a);b.colorPicker.setColor(a)})};this.sizeSlider.onChange=function(a){var c=b.getSize();Painter.HistoryManager.addEditAction("editBrush",c,a,function(a){b.setSize(a);b.sizeSlider.setValue(a)})};this.alphaSlider.onChange=function(a){var c=b.getAlpha();Painter.HistoryManager.addEditAction("editBrush",c,a,function(a){b.setAlpha(a);b.alphaSlider.setValue(a)})}};
this.getColor=function(){return this.settings.color};this.setColor=function(b){this.settings.color=b;a.getDragView().setColor(b)};this.getSize=function(){return this.settings.size};this.setSize=function(b){this.settings.size=b;a.getDragView().setSize(b)};this.getAlpha=function(){return this.settings.alpha};this.setAlpha=function(a){this.settings.alpha=a}};Painter.LineBrushDescriptor=function(a){Painter.BasicBrushDescriptor.call(this,a);var b=this,c=this.init;this.init=function(a,f){c.call(this,a,f);var e=Painter.FormViewManager.createColorPickerView("\u6750\u8d28");e.appendTo(a);this.materialPicker=new Painter.MaterialPicker(e,this.getMaterial());e=Painter.FormViewManager.createButtonGroupView("lineCap",[{label:"butt",value:"butt"},{label:"round",value:"round"},{label:"square",value:"square"}]);e.appendTo(a);this.lineCapToggle=new Painter.ButtonGroupSwitcher(e,
this.getLineCap());e=Painter.FormViewManager.createButtonGroupView("lineJoin",[{label:"bevel",value:"bevel"},{label:"round",value:"round"},{label:"miter",value:"miter"}]);e.appendTo(a);this.lineJoinToggle=new Painter.ButtonGroupSwitcher(e,this.getLineJoin());e=Painter.FormViewManager.createSliderView("miterLimit");e.appendTo(a);this.miterLimitSlider=new Painter.Slider(e,0,100,this.getMiterLimit());this.lineCapToggle.onChange=function(a){var c=b.getLineCap();Painter.HistoryManager.addEditAction("editBrush",
c,a,function(a){b.setLineCap(a);b.lineCapToggle.setValue(a)})};this.lineJoinToggle.onChange=function(a){var c=b.getLineJoin();Painter.HistoryManager.addEditAction("editBrush",c,a,function(a){b.setLineJoin(a);b.lineJoinToggle.setValue(a)})};this.miterLimitSlider.onChange=function(a){var c=b.getMiterLimit();Painter.HistoryManager.addEditAction("editBrush",c,a,function(a){b.setMiterLimit(a);b.miterLimitSlider.setValue(a)})};this.materialPicker.onChange=function(a){var c=b.getMaterial();Painter.HistoryManager.addEditAction("editBrush",
c,a,function(a){b.setMaterial(a);b.materialPicker.setValue(a)})}};this.getLineCap=function(){return this.settings.lineCap};this.setLineCap=function(b){this.settings.lineCap=b;a.getDragView().setShape(b=="round"?"circle":"box")};this.getLineJoin=function(){return this.settings.lineJoin};this.setLineJoin=function(a){this.settings.lineJoin=a};this.getMiterLimit=function(){return this.settings.miterLimit};this.setMiterLimit=function(a){this.settings.miterLimit=a};this.getMaterial=function(){return this.settings.material};
this.setMaterial=function(a){this.settings.material=a}};Painter.ShapeBrushDescriptor=function(a){Painter.BasicBrushDescriptor.call(this,a);var b=this,c=this.init;this.init=function(a,f){c.call(this,a,f);var e=Painter.FormViewManager.createColorPickerView("\u5f62\u72b6");e.appendTo(a);this.shapePicker=new Painter.BrushShapePicker(e,this.getShape());e=Painter.FormViewManager.createButtonGroupView("\u98ce\u683c",[{label:"\u5e73\u94fa",value:"0"},{label:"\u52a0\u7c97",value:"1"}]);e.appendTo(a);this.styleToggle=new Painter.ButtonGroupSwitcher(e,this.getShapeBrushStyle());
e=Painter.FormViewManager.createSliderView("\u7f29\u653e\u56e0\u5b50");e.appendTo(a);this.scaleFactorSlider=new Painter.Slider(e,-1,1,this.getScaleFactor());e=Painter.FormViewManager.createSliderView("\u95f4\u8ddd");e.appendTo(a);this.spacingSlider=new Painter.Slider(e,1,100,this.getSpacing());this.shapePicker.onChange=function(a){var c=b.getShape();Painter.HistoryManager.addEditAction("editBrush",c,a,function(a){b.shapePicker.setValue(a);b.setShape(a)})};this.styleToggle.onChange=function(a){var c=
b.getShapeBrushStyle();Painter.HistoryManager.addEditAction("editBrush",c,a,function(a){b.setShapeBrushStyle(a);b.styleToggle.setValue(a)})};this.scaleFactorSlider.onChange=function(a){var c=b.getScaleFactor();Painter.HistoryManager.addEditAction("editBrush",c,a,function(a){b.setScaleFactor(a);b.scaleFactorSlider.setValue(a)})};this.spacingSlider.onChange=function(a){var c=b.getSpacing();Painter.HistoryManager.addEditAction("editBrush",c,a,function(a){b.setSpacing(a);b.spacingSlider.setValue(a)})}};
this.getShapeBrushStyle=function(){return this.settings.style.toString()};this.setShapeBrushStyle=function(a){this.settings.style=parseInt(a)};this.getShape=function(){return this.settings.shape};this.setShape=function(b){this.settings.shape=b;a.getDragView().setShape(b.style)};this.getScaleFactor=function(){return this.settings.scaleFactor};this.setScaleFactor=function(a){this.settings.scaleFactor=a};this.getSpacing=function(){return this.settings.spacing};this.setSpacing=function(a){this.settings.spacing=
a}};Painter.BasicDragView=function(){this.view=$("<div>");this.view.css("position","absolute");var a=$("<div>");a.css("position","absolute");a.appendTo(this.view);var b="circle";this.setColor=function(b){a.css("border","solid 1px "+b)};this.setSize=function(c){a.outerWidth(c);a.outerHeight(c);a.css("left",-c*0.5);a.css("top",-c*0.5);c=b=="circle"?a.outerWidth()*0.5:0;a.css("border-radius",c+"px")};this.setShape=function(c){b=c;this.setSize(a.outerWidth())};this.setSize(1);this.setColor("#000000")};Painter.Point=function(a,b){this.x=a;this.y=b};Painter.BasicBrush=function(){this.descriptor=new Painter.BasicBrushDescriptor(this);var a;this.getDragView=function(){a==void 0&&(a=new Painter.BasicDragView);return a};this.useSettings=function(a){this.settings=a}};Painter.LineBrush=function(){Painter.BasicBrush.call(this);this.descriptor=new Painter.LineBrushDescriptor(this);this.setDrawCanvasAndBufferCanvas=function(a,b){this.canvas=a;this.bufferCanvas=b};this.mousedown=function(a){var b=this.bufferCanvas.getContext("2d");b.save();this.applySettings(b);if(b.globalCompositeOperation=="destination-out"){var c=this.canvas.getContext("2d").getImageData(0,0,this.canvas.width,this.canvas.height);b.putImageData(c,0,0);$(this.canvas).hide()}else b.clearRect(0,0,this.bufferCanvas.width,
this.bufferCanvas.height);b.beginPath();b.moveTo(a.x,a.y)};this.mousemove=function(a){var b=this.bufferCanvas.getContext("2d");if(b.globalCompositeOperation=="destination-out"){var c=this.canvas.getContext("2d").getImageData(0,0,this.canvas.width,this.canvas.height);b.putImageData(c,0,0)}else b.clearRect(0,0,this.bufferCanvas.width,this.bufferCanvas.height);b.lineTo(a.x,a.y);b.stroke()};this.mouseup=function(){var a=this.bufferCanvas.getContext("2d");a.closePath();a.restore();$(this.canvas).show()};
this.applySettings=function(a){a.strokeStyle=this.settings.color;if(this.settings.material=="")a.strokeStyle=this.settings.color;else{var b=this.settings.material,c=new Image;c.src=b;b=a.createPattern(c,"repeat");a.strokeStyle=b}a.lineWidth=this.settings.size;a.globalAlpha=this.settings.alpha;a.globalCompositeOperation=this.settings.globalCompositeOperation;a.lineCap=this.settings.lineCap;a.lineJoin=this.settings.lineJoin;a.miterLimit=this.settings.miterLimit}};Painter.ShapeBrush=function(){Painter.BasicBrush.call(this);this.descriptor=new Painter.ShapeBrushDescriptor(this);this.setDrawCanvasAndBufferCanvas=function(a,b){this.canvas=a;this.bufferCanvas=b};var a,b,c;this.initBrush=function(){a==void 0&&(a=$("<canvas width='100' height='100'></canvas>"));var b=a.get(0).getContext("2d"),c=new Image;c.src=this.settings.shape.src;b.clearRect(0,0,a.get(0).width,a.get(0).height);b.drawImage(c,0,0,c.width,c.height,0,0,100,100);var c=b.getImageData(0,0,a.get(0).width,
a.get(0).height),e=tinycolor(this.settings.color).toRgb();JSManipulate.rgbadjust.filter(c,{red:e.r/255,green:e.g/255,blue:e.b/255});b.putImageData(c,0,0)};this.mousedown=function(d){b=d;this.initBrush();var f=this.bufferCanvas.getContext("2d");f.clearRect(0,0,this.bufferCanvas.width,this.bufferCanvas.height);f.save();this.applySettings(f);if(this.settings.style==0)f.globalAlpha=1,$(this.bufferCanvas).css("opacity",this.settings.alpha);else if(this.settings.style==1)f.globalAlpha=this.settings.alpha/
10;var e=this.settings.size;c=e;var g=d.x-e*0.5,d=d.y-e*0.5;f.drawImage(a.get(0),0,0,a.get(0).width,a.get(0).height,g,d,e,e)};this.mousemove=function(d){var f=d.x-b.x,d=d.y-b.y,e=Math.sqrt(f*f+d*d),g=this.settings.size,f=Math.atan2(d,f),d=this.bufferCanvas.getContext("2d"),j=this.settings.spacing;g*=1+(e-j>0?e-j:0)/g*this.settings.scaleFactor;for(var g=g>100?100:g,g=g<1?1:g,e=Math.floor(e/j),h=0;h<e;h++){var k=c+(g-c)*(h/e),i=k,m=b.x+j*(h+1)*Math.cos(f),n=b.y+j*(h+1)*Math.sin(f);d.drawImage(a.get(0),
0,0,a.get(0).width,a.get(0).height,m-k*0.5,n-i*0.5,k,i);h==e-1&&(b=new Painter.Point(m,n))}c=g};this.mouseup=function(){var a=this.bufferCanvas.getContext("2d");if(this.settings.style==0)$(this.bufferCanvas).css("opacity",1),a.globalAlpha=this.settings.alpha;a.restore()};this.applySettings=function(a){a.globalAlpha=this.settings.alpha}};Painter.BasicBrushSettings=function(){this.clone=function(){var a=new Painter.BasicBrushSettings;a.applySettings(this.color,this.size,this.alpha,this.globalCompositeOperation);return a};this.applySettings=function(a,b,c,d){this.color=a;this.size=b;this.alpha=c;this.globalCompositeOperation=d};this.applySettingsFromObj=function(a){for(key in a)this[key]=a[key]};this.applySettings("#000000",1,1,"source-over")};Painter.LineBrushSettings=function(){Painter.BasicBrushSettings.call(this);var a=this.applySettings;this.applySettings=function(b,c,d,f,e,g,j,h){a.call(this,b,c,d,f);this.material=e;this.lineCap=g;this.lineJoin=j;this.miterLimit=h};this.clone=function(){var a=new Painter.LineBrushSettings;a.applySettings(this.color,this.size,this.alpha,this.globalCompositeOperation,this.material,this.lineCap,this.lineJoin,this.miterLimit);return a};this.applySettings(this.color,this.size,this.alpha,this.globalCompositeOperation,
"","round","round",10)};Painter.ShapeBrushSettings=function(){Painter.BasicBrushSettings.call(this);this.clone=function(){var a=new Painter.ShapeBrushSettings;a.applySettings(this.color,this.size,this.alpha,this.globalCompositeOperation,this.scaleFactor,this.shape,this.style,this.spacing);return a};var a=this.applySettings;this.applySettings=function(b,c,d,f,e,g,j,h){a.call(this,b,c,d,f);this.scaleFactor=e;this.shape=g;this.style=j;this.spacing=h};this.applySettings(this.color,this.size,this.alpha,this.globalCompositeOperation,
0,Painter.ShapeList[0],0,1)};Painter.PaintBucketSettings=function(){this.clone=function(){var a=new Painter.PaintBucketSettings;a.applySettings(this.color,this.allowFactor);return a};this.applySettings=function(a,b){this.color=a;this.allowFactor=b};this.applySettings("#000000",80)};Painter.MaterialList=["Patterns/BerberRug.jpg","Patterns/BlueGreen.jpg","Patterns/BlueWave.jpg","Patterns/Bubbles.jpg","Patterns/Cloth-Blue.jpg","Patterns/Cloth-Gray.jpg","Patterns/Cloth-Teal.jpg","Patterns/Cotton.png","Patterns/Course-Orange.jpg","Patterns/DarkFlower.jpg","Patterns/Flames.jpg","Patterns/GlassBubble.jpg","Patterns/Glass-Textured.jpg","Patterns/Goo-Blue.jpg","Patterns/Grass-Large.jpg","Patterns/Illusion1.jpg","Patterns/Illusion2.jpg","Patterns/Impressionist-Blue.jpg","Patterns/Impressionist-Green.jpg",
"Patterns/Leaves.jpg","Patterns/LightPanel.jpg","Patterns/LightPanel2.jpg","Patterns/Metal-Bars.jpg","Patterns/Metal-Bars-Small.jpg","Patterns/Metal-Slip.jpg","Patterns/Metal-Turbine.jpg","Patterns/Moon.jpg","Patterns/MossyRock.jpg","Patterns/OilPaint1.jpg","Patterns/OilPaint2.jpg","Patterns/OilPaint3.jpg","Patterns/PaintBlue.jpg","Patterns/PaintDark.jpg","Patterns/Pits-Green.jpg","Patterns/RedAmber.jpg","Patterns/Sienna.jpg","Patterns/Smear.jpg","Patterns/Smudge-Green.jpg","Patterns/Smudge-Red.jpg",
"Patterns/Static_01.jpg","Patterns/Threads1.jpg","Patterns/Threads2.jpg","Patterns/Threads3.jpg","Patterns/Tweed.png","Patterns/Twill.jpg","Patterns/Violet.jpg","Patterns/Weave.png","Patterns/Wood.jpg","Patterns/Wood2.jpg","Patterns/Wood3.jpg","Textures/Burlap.png","Textures/Chiffon.png","Textures/Confetti.png","Textures/Crosshatch1.gif","Textures/Crosshatch2.gif","Textures/Crosshatch3.gif","Textures/DNA.png","Textures/Dots-large.gif","Textures/Dots-Small.gif","Textures/Dots-Small2.gif","Textures/Fiber.png",
"Textures/Grain.png","Textures/Grass.png","Textures/Grid1.gif","Textures/Grid2.gif","Textures/Grid3.gif","Textures/Grid4.gif","Textures/Grid5.gif","Textures/Grid6.gif","Textures/Grid7.gif","Textures/Hatch1.gif","Textures/Hatch2.gif","Textures/Hatch3.gif","Textures/Hatch4.gif","Textures/Hatch5.gif","Textures/Line-Diag1.gif","Textures/Line-Diag2.gif","Textures/Line-Horiz1.gif","Textures/Line-Horiz2.gif","Textures/Line-Horiz3.gif","Textures/Line-Horiz4.gif","Textures/Line-Vert1.gif","Textures/Line-Vert2.gif",
"Textures/Line-Vert3.gif","Textures/Mesh.png","Textures/Metal.png","Textures/Oilslick.png","Textures/Onyx.png","Textures/Parchment.png","Textures/PianoKeys.png","Textures/PlaidLoose.gif","Textures/PlaidTight.gif","Textures/Plaster.png","Textures/Sand.png","Textures/Sandpaper.png","Textures/Scratch.png","Textures/Smoky.png","Textures/Swirls.png","Textures/Vein.png","Textures/Waffle.gif","Textures/Wood.png"];Painter.ShapeList=[{src:"assets/image/customBrush/circle.png",style:"circle"},{src:"assets/image/customBrush/circle0.png",style:"circle"},{src:"assets/image/customBrush/circle1.png",style:"circle"},{src:"assets/image/customBrush/circle2.png",style:"circle"},{src:"assets/image/customBrush/circle3.png",style:"circle"},{src:"assets/image/customBrush/circle4.png",style:"circle"},{src:"assets/image/customBrush/box.png",style:"box"},{src:"assets/image/customBrush/b0.png",style:"circle"},{src:"assets/image/customBrush/b1.png",
style:"circle"},{src:"assets/image/customBrush/b2.png",style:"circle"},{src:"assets/image/customBrush/b3.png",style:"circle"},{src:"assets/image/customBrush/b4.png",style:"circle"},{src:"assets/image/customBrush/b5.png",style:"circle"},{src:"assets/image/customBrush/b6.png",style:"box"},{src:"assets/image/customBrush/b7.png",style:"box"},{src:"assets/image/customBrush/b8.png",style:"circle"},{src:"assets/image/customBrush/b9.png",style:"circle"},{src:"assets/image/customBrush/b10.png",style:"circle"},
{src:"assets/image/customBrush/b11.png",style:"circle"},{src:"assets/image/customBrush/b12.png",style:"circle"}];Painter.FilterWin=function(){function a(a){var b=g.get(0).getContext("2d"),c=g.get(0).width,d=g.get(0).height;b.clearRect(0,0,c,d);b.drawImage(e.get(0),0,0);a!=void 0&&(c=b.getImageData(0,0,c,d),a.effectTo(c),b.putImageData(c,0,0))}var b=$("#filterWin"),c=b.find(".ui.dropdown"),d=b.find(".ui.form"),f=b.find(".actions button").eq(0),e=b.find("img").eq(0),g,j=0;e.get(0).onload=function(){g=$("<canvas>");g.attr("width",e.get(0).width);g.attr("height",e.get(0).height);g.insertAfter(e);g.get(0).getContext("2d").drawImage(e.get(0),
0,0);e.hide()};var h=[{label:"None",filter:void 0},{label:"Blur",filter:new Painter.filter.Blur},{label:"Brightness",filter:new Painter.filter.Brightness},{label:"Bump",filter:new Painter.filter.Bump},{label:"Circle Smear",filter:new Painter.filter.CircleSmear},{label:"Contrast",filter:new Painter.filter.Contrast},{label:"Cross Smear",filter:new Painter.filter.CrossSmear},{label:"Diffusion",filter:new Painter.filter.Diffusion},{label:"Dither",filter:new Painter.filter.Dither},{label:"Edge Detection",
filter:new Painter.filter.EdgeDetection},{label:"Emboss",filter:new Painter.filter.Emboss},{label:"Exposure",filter:new Painter.filter.Exposure},{label:"Gain/Bias",filter:new Painter.filter.Gain},{label:"Gamma",filter:new Painter.filter.Gamma},{label:"Grayscale",filter:new Painter.filter.Grayscale},{label:"Hue",filter:new Painter.filter.Hue},{label:"Invert",filter:new Painter.filter.Invert},{label:"Kaleidoscope",filter:new Painter.filter.Kaleidoscope},{label:"Lens Distortion",filter:new Painter.filter.LensDistortion},
{label:"Line Smear",filter:new Painter.filter.LineSmear},{label:"Maximum",filter:new Painter.filter.Maximum},{label:"Median",filter:new Painter.filter.Median},{label:"Minimum",filter:new Painter.filter.Minimum},{label:"Noise",filter:new Painter.filter.Noise},{label:"OilPainting",filter:new Painter.filter.OilPainting},{label:"Opacity",filter:new Painter.filter.Opacity},{label:"Pinch/Whirl",filter:new Painter.filter.Pinch},{label:"Pixelation",filter:new Painter.filter.Pixelation},{label:"Posterize",
filter:new Painter.filter.Posterize},{label:"RGBAdjust",filter:new Painter.filter.RGBAdjust},{label:"Saturation",filter:new Painter.filter.Saturation},{label:"Sawtooth Ripples",filter:new Painter.filter.SawtoothRipples},{label:"Sepia",filter:new Painter.filter.Sepia},{label:"Sharpen",filter:new Painter.filter.Sharpen},{label:"Sine Ripples",filter:new Painter.filter.SineRipples},{label:"Solarize",filter:new Painter.filter.Solarize},{label:"Sparkle",filter:new Painter.filter.Sparkle},{label:"Square Smear",
filter:new Painter.filter.SquareSmear},{label:"Black & White",filter:new Painter.filter.BlackWhite},{label:"Triangle Ripples",filter:new Painter.filter.TriangleRipples},{label:"Twirl",filter:new Painter.filter.Twirl},{label:"Vignette",filter:new Painter.filter.Vignette},{label:"Water Ripples",filter:new Painter.filter.WaterRipples}];$.each(h,function(b){$('<option value="'+b+'">'+this.label+"</option>").appendTo(c);if(this.filter!=void 0)this.filter.onChange=function(){a(this)}});f.click(function(){f.addClass("disabled");
b.modal("hide");var a=h[j].filter;a!=void 0&&Painter.editor.getEditorCanvas().applyFilterToSelectedLayer(a.getConfig())});c.dropdown({onChange:function(b){b=parseInt(b);d.empty();j=b;b=h[b].filter;b!=void 0&&b.descriptor.init(d);a(b)}});this.show=function(){b.modal("show");f.removeClass("disabled")}};Painter.filter={};
Painter.filter.BasicFilter=function(){var a=this;this.descriptor=new function(){function b(b,d){var f=b.name,e=b.label,g=b.min,j=b.max,h=b.value;switch(b.type){case "slider":e=Painter.FormViewManager.createSliderView(e);e.appendTo(d);a.initOption();(new Painter.Slider(e,g,j,h)).onChange=function(b){a.option[f]=Number(b);a.onChange()};break;case "checkbox":g=Painter.FormViewManager.createCheckBoxView(e);g.appendTo(d);a.initOption();var k=g.find(".ui.checkbox").eq(0);k.checkbox(h?"set checked":"set unchecked");
k.checkbox({onChange:function(){var b=k.checkbox("is checked");a.option[f]=b;a.onChange()}})}}this.init=function(c){for(var d=a.getControlSettings(),f=d.length,e=0;e<f;e++)new b(d[e],c)}};this.name="basic";this.option={};this.getControlSettings=function(){return[{type:"slider",name:"amount",label:"Amount",min:0,max:100,value:0}]};this.effectTo=function(a){JSManipulate[this.name].filter(a,this.option)};this.initOption=function(){var b=this.getControlSettings();$.each(b,function(){a.option[this.name]=
this.value})};this.getConfig=function(){return{name:a.name,option:function(){var b={},c;for(c in a.option)b[c]=a.option[c];return b}()}}};Painter.filter.Blur=function(){Painter.filter.BasicFilter.call(this);this.name="blur";this.getControlSettings=function(){return[{type:"slider",name:"amount",label:"Amount",min:0,max:10,value:3}]}};Painter.filter.Brightness=function(){Painter.filter.BasicFilter.call(this);this.name="brightness";this.getControlSettings=function(){return[{type:"slider",name:"amount",label:"Amount",min:-1,max:1,value:0}]}};Painter.filter.Bump=function(){Painter.filter.BasicFilter.call(this);this.name="bump";this.getControlSettings=function(){return[]}};Painter.filter.CircleSmear=function(){Painter.filter.BasicFilter.call(this);this.name="circlesmear";this.getControlSettings=function(){return[{type:"slider",name:"size",label:"Size",min:1,max:10,value:4},{type:"slider",name:"density",label:"Density",min:0,max:1,value:0.5},{type:"slider",name:"mix",label:"Mix",min:0,max:1,value:0.5}]}};Painter.filter.Contrast=function(){Painter.filter.BasicFilter.call(this);this.name="contrast";this.getControlSettings=function(){return[{type:"slider",name:"amount",label:"Amount",min:0,max:2,value:1}]}};Painter.filter.CrossSmear=function(){Painter.filter.BasicFilter.call(this);this.name="crosssmear";this.getControlSettings=function(){return[{type:"slider",name:"distance",label:"Distance",min:0,max:30,value:8},{type:"slider",name:"density",label:"Density",min:0,max:1,value:0.5},{type:"slider",name:"mix",label:"Mix",min:0,max:1,value:0.5}]}};Painter.filter.Diffusion=function(){Painter.filter.BasicFilter.call(this);this.name="diffusion";this.getControlSettings=function(){return[{type:"slider",name:"scale",label:"Scale",min:1,max:100,value:4}]}};Painter.filter.Dither=function(){Painter.filter.BasicFilter.call(this);this.name="dither";this.getControlSettings=function(){return[{type:"slider",name:"levels",label:"Levels",min:2,max:30,value:3},{type:"checkbox",name:"color",label:"Color",value:!0}]}};Painter.filter.EdgeDetection=function(){Painter.filter.BasicFilter.call(this);this.name="edge";this.getControlSettings=function(){return[]}};Painter.filter.Emboss=function(){Painter.filter.BasicFilter.call(this);this.name="emboss";this.getControlSettings=function(){return[{type:"slider",name:"height",label:"Height",min:1,max:10,value:1},{type:"slider",name:"angle",label:"Angle",min:0,max:360,value:135},{type:"slider",name:"elevation",label:"Elevation",min:0,max:180,value:30}]}};Painter.filter.Exposure=function(){Painter.filter.BasicFilter.call(this);this.name="exposure";this.getControlSettings=function(){return[{type:"slider",name:"exposure",label:"Exposure",min:0,max:5,value:1}]}};Painter.filter.Gain=function(){Painter.filter.BasicFilter.call(this);this.name="gain";this.getControlSettings=function(){return[{type:"slider",name:"gain",label:"Gain",min:0,max:1,value:0.5},{type:"slider",name:"bias",label:"Bias",min:0,max:1,value:0.5}]}};Painter.filter.Gamma=function(){Painter.filter.BasicFilter.call(this);this.name="gamma";this.getControlSettings=function(){return[{type:"slider",name:"amount",label:"Amount",min:0,max:2,value:1}]}};Painter.filter.Grayscale=function(){Painter.filter.BasicFilter.call(this);this.name="grayscale";this.getControlSettings=function(){return[]}};Painter.filter.Hue=function(){Painter.filter.BasicFilter.call(this);this.name="hue";this.getControlSettings=function(){return[{type:"slider",name:"amount",label:"Amount",min:-1,max:1,value:0}]}};Painter.filter.Invert=function(){Painter.filter.BasicFilter.call(this);this.name="invert";this.getControlSettings=function(){return[]}};Painter.filter.Kaleidoscope=function(){Painter.filter.BasicFilter.call(this);this.name="kaleidoscope";this.getControlSettings=function(){return[{type:"slider",name:"angle",label:"Angle",min:0,max:360,value:0},{type:"slider",name:"rotation",label:"Rotation",min:0,max:360,value:0},{type:"slider",name:"centerX",label:"CenterX",min:0,max:1,value:0.5},{type:"slider",name:"centerY",label:"centerY",min:0,max:1,value:0.5}]}};Painter.filter.LensDistortion=function(){Painter.filter.BasicFilter.call(this);this.name="lensdistortion";this.getControlSettings=function(){return[{type:"slider",name:"refraction",label:"Refraction",min:1,max:10,value:1.5},{type:"slider",name:"radius",label:"Radius",min:1,max:200,value:50},{type:"slider",name:"centerX",label:"CenterX",min:0,max:1,value:0.5},{type:"slider",name:"centerY",label:"centerY",min:0,max:1,value:0.5}]}};Painter.filter.LineSmear=function(){Painter.filter.BasicFilter.call(this);this.name="linesmear";this.getControlSettings=function(){return[{type:"slider",name:"distance",label:"Distance",min:1,max:30,value:8},{type:"slider",name:"density",label:"Density",min:0,max:1,value:0.5},{type:"slider",name:"angle",label:"Angle",min:0,max:360,value:0},{type:"slider",name:"mix",label:"Mix",min:0,max:1,value:0.5}]}};Painter.filter.Maximum=function(){Painter.filter.BasicFilter.call(this);this.name="maximum";this.getControlSettings=function(){return[]}};Painter.filter.Median=function(){Painter.filter.BasicFilter.call(this);this.name="median";this.getControlSettings=function(){return[]}};Painter.filter.Minimum=function(){Painter.filter.BasicFilter.call(this);this.name="minimum";this.getControlSettings=function(){return[]}};Painter.filter.Noise=function(){Painter.filter.BasicFilter.call(this);this.name="noise";this.getControlSettings=function(){return[{type:"slider",name:"amount",label:"Amount",min:0,max:100,value:25},{type:"slider",name:"density",label:"Density",min:0,max:1,value:1},{type:"checkbox",name:"monochrome",label:"Monochrome",value:!0}]}};Painter.filter.OilPainting=function(){Painter.filter.BasicFilter.call(this);this.name="oil";this.getControlSettings=function(){return[{type:"slider",name:"range",label:"Range",min:0,max:5,value:3}]}};Painter.filter.Opacity=function(){Painter.filter.BasicFilter.call(this);this.name="opacity";this.getControlSettings=function(){return[{type:"slider",name:"amount",label:"Amount",min:0,max:1,value:1}]}};Painter.filter.Pinch=function(){Painter.filter.BasicFilter.call(this);this.name="pinch";this.getControlSettings=function(){return[{type:"slider",name:"amount",label:"Amount",min:-1,max:1,value:0.5},{type:"slider",name:"radius",label:"Radius",min:1,max:200,value:100},{type:"slider",name:"angle",label:"Angle",min:0,max:360,value:0},{type:"slider",name:"centerX",label:"CenterX",min:0,max:1,value:0.5},{type:"slider",name:"centerY",label:"CenterY",min:0,max:1,value:0.5}]}};Painter.filter.Pixelation=function(){Painter.filter.BasicFilter.call(this);this.name="pixelate";this.getControlSettings=function(){return[{type:"slider",name:"size",label:"Size",min:1,max:50,value:5}]}};Painter.filter.Posterize=function(){Painter.filter.BasicFilter.call(this);this.name="posterize";this.getControlSettings=function(){return[{type:"slider",name:"levels",label:"Levels",min:2,max:30,value:6}]}};Painter.filter.RGBAdjust=function(){Painter.filter.BasicFilter.call(this);this.name="rgbadjust";this.getControlSettings=function(){return[{type:"slider",name:"red",label:"Red",min:0,max:2,value:1},{type:"slider",name:"green",label:"Green",min:0,max:2,value:1},{type:"slider",name:"blue",label:"Blue",min:0,max:2,value:1}]}};Painter.filter.Saturation=function(){Painter.filter.BasicFilter.call(this);this.name="saturation";this.getControlSettings=function(){return[{type:"slider",name:"amount",label:"Amount",min:0,max:2,value:1}]}};Painter.filter.SawtoothRipples=function(){Painter.filter.BasicFilter.call(this);this.name="sawtoothripple";this.getControlSettings=function(){return[{type:"slider",name:"xAmplitude",label:"xAmplitude",min:0,max:30,value:5},{type:"slider",name:"yAmplitude",label:"yAmplitude",min:0,max:30,value:5},{type:"slider",name:"xWavelength",label:"xWavelength",min:1,max:50,value:16},{type:"slider",name:"yWavelength",label:"yWavelength",min:1,max:50,value:16}]}};Painter.filter.Sepia=function(){Painter.filter.BasicFilter.call(this);this.name="sepia";this.getControlSettings=function(){return[{type:"slider",name:"amount",label:"Amount",min:0,max:30,value:10}]}};Painter.filter.Sharpen=function(){Painter.filter.BasicFilter.call(this);this.name="sharpen";this.getControlSettings=function(){return[]}};Painter.filter.SineRipples=function(){Painter.filter.BasicFilter.call(this);this.name="sineripple";this.getControlSettings=function(){return[{type:"slider",name:"xAmplitude",label:"xAmplitude",min:0,max:30,value:5},{type:"slider",name:"yAmplitude",label:"yAmplitude",min:0,max:30,value:5},{type:"slider",name:"xWavelength",label:"xWavelength",min:1,max:50,value:16},{type:"slider",name:"yWavelength",label:"yWavelength",min:1,max:50,value:16}]}};Painter.filter.Solarize=function(){Painter.filter.BasicFilter.call(this);this.name="solarize";this.getControlSettings=function(){return[]}};Painter.filter.Sparkle=function(){Painter.filter.BasicFilter.call(this);this.name="sparkle";this.getControlSettings=function(){return[{type:"slider",name:"rays",label:"Rays",min:1,max:200,value:50},{type:"slider",name:"size",label:"Size",min:1,max:200,value:25},{type:"slider",name:"amount",label:"Amount",min:0,max:100,value:50},{type:"slider",name:"randomness",label:"Randomness",min:0,max:50,value:25},{type:"slider",name:"centerX",label:"CenterX",min:0,max:1,value:0.5},{type:"slider",name:"centerY",
label:"CenterY",min:0,max:1,value:0.5}]}};Painter.filter.SquareSmear=function(){Painter.filter.BasicFilter.call(this);this.name="squaresmear";this.getControlSettings=function(){return[{type:"slider",name:"size",label:"Size",min:1,max:10,value:4},{type:"slider",name:"density",label:"Density",min:0,max:1,value:0.5},{type:"slider",name:"mix",label:"Mix",min:0,max:1,value:0.5}]}};Painter.filter.BlackWhite=function(){Painter.filter.BasicFilter.call(this);this.name="threshold";this.getControlSettings=function(){return[{type:"slider",name:"threshold",label:"Threshold",min:0,max:255,value:127}]}};Painter.filter.TriangleRipples=function(){Painter.filter.BasicFilter.call(this);this.name="triangleripple";this.getControlSettings=function(){return[{type:"slider",name:"xAmplitude",label:"xAmplitude",min:0,max:30,value:5},{type:"slider",name:"yAmplitude",label:"yAmplitude",min:0,max:30,value:5},{type:"slider",name:"xWavelength",label:"xWavelength",min:1,max:50,value:16},{type:"slider",name:"yWavelength",label:"yWavelength",min:1,max:50,value:16}]}};Painter.filter.Twirl=function(){Painter.filter.BasicFilter.call(this);this.name="twirl";this.getControlSettings=function(){return[{type:"slider",name:"radius",label:"Radius",min:1,max:200,value:100},{type:"slider",name:"angle",label:"Angle",min:0,max:360,value:180},{type:"slider",name:"centerX",label:"CenterX",min:0,max:1,value:0.5},{type:"slider",name:"centerY",label:"CenterY",min:0,max:1,value:0.5}]}};Painter.filter.Vignette=function(){Painter.filter.BasicFilter.call(this);this.name="vignette";this.getControlSettings=function(){return[{type:"slider",name:"amount",label:"Amount",min:0,max:1,value:0.3}]}};Painter.filter.WaterRipples=function(){Painter.filter.BasicFilter.call(this);this.name="waterripple";this.getControlSettings=function(){return[{type:"slider",name:"phase",label:"Phase",min:0,max:100,value:0},{type:"slider",name:"radius",label:"Radius",min:1,max:200,value:50},{type:"slider",name:"wavelength",label:"Wavelength",min:1,max:100,value:16},{type:"slider",name:"amplitude",label:"Amplitude",min:1,max:100,value:10},{type:"slider",name:"centerX",label:"CenterX",min:0,max:1,value:0.5},{type:"slider",
name:"centerY",label:"CenterY",min:0,max:1,value:0.5}]}};Painter.Recorder=function(){var a={},b=[];a.addAction=function(a){b.push(a)};a.removeAction=function(a){a=b.indexOf(a);b.splice(a,1)};a.removeAll=function(){b=[]};a.getActions=function(){return b};return a}();Painter.Recorder.Type={newLayer:0,removeLayer:1,moveLayer:2,setLayerAlpha:3,setLayerVisible:4,drawLayer:5};
Painter.Recorder.Action=function(a,b){this.type=a;switch(a){case Painter.Recorder.Type.newLayer:if(b!=void 0)this.toIdx=b;break;case Painter.Recorder.Type.removeLayer:this.layerIdx=b;break;case Painter.Recorder.Type.moveLayer:this.layerIdx=b.layerIdx;this.direction=b.direction;break;case Painter.Recorder.Type.setLayerAlpha:this.layerIdx=b.layerIdx;this.alpha=b.alpha;break;case Painter.Recorder.Type.setLayerVisible:this.layerIdx=b.layerIdx;this.visible=b.visible;break;case Painter.Recorder.Type.drawLayer:this.layerIdx=
b.layerIdx,this.action=b.action}this.getJsonObj=function(){var a={};a.type=this.type;if(this.layerIdx!=void 0)a.layerIdx=this.layerIdx;switch(this.type){case Painter.Recorder.Type.newLayer:if(this.toIdx!=void 0)a.toIdx=this.toIdx;break;case Painter.Recorder.Type.moveLayer:a.direction=this.direction;break;case Painter.Recorder.Type.setLayerAlpha:a.alpha=this.alpha;break;case Painter.Recorder.Type.setLayerVisible:a.visible=this.visible;break;case Painter.Recorder.Type.drawLayer:a.action=this.action.getJsonObj()}return a}};Painter.SettingWin=function(a){function b(a,b){this.setDisplay=function(c){a.css("display",c?"block":"none");b.css("display",c?"block":"none")}}var c=this;this.view=$(a);var d=this.view.find(".ui.menu .item"),a=this.view.find(".content").eq(0).children(),f=this.view.find(".actions").eq(0).children(),e=[new function(a,c){b.call(this,a,c);var d=this,e=a.find("input").eq(0),f=c.find("button").eq(0);this.getMaxHistory=function(){return Painter.HistoryManager.maxLen};this.setMaxHistory=function(a){Painter.HistoryManager.maxLen=
a};this.initValues=function(){e.val(this.getMaxHistory())};this.initValues();f.click(function(){d.setMaxHistory(e.val())})}(a.eq(0),f.eq(0)),new function(a,c){b.call(this,a,c);var d='<table class="ui celled table">';d+=" <thead><tr>";d+="  <th>\u5feb\u6377\u952e</th>";d+="  <th>\u8bf4\u660e</th>";d+=" </tr></thead>";d+=" <tbody>";Painter.topMenu.getItems().each(function(){if($(this).find(".item").length==0){var a=$(this).find("span.text").text(),b=$(this).find("span.description").text();b!=""&&(d+=
"<tr><td>"+b+"</td><td>"+a+"</td></tr>")}});d+=" </tbody>";d+="</table>";$(d).appendTo(a)}(a.eq(1),f.eq(1)),new function(a,c){b.call(this,a,c);var d=this,e=$("<audio>",{src:"assets/sounds/m01.m4a",loop:!0}),f=a.find(".icon.music");f.addClass("red");f.click(function(){f.toggleClass("red");f.hasClass("red")?d.playMusic():d.stopMusic()});var g=this.setDisplay;this.setDisplay=function(a){g.call(this,a);a?this.playMusic():this.stopMusic()};this.playMusic=function(){f.hasClass("red")&&e.get(0).play()};
this.stopMusic=function(){e.get(0).pause();e.get(0).currentTime=0};var l='<div style="color:#666666;text-align: center;">'+Base64.decode("Qmxhbms=")+"</div>";l+='<div style="color:#666666;text-align: center;">'+Base64.decode("aGVyb2JsYW5rQGdtYWlsLmNvbQ==")+"</div>";$(l).appendTo(a)}(a.eq(2),f.eq(2))],g=-1;d.each(function(a){$(this).click(function(){c.selectTabIdx(a)})});this.view.modal({onHide:function(){e[2].stopMusic()}});this.show=function(a){e[0].initValues();this.selectTabIdx(a);this.view.modal("show")};
this.selectTabIdx=function(a){g>-1&&(d.eq(g).removeClass("active blue"),e[g].setDisplay(!1));d.eq(a).addClass("active blue");g=a;e[a].setDisplay(!0);this.view.modal("refresh")}};Painter.File={openFile:function(){var a=this;this.browser(function(b){b.name.split(".").indexOf("paint")!==1?Painter.Alert.show("\u6587\u4ef6\u683c\u5f0f\u4e0d\u5bf9!"):a.readText(b,function(a){Painter.editor.getEditorCanvas().open(a)})})},openPaintPathFile:function(){var a=this;this.browser(function(b){b.name.split(".").indexOf("process")!==1?Painter.Alert.show("\u6587\u4ef6\u683c\u5f0f\u4e0d\u5bf9!"):a.readText(b,function(a){Painter.PathPlayer.open(a)})})},saveFile:function(){var a=this;Painter.inputWin.show({icon:"save icon",
title:"\u4fdd\u5b58\u6587\u4ef6",placeholder:"\u8f93\u5165\u6587\u4ef6\u540d\u79f0",rightlabel:".paint",value:"paint-"+(new Date).getTime(),submitLabel:"\u4fdd\u5b58",onSubmit:function(b){for(var c=Painter.editor.getEditorCanvas(),d={width:c.view.outerWidth(),height:c.view.outerHeight(),layers:[]},c=c.getLayers(),f=0;f<c.length;){var e=c[f],g=e.getCanvas(),e={name:e.getName(),alpha:e.getAlpha(),visible:e.getVisible(),data:g.get(0).toDataURL("png")};d.layers.push(e);f++}d=JSON.stringify(d);a.saveText(d,
b+".paint")}})},getPaintPathString:function(){for(var a=Painter.editor.getEditorCanvas(),a={width:a.view.outerWidth(),height:a.view.outerHeight(),actions:[]},b=Painter.Recorder.getActions(),c=0;c<b.length;){var d=b[c].getJsonObj();a.actions.push(d);c++}return JSON.stringify(a)},savePaintPathFile:function(){var a=this;Painter.inputWin.show({icon:"save icon",title:"\u4fdd\u5b58\u7ed8\u753b\u8fc7\u7a0b",placeholder:"\u8f93\u5165\u6587\u4ef6\u540d\u79f0",rightlabel:".process",value:"paint-process-"+(new Date).getTime(),
submitLabel:"\u4fdd\u5b58",onSubmit:function(b){var c=a.getPaintPathString();a.saveText(c,b+".process")}})},exportImage:function(){var a=this;Painter.inputWin.show({icon:"file image outline icon",title:"\u5bfc\u51fa\u56fe\u7247",placeholder:"\u8f93\u5165\u56fe\u7247\u540d\u79f0",rightlabel:".png",value:"export-"+(new Date).getTime(),submitLabel:"\u5bfc\u51fa",onSubmit:function(b){var c=Painter.editor.getEditorCanvas(),d=$("<canvas>"),f=c.view.outerWidth(),e=c.view.outerHeight();d.attr("width",f);
d.attr("height",e);f=d.get(0).getContext("2d");f.clearRect(0,0,d.get(0).width,d.get(0).height);for(e=0;e<c.getLayers().length;){var g=c.getLayers()[e];if(g.getVisible()){var j=g.getCanvas().get(0);f.save();f.globalAlpha=g.getAlpha();f.drawImage(j,0,0,j.width,j.height,0,0,d.get(0).width,d.get(0).height);f.restore()}e++}c=d.get(0).toDataURL("png");c=c.replace("image/png","image/octet-stream");a.saveData(c,b+".png")}})},saveData:function(a,b){var c=$("<a>");c.attr("href",a);c.attr("download",b);c.get(0).click()},
saveText:function(a,b){this.saveData("data:application/octet-stream;base64,"+Base64.encode(a),b)},browser:function(a){var b=$("<input type='file'>");b.trigger("click");b.change(function(){var c=b.get(0).files[0];a(c)})},readText:function(a,b){$("#loadingMask").dimmer({closable:!1});$("#loadingMask").find(".ui.text.loader").text("\u6587\u4ef6\u8bfb\u53d6\u4e2d...");$("#loadingMask").dimmer("show");var c=new FileReader;c.onload=function(){$("#loadingMask").dimmer("hide");b(c.result)};c.readAsText(a)}};Painter.PathPlayer=function(){function a(){function a(){if(l!=void 0){e.outerWidth($(window).width());e.outerHeight($(window).height()-g.outerHeight());$(k).width($(window).width()-140);var b=l.width,c=l.height;h.initSize(b,c);var d=b+1E3,f=c+1E3,d=d>e.outerWidth()?d:e.outerWidth(),f=f>e.outerHeight()?f:e.outerHeight();j.outerWidth(d);j.outerHeight(f);c=(f-c)*0.5;h.view.css("left",(d-b)*0.5);h.view.css("top",c)}}f!=void 0?i.removeClass("disabled"):(f=$("#pathPlayerView"),e=f.find("#container"),g=
f.find(".ui.menu"),j=$("<div style='position:absolute;'></div>"),j.appendTo(e),h=new c,h.view.appendTo(j),k=f.find(".ui.slider").get(0),noUiSlider.create(k,{start:[0],connect:"lower",animate:!1,range:{min:[0],max:[1]}}),i=g.find(".item").eq(0),m=g.find(".item").eq(1),i.click(function(){d.stop();i.addClass("disabled");f.dimmer("hide")}),m.click(function(){d.isPlaying?d.pause():d.play()}),k.noUiSlider.on("start",function(){d.pause()}),k.noUiSlider.on("end",function(){var a=k.noUiSlider.get();d.seek(a)}),
k.noUiSlider.on("change",function(){d.pause();var a=k.noUiSlider.get();d.seek(a)}),$(window).resize(a));a();e.scrollTop((j.outerHeight()-e.outerHeight())*0.5);e.scrollLeft((j.outerWidth()-e.outerWidth())*0.5)}function b(a,b,c){this.action=a;this.idx=b;this.len=c}function c(){this.view=$("<div style='position:absolute;'></div>");this.view.css("background-image","url(assets/image/alphaBg.png)");var a=$("<div style='position:absolute;'></div>");a.appendTo(this.view);this.bufferCanvas=$("<canvas>",{style:"position:absolute;"});
var b=[];this.initSize=function(a,b){this.view.outerWidth(a);this.view.outerHeight(b);this.bufferCanvas.attr("width",a);this.bufferCanvas.attr("height",b)};this.newLayer=function(c){var d=new Painter.Layer(this);c==void 0||c!=void 0&&c>b.length-1?(d.getCanvas().appendTo(a),b.push(d)):(d.getCanvas().insertBefore(b[c].getCanvas()),b.splice(c,0,d))};this.removeLayer=function(a){var c=b[a];b.splice(a,1);c.getCanvas().remove()};this.moveLayer=function(c,d){function e(){var a=c,d=a+1;d<b.length&&(h.getCanvas().insertAfter(b[d].getCanvas()),
b.splice(a,1),b.splice(d,0,h))}function f(){var a=c,d=a-1;d>-1&&(h.getCanvas().insertBefore(b[d].getCanvas()),b.splice(a,1),b.splice(d,0,h))}function g(){var d=c;d!=b.length-1&&(h.getCanvas().appendTo(a),b.splice(d,1),b.push(h))}function j(){var d=c;d>0&&(h.getCanvas().prependTo(a),b.splice(d,1),b.unshift(h))}var h=b[c];switch(d){case "up":e();break;case "down":f();break;case "top":g();break;case "bottom":j()}};this.setLayerAlpha=function(a,c){b[a].setAlpha(c)};this.setLayerVisible=function(a,c){b[a].setVisible(c)};
this.setLayerData=function(a,c){var d=new Painter.LayerAction(Painter.LayerActionType.SetData,c);b[a].addAction(d)};this.setLayerBackgroundColor=function(a,c){var d=new Painter.LayerAction(Painter.LayerActionType.SetBackgroundColor,c);b[a].addAction(d)};this.setLayerFloodFill=function(a,c){var d=new Painter.LayerAction(Painter.LayerActionType.FloodFill,c);b[a].addAction(d)};this.setLayerApplyFilter=function(a,c){var d=new Painter.LayerAction(Painter.LayerActionType.ApplyFilter,c);b[a].addAction(d)};
this.paintLayerShapeByStep=function(a){var c=a.idx,d=a.len,e=b[a.action.layerIdx],a=a.action.action.shape,f=a.brushIdx,g=Painter.toolPanel.getBrush().items[f],f=Painter.toolPanel.getBrush().settingsItems[f].clone();f.applySettingsFromObj(a.brushSettings);g.useSettings(f);g.setDrawCanvasAndBufferCanvas(e.getCanvas().get(0),this.bufferCanvas.get(0));c==0?(this.bufferCanvas.insertAfter(e.getCanvas()),c=a.mousedownPoint,g.mousedown(c)):c==d-1?(c=a.mouseupPoint,g.mouseup(c),this.bufferCanvas.remove(),
c=new Painter.Shape({brush:g,brushSettings:f,mousedownPoint:a.mousedownPoint,mousemovePoints:a.mousemovePoints,mouseupPoint:a.mouseupPoint}),c=new Painter.LayerAction(Painter.LayerActionType.AddShape,c),e.addAction(c)):(c=a.mousemovePoints[c-1],g.mousemove(c))};this.clear=function(){for(;b.length>0;)this.removeLayer(0);this.bufferCanvas.remove()}}var d={},f,e,g,j,h,k,i,m,n,l,o=0,p,q=-1,s;d.isPlaying=!1;d.isPlayComplete=!1;d.play=function(){var a=m.find("i");a.removeClass("play");a.addClass("pause");
this.isPlaying=!0;if(this.isPlayComplete)h.clear(),this.isPlayComplete=!1,o=0,q=-1;this.enterFrame()};d.pause=function(){var a=m.find("i");a.addClass("play");a.removeClass("pause");this.isPlaying=!1;window.cancelAnimationFrame(n)};d.stop=function(){this.pause();k.noUiSlider.set(0);h.clear();this.isPlayComplete=!1;o=0;q=-1;s=p=l=void 0};d.seek=function(a){o=Number(a);d.isPlayComplete=o==1;this.paint()};d.enterFrame=function(){o=o>1?1:o;k.noUiSlider.set(o);d.paint();o==1?(d.pause(),d.isPlayComplete=
!0):(o+=1/p.length,n=window.requestAnimationFrame(arguments.callee))};d.playCurrent=function(){this.open(Painter.File.getPaintPathString())};d.open=function(a){l=JSON.parse(a);p=this.getSteps();this.show();var b=f.find(".ui.dimmer");b.dimmer({closable:!1});b.dimmer("show");(function(a){function b(a,c){var d=new Image;d.onload=function(){var b=s,d=a[0],e;f.width=this.width;f.height=this.height;e=f.getContext("2d");e.drawImage(this,0,0,this.width,this.height,0,0,f.width,f.height);e=e.getImageData(0,
0,f.width,f.height);b[d]=e;c()};d.src=a[1]}var c=[],d=l.actions,e=0,f=$("<canvas>").get(0);for(s=[];e<d.length;){var g=d[e];if(g.type==Painter.Recorder.Type.drawLayer)if(g.action.type==Painter.LayerActionType.AddShape){var g=g.action.shape,h;if(g.brushSettings.material!=void 0&&g.brushSettings.material!="")h=g.brushSettings.material;else if(g.brushSettings.shape!=void 0)h=g.brushSettings.shape.src;h!=void 0&&c.indexOf(h)==-1&&c.push([e,h])}else g.action.type==Painter.LayerActionType.SetData&&c.push([e,
g.action.data]);e++}c.length==0?a():(e=0,b(c[e],function(){e++;e==c.length?a():b(c[e],arguments.callee)}))})(function(){b.dimmer("hide");m.trigger("click")})};d.show=function(){$("#pathPlayerView").dimmer({closable:!1});$("#pathPlayerView").dimmer("show");a()};d.getSteps=function(){for(var a=[],c=l.actions,d=0;d<c.length;){var e=c[d];if(e.type==Painter.Recorder.Type.drawLayer){var f=e.action;if(f.type==Painter.LayerActionType.AddShape)for(var f=f.shape.mousemovePoints.length+2,g=0;g<f;)a.push(new b(e,
g,f)),g++;else a.push(new b(e,0,1))}else a.push(new b(e,0,1));d++}return a};d.paint=function(){var a=Math.round(o*(p.length-1));if(q!=a){if(a>q)for(var b=q;a-b!=0;)b++,this.addStep(b);else this.startStepTo(a);q=a}};d.addStep=function(a){a=p[a];if(a.len==1)switch(a.action.type){case Painter.Recorder.Type.newLayer:h.newLayer(a.action.toIdx);break;case Painter.Recorder.Type.removeLayer:h.removeLayer(a.action.layerIdx);break;case Painter.Recorder.Type.moveLayer:h.moveLayer(a.action.layerIdx,a.action.direction);
break;case Painter.Recorder.Type.setLayerAlpha:h.setLayerAlpha(a.action.layerIdx,a.action.alpha);break;case Painter.Recorder.Type.setLayerVisible:h.setLayerVisible(a.action.layerIdx,a.action.visible);break;case Painter.Recorder.Type.drawLayer:switch(a.action.action.type){case Painter.LayerActionType.SetBackgroundColor:h.setLayerBackgroundColor(a.action.layerIdx,a.action.action.backgroundColor);break;case Painter.LayerActionType.FloodFill:h.setLayerFloodFill(a.action.layerIdx,a.action.action.floodFill);
break;case Painter.LayerActionType.ApplyFilter:h.setLayerApplyFilter(a.action.layerIdx,a.action.action.filter);break;case Painter.LayerActionType.SetData:var b=s[l.actions.indexOf(a.action)];h.setLayerData(a.action.layerIdx,b)}}else h.paintLayerShapeByStep(a)};d.startStepTo=function(a){h.clear();for(var b=-1;a-b!=0;)b++,this.addStep(b)};return d}();Painter.InputWin=function(a){var b=$(a),c=b.find(".header i").eq(0),d=b.find(".header label").eq(0),f=b.find("input").eq(0),e=b.find(".right.labeled .label").eq(0),g=b.find(".actions button").eq(0),j;g.click(function(){g.addClass("disabled");b.modal("hide");j!=void 0&&j(f.val())});this.setOption=function(a){c.attr("class",a.icon);d.text(a.title);f.attr("placeholder",a.placeholder);e.text(a.rightlabel);g.text(a.submitLabel);f.val(a.value);j=a.onSubmit};this.show=function(a){this.setOption(a);g.removeClass("disabled");
b.modal("show")}};Painter.Alert=function(){var a={},b=$("<div class='ui small modal'>");$("<div class='header'><i class='warning circle icon'></i><label>\u63d0\u793a</label></div>").appendTo(b);var c=$("<div class='content'>");c.appendTo(b);$("<div class='actions'>").appendTo(b);a.show=function(a){c.text(a);b.modal("show")};return a}();Painter.EditCanvasSizeWin=function(a){function b(){var a=Painter.editor.getEditorCanvas();return{width:a.view.outerWidth(),height:a.view.outerHeight()}}var c=$(a),d=c.find(".content p span").eq(0),f=c.find("input").eq(0),e=c.find("input").eq(1),g=c.find(".actions button").eq(0);g.click(function(){var a=b();(a.width!=f.val()||a.height!=e.val())&&Painter.editor.getEditorCanvas().setSize(f.val(),e.val());g.addClass("disabled");c.modal("hide")});this.show=function(){var a=b();d.text(a.width+" * "+a.height);
f.val(a.width);e.val(a.height);g.removeClass("disabled");c.modal("show")}};Painter.OnlineFileWin=function(a){function b(a){var b;b='<div class="ui image" style="border: solid 1px #E3E3E3;float: left;margin-left: 10px;margin-top: 10px;width:240px;height:180px;">';b+='<div class="ui dimmer">';b+='<div class="content">';b+='<div class="center">';b+='<h2 class="ui inverted header">'+a+"</h2>";b+='<div class="ui button">\u6587\u4ef6</div>';b+='<div class="ui button">\u7ed8\u753b\u8fc7\u7a0b</div>';b+="</div>";b+="</div>";b+="</div>";b+='<img class="ui image" src="'+("paints/"+
a+"/"+a+".png")+'">';b+="</div>";this.view=$(b);this.view.dimmer({on:"hover"});var d=this.view.find(".ui.dimmer .ui.button").eq(0),e=this.view.find(".ui.dimmer .ui.button").eq(1);d.click(function(){c.openPaint(a);d.addClass("disabled")});e.click(function(){c.openProcess(a);e.addClass("disabled")});this.reset=function(){d.removeClass("disabled");e.removeClass("disabled")}}var c=this,d=$(a),f=d.find(".content").eq(0),e=!1,g=[];this.show=function(){e?(this.reset(),d.modal("show")):($("#loadingMask").dimmer({closable:!1}),
$("#loadingMask").find(".ui.text.loader").text("\u5217\u8868\u8bfb\u53d6\u4e2d..."),$("#loadingMask").dimmer("show"),$.getJSON("paints/list.json",function(a){$("#loadingMask").dimmer("hide");for(var c=0;c<a.length;c++){var k=new b(a[c]);k.view.prependTo(f);g.push(k)}e=!0;d.modal("show")}))};this.reset=function(){for(var a=0;a<g.length;a++)g[a].reset()};this.openPaint=function(a){d.modal("hide");a="paints/"+a+"/"+a+".paint";$("#loadingMask").dimmer({closable:!1});$("#loadingMask").find(".ui.text.loader").text("\u6570\u636e\u8bfb\u53d6\u4e2d...");
$("#loadingMask").dimmer("show");$.get(a,function(a){$("#loadingMask").dimmer("hide");Painter.editor.getEditorCanvas().open(a)})};this.openProcess=function(a){d.modal("hide");a="paints/"+a+"/"+a+".process";$("#loadingMask").dimmer({closable:!1});$("#loadingMask").find(".ui.text.loader").text("\u6570\u636e\u8bfb\u53d6\u4e2d...");$("#loadingMask").dimmer("show");$.get(a,function(a){$("#loadingMask").dimmer("hide");Painter.PathPlayer.open(a)})}};
